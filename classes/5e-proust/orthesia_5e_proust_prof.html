<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Le Royaume d‚ÄôOrth√©sia ‚Äî 5e Proust</title>
<style>

/* === Effet parchemin (sans image) === */
.parchmentMap{
  position: relative;
  border-radius: 22px;
  overflow: hidden;

  /* teinte + variations */
  background:
    radial-gradient(1200px 700px at 20% 15%, rgba(255,255,255,.22), transparent 55%),
    radial-gradient(900px 600px at 80% 35%, rgba(0,0,0,.10), transparent 60%),
    linear-gradient(180deg, #f3e3bf 0%, #e7d0a1 45%, #d7b985 100%);

  /* lisibilit√© + ambiance */
  box-shadow:
    0 16px 48px rgba(0,0,0,.35),
    inset 0 0 0 1px rgba(90,60,20,.22),
    inset 0 0 60px rgba(110,70,25,.22);
}

/* grain + bords irr√©guliers + vignette */
.parchmentMap::before{
  content:"";
  position:absolute; inset:0;
  pointer-events:none;

  background:
    /* grain l√©ger */
   radial-gradient(700px 500px at 50% 35%, rgba(160,200,255,.18), transparent 70%),
radial-gradient(500px 400px at 65% 55%, rgba(180,120,255,.14), transparent 70%),

    /* vignette */
    radial-gradient(900px 600px at 50% 45%, transparent 55%, rgba(40,25,10,.30) 100%);
  mix-blend-mode: multiply;
  opacity: .9;
}

/* optionnel : ‚Äútache‚Äù douce */
.parchmentMap::after{
  content:"";
  position:absolute; inset:-20%;
  pointer-events:none;
  background:
    radial-gradient(140px 90px at 20% 35%, rgba(120,75,20,.12), transparent 70%),
    radial-gradient(180px 120px at 75% 60%, rgba(120,75,20,.10), transparent 75%),
    radial-gradient(220px 140px at 55% 20%, rgba(120,75,20,.08), transparent 75%);
  transform: rotate(-6deg);
  opacity: .9;
}

/* Correction lisibilit√© menu d√©roulant combat */
select,
select option {
  background-color: #1e2433 !important;
  color: #ffffff !important;
}

/* Option survol√©e / s√©lectionn√©e */
select option:checked,
select option:hover {
  background-color: #2f3b55 !important;
  color: #ffffff !important;
}


  :root{
    --bg:#0b1020;
    --panel:#121a33;
    --panel2:#0f1730;
    --text:#f5f5f5;
    --muted:#c9c9c9;
    --accent:#8bd3ff;
    --good:#9dffb0;
    --line:rgba(255,255,255,.12);
  }
  *{box-sizing:border-box}
body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: radial-gradient(1200px 700px at 20% 10%, #18214a 0%, var(--bg) 55%),
                radial-gradient(900px 600px at 90% 30%, #1a3b3b 0%, rgba(0,0,0,.0) 60%);
    color:var(--text);
  }
  header{
    padding:18px 18px 10px;
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    border-bottom:1px solid var(--line);
    background: linear-gradient(180deg, rgba(18,26,51,.9), rgba(18,26,51,.35));
    position: sticky; top:0;
    backdrop-filter: blur(8px);
    z-index: 10;
  }
  .title{display:flex; flex-direction:column; gap:2px}
  .title h1{margin:0; font-size:16px; letter-spacing:.2px}
  .title small{color:var(--muted)}
  .pillrow{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
  .pill{
    padding:6px 10px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.06);
    border-radius:999px;
    color:var(--text);
    font-size:12px;
  }

  main{padding:18px; max-width:1100px; margin:0 auto}
  .grid{display:grid; grid-template-columns: 280px 1fr; gap:14px}
  @media (max-width:900px){ .grid{grid-template-columns:1fr} }

  .card{
    border:1px solid var(--line);
    background: linear-gradient(180deg, rgba(18,26,51,.92), rgba(15,23,48,.88));
    border-radius:16px;
    padding:14px;
    box-shadow: 0 18px 50px rgba(0,0,0,.35);
  }
  .nav button{
    width:100%;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.06);
    color:var(--text);
    cursor:pointer;
    text-align:left;
    margin-bottom:8px;
    transition:.15s transform ease, .15s background ease;
  }
  .nav button:hover{transform: translateY(-1px); background: rgba(255,255,255,.09)}
  .nav button.active{
    background: rgba(139,211,255,.16);
    border-color: rgba(139,211,255,.35);
  }
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .btn{
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.06);
    color:var(--text);
    cursor:pointer;
  }
  .btn.primary{
    background: rgba(139,211,255,.16);
    border-color: rgba(139,211,255,.35);
  }
  .btn.danger{
    background: rgba(255,139,161,.14);
    border-color: rgba(255,139,161,.3);
  }
  .sectionTitle{margin:0 0 8px; font-size:14px}
  .muted{color:var(--muted); font-size:13px; line-height:1.35}
  .mini{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.35}
  .hr{height:1px; background:var(--line); margin:12px 0}
  .select{
    width:100%;
    padding:10px;
    border-radius:12px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.06);
    color:var(--text);
    margin-top:8px;
  }
  input.select::placeholder{color: rgba(255,255,255,.45)}

 /* === CARTE MYSTIQUE SOMBRE (CORRIG√âE) === */
.map{
  position: relative;
  overflow: hidden;
  min-height: 520px;
  border-radius: 22px;

  background:
    radial-gradient(900px 600px at 50% 35%, rgba(120,120,160,.25), transparent 65%),
    radial-gradient(700px 500px at 30% 25%, rgba(90,70,130,.35), transparent 65%),
    linear-gradient(180deg, #1a1e2a 0%, #141822 45%, #0f131d 100%);

  box-shadow:
    inset 0 0 0 1px rgba(140,160,255,.18),
    inset 0 0 120px rgba(40,60,120,.55),
    0 25px 45px rgba(0,0,0,.65);
}

.map::before{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;

  background:
    radial-gradient(600px 400px at 40% 30%, rgba(180,200,255,.18), transparent 65%),
    radial-gradient(700px 500px at 70% 60%, rgba(120,160,255,.22), transparent 70%),
    repeating-linear-gradient(
      0deg,
      rgba(255,255,255,.035),
      rgba(255,255,255,.035) 1px,
      transparent 1px,
      transparent 3px
    );
}

/* === LUEUR MAGIQUE ANIM√âE === */
@keyframes magicPulse {
  0% {
    opacity: 0.45;
    filter: blur(0px);
  }
  50% {
    opacity: 0.75;
    filter: blur(2px);
  }
  100% {
    opacity: 0.45;
    filter: blur(0px);
  }
}

.map::before{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;

  background:
    radial-gradient(600px 450px at 50% 35%, rgba(170,200,255,.35), transparent 70%),
    radial-gradient(500px 400px at 65% 55%, rgba(160,120,255,.25), transparent 70%),
    radial-gradient(400px 300px at 35% 60%, rgba(120,180,255,.18), transparent 70%);

  animation: magicPulse 8s ease-in-out infinite;
}


.map::after{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;

  box-shadow:
    inset 0 0 80px rgba(0,0,0,.65),
    inset 0 0 140px rgba(20,30,60,.75),
    inset 0 0 220px rgba(0,0,0,.85);
}




  .mapCam{
    position:absolute;
    inset:0;
    transform: translate3d(0,0,0) scale(1);
    transition: transform 1.15s ease;
  }

  .mapSvg{
    position:absolute;
    inset:0;
    pointer-events:none;
    opacity:.85;
  }

  /* boussole d√©corative */
  .compass{
    position:absolute;
    right:14px;
    bottom:14px;
    width:88px; height:88px;
    border-radius:50%;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.18);
    backdrop-filter: blur(6px);
    display:flex; align-items:center; justify-content:center;
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
    pointer-events:none;
  }
  .compass .needle{
    width:54px;height:54px;
    border-radius:50%;
    border:1px dashed rgba(255,255,255,.18);
    display:flex; align-items:center; justify-content:center;
    transform: rotate(18deg);
  }

  @keyframes nodeIn {
    from { transform: translate(var(--tx,-50%), var(--ty,-50%)) translateY(10px) scale(.98); opacity: 0; }
    to   { transform: translate(var(--tx,-50%), var(--ty,-50%)) translateY(0)  scale(1);    opacity: 1; }
  }
  .node{
    position:absolute;
    transform: translate(var(--tx,-50%), var(--ty,-50%));
    width: min(280px, 78vw);
    padding: 12px 12px 12px 12px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.14);
    background:
      linear-gradient(180deg, rgba(0,0,0,.28), rgba(0,0,0,.18));
    backdrop-filter: blur(8px);
    cursor:pointer;
    user-select:none;
    opacity:0;
    animation: nodeIn .35s ease forwards;
    box-shadow:
      0 0 0 1px rgba(0,0,0,.25),
      0 18px 55px rgba(0,0,0,.35);
  }
  .node:hover{filter: brightness(1.05)}
  
  /* ===== MAP nodes: centrer sur le point ===== */
  .map .node{ transform: translate(-50%, -50%); }
.node.selected{
    border-color: rgba(139,211,255,.40);
    box-shadow:
      0 0 0 1px rgba(139,211,255,.20),
      0 0 22px rgba(139,211,255,.20),
      0 18px 55px rgba(0,0,0,.35);
  }
  .nodeHead{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
  }
  .nodeTitle{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .emblem{
    width:40px;height:40px;border-radius:14px;
    border:1px solid rgba(255,255,255,.16);
    background: rgba(255,255,255,.06);
    display:flex;align-items:center;justify-content:center;
    font-size:20px;
    flex:0 0 auto;
  }
  .node h3{margin:0 0 3px; font-size:14px; line-height:1.1}
  .node small{color:var(--muted); font-size:12px; line-height:1.25}
  .badge{
    display:inline-flex;
    align-items:center;
    gap:8px;
    margin-top:10px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    font-size:12px;
    color:rgba(255,255,255,.92);
  }
  .node.selected .badge{
    background: rgba(157,255,176,.14);
    border-color: rgba(157,255,176,.35);
  }

  /* ===== Cin√©matique ===== */
  .cinematic{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:none;
    background: rgba(0,0,0,.0);
    opacity:0;
    transition: opacity .25s ease, background .25s ease;
    z-index:5;
  }
  .cinematic.show{
    opacity:1;
    background: rgba(0,0,0,.22);
  }
  .cinematicCard{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(15,23,48,.78);
    border-radius:18px;
    padding:16px 18px;
    max-width: 560px;
    text-align:center;
    box-shadow: 0 22px 70px rgba(0,0,0,.45);
    transform: translateY(10px) scale(.98);
    transition: transform .25s ease;
  }
  .cinematic.show .cinematicCard{
    transform: translateY(0) scale(1);
  }
  .cinematicTitle{margin:0 0 6px; font-size: 16px; letter-spacing:.2px}
  .cinematicDesc{margin:0; color: rgba(255,255,255,.80); font-size: 13px; line-height: 1.35}
  .cinematicLore{margin:10px 0 0; color: rgba(255,255,255,.72); font-size: 12px; line-height: 1.35}

  /* ===== Roster ===== */
  .list{display:grid; grid-template-columns: repeat(2, minmax(240px, 1fr)); gap:10px}
  @media (max-width:900px){ .list{grid-template-columns:1fr} }
  .char{
    border:1px solid var(--line);
    border-radius:14px;
    padding:12px;
    background: rgba(0,0,0,.18);
  }
  .charTop{display:flex; justify-content:space-between; gap:10px; align-items:center}
  .char h4{margin:0 0 4px; font-size:14px}
  .tag{font-size:12px; color:var(--muted)}
  .bar{
    height:10px; border-radius:999px; background: rgba(255,255,255,.08); overflow:hidden;
    border:1px solid var(--line);
    margin-top:10px;
  }
  .bar > div{height:100%; width:0%}
  .barXp > div{background: linear-gradient(90deg, rgba(139,211,255,.9), rgba(157,255,176,.9))}
  .stats{margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; color:var(--muted); font-size:12px}
  .avatarBox{
    width:44px;height:44px;border-radius:12px;overflow:hidden;
    border:1px solid var(--line);
    background: rgba(255,255,255,.06);
    display:flex;align-items:center;justify-content:center;
    flex: 0 0 auto;
  }
  .avatarBox img{width:100%;height:100%;object-fit:cover}
  .avatarFallback{font-size:22px}
  .choiceRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}

  /* ===== Voies / R√¥les (chips) ===== */
  .roleChip{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    cursor:pointer;
    user-select:none;
    font-size:12px;
    color: rgba(255,255,255,.92);
  }
  .roleChip:hover{filter:brightness(1.05)}
  .roleChip.on{
    background: rgba(157,255,176,.14);
    border-color: rgba(157,255,176,.35);
  }

  /* ===== Battle ===== */
  .battleGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }
  @media (max-width:900px){ .battleGrid{grid-template-columns:1fr} }
  .log{
    height: 190px;
    overflow:auto;
    padding:10px;
    border-radius:14px;
    border:1px solid var(--line);
    background: rgba(0,0,0,.20);
    font-size:12px;
    color:var(--muted);
    line-height:1.35;
  }
  .log b{color:var(--text)}
  footer{padding:14px 18px; color:var(--muted); font-size:12px; text-align:center}

  /* Fix clics au cas o√π */
  #view { position: relative; z-index: 1; }
  .nav { position: relative; z-index: 2; }
.cineOverlay{position:fixed;inset:0;background:rgba(0,0,0,.72);display:none;align-items:center;justify-content:center;z-index:9999}
.cineOverlay.show{display:flex}
.cineCard{width:min(680px,92vw);border:1px solid rgba(255,255,255,.18);background:rgba(18,26,51,.92);border-radius:18px;padding:16px;box-shadow:0 24px 70px rgba(0,0,0,.55);transform:scale(.94);opacity:0;animation:cineIn 1.5s ease forwards}
@keyframes cineIn{0%{transform:scale(.94);opacity:0}40%{transform:scale(1.02);opacity:1}100%{transform:scale(1);opacity:1}}
.cineTitle{font-size:16px;font-weight:800;margin:0 0 8px}
.cineText{color:rgba(255,255,255,.82);line-height:1.45;margin:0 0 12px}
.cineSmall{color:rgba(255,255,255,.62);font-size:12px;margin:0 0 12px}


  .tag.ok{color: var(--good);}


/* R√¥les : lisibilit√© des menus d√©roulants */
#roleStudentSel, #roleTypeSel { color:#0b1220 !important; background:#ffffff !important; }
#roleStudentSel option, #roleTypeSel option { color:#0b1220 !important; background:#ffffff !important; }


/* BOSS VICTORY */
.victoryOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.62);z-index:80;padding:18px}
.victoryCard{max-width:720px;width:100%;border-radius:22px;border:1px solid rgba(255,255,255,.14);
  background:rgba(18,26,51,.92);box-shadow:0 20px 60px rgba(0,0,0,.6);padding:16px;position:relative;overflow:hidden}
.victoryCard h3{margin:0 0 8px;font-size:18px}
.victoryCard p{margin:0;color:rgba(255,255,255,.86);line-height:1.5}
.confetti{position:absolute;top:-12px;width:10px;height:14px;border-radius:2px;opacity:.9;animation:confettiFall 1.8s linear infinite}
@keyframes confettiFall{
  0%{transform:translateY(-20px) rotate(0deg);opacity:0}
  10%{opacity:1}
  100%{transform:translateY(560px) rotate(360deg);opacity:0}
}


/* =========================
   üèÜ SUCC√àS COLLECTIFS
   ========================= */
.successHdr{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin:10px 0}
.successList{margin-top:10px}
.successRow{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:10px;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.18);margin:8px 0}
.successTitle{flex:1;min-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.successTitle.done{text-decoration:line-through;opacity:.75}


/* ===== Animation Succ√®s ===== */
#succToast{position:fixed;left:50%;top:14px;transform:translateX(-50%);z-index:99998;
  background:rgba(15,22,40,.96);border:1px solid rgba(255,255,255,.18);color:#fff;
  padding:12px 14px;border-radius:14px;box-shadow:0 16px 60px rgba(0,0,0,.45);
  display:none;max-width:min(720px, calc(100vw - 24px));text-align:center}
#succToast.show{display:block;animation:toastIn .25s ease-out}
@keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(-8px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.sparks{position:fixed;inset:0;pointer-events:none;z-index:99997;overflow:hidden}
.spark{position:absolute;font-size:20px;animation:sparkUp 1.2s ease-out forwards;opacity:0}
@keyframes sparkUp{0%{transform:translateY(0) scale(.8);opacity:0}
15%{opacity:1}
100%{transform:translateY(-140px) scale(1.25);opacity:0}}


/* ===== Badges (r√¥les) ===== */
.badgeRow{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.badgeChip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);font-size:13px}
.badgePts{opacity:.8;font-weight:700}


/* ===== OVERRIDES (stabilit√© Edge) ===== */
#view .choiceRow [data-role-toggle="1"]{
  background: rgba(0,0,0,.22) !important;
  color: rgba(255,255,255,.92) !important;
  border: 1px solid rgba(255,255,255,.16) !important;
  appearance: none !important;
  -webkit-appearance: none !important;
}
#view .choiceRow [data-role-toggle="1"].on{
  background: rgba(157,255,176,.14) !important;
  border-color: rgba(157,255,176,.35) !important;
  color: rgba(255,255,255,.95) !important;
}
/* menus d√©roulants sombre */
select.questSel{
  background: rgba(0,0,0,.28) !important;
  color: rgba(255,255,255,.92) !important;
  border: 1px solid rgba(255,255,255,.16) !important;
}
select.questSel option{
  background: #0b1220 !important;
  color: #ffffff !important;
}
/* nodes map: toujours visibles m√™me si animation bloqu√©e */
.map .node{
  opacity: 1 !important;
  animation: none !important;
}


/* ===== HOTFIX MAP NODES VISIBILITY (Edge) ===== */
#view .mapCam .node{
  opacity: 1 !important;
  animation: none !important;
  z-index: 5 !important;
  transform: translate(-50%, -50%) !important;
}
#view .mapCam .mapSvg{ z-index: 1 !important; }

</style>

<style>
/* ===== Acc√®s prof (cl√©) ===== */
.gateOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:99999;
  background:rgba(0,0,0,.65);backdrop-filter:blur(6px);padding:16px;}
.gateOverlay.show{display:flex;}
.gateCard{max-width:520px;width:100%;background:rgba(15,22,40,.95);border:1px solid rgba(255,255,255,.12);
  border-radius:18px;padding:22px 18px;text-align:center;box-shadow:0 20px 80px rgba(0,0,0,.55);}
.gateIcon{font-size:34px;margin-bottom:8px}
.gateTitle{font-size:28px;font-weight:800;margin:4px 0 6px}
.gateText{opacity:.9;margin:0 0 14px}
.gateBtn{cursor:pointer;border:1px solid rgba(255,255,255,.18);background:#3b82f6;color:#fff;
  padding:10px 16px;border-radius:12px;font-weight:700}
.gateBtn:hover{filter:brightness(1.05)}
.gateHint{opacity:.75;margin-top:12px;font-size:13px}

/* ===== FIX: menus de qu√™te (select) en th√®me sombre ===== */
#view select.questSel,
#view .questSel,
select.questSel{
  background: rgba(0,0,0,.22) !important;
  color: rgba(255,255,255,.92) !important;
  border: 1px solid rgba(255,255,255,.16) !important;
  border-radius: 12px !important;
  appearance: none !important;
  -webkit-appearance: none !important;
}

#view select.questSel option,
#view .questSel option,
select.questSel option{
  background: #0f1730 !important;
  color: rgba(255,255,255,.92) !important;
}

/* Windows/Edge: parfois le menu d√©roulant reste clair -> au moins la valeur affich√©e reste lisible */
#view select.questSel:focus{
  outline: 2px solid rgba(139,211,255,.35) !important;
  outline-offset: 2px !important;
}


/* ===== OVERRIDES (stabilit√© Edge) ===== */
#view .choiceRow [data-role-toggle="1"]{
  background: rgba(0,0,0,.22) !important;
  color: rgba(255,255,255,.92) !important;
  border: 1px solid rgba(255,255,255,.16) !important;
  appearance: none !important;
  -webkit-appearance: none !important;
}
#view .choiceRow [data-role-toggle="1"].on{
  background: rgba(157,255,176,.14) !important;
  border-color: rgba(157,255,176,.35) !important;
  color: rgba(255,255,255,.95) !important;
}
/* menus d√©roulants sombre */
select.questSel{
  background: rgba(0,0,0,.28) !important;
  color: rgba(255,255,255,.92) !important;
  border: 1px solid rgba(255,255,255,.16) !important;
}
select.questSel option{
  background: #0b1220 !important;
  color: #ffffff !important;
}
/* nodes map: toujours visibles m√™me si animation bloqu√©e */
.map .node{
  opacity: 1 !important;
  animation: none !important;
}

</style>

<style>
/* ===== OVERRIDES EDGE : nodes visibles + Voies non blanches ===== */
#view .mapCam .node{
  opacity: 1 !important;
  animation: none !important;
  z-index: 3 !important;
}
#view .mapCam .mapSvg{
  position: absolute;
  inset: 0;
  z-index: 1 !important;
}

/* Voies du Fran√ßais (pills) */
#view .choiceRow [data-role-toggle="1"],
#view .choiceRow .roleChip,
#view .choiceRow button.roleChip,
#view .choiceRow span.roleChip{
  background: rgba(0,0,0,.22) !important;
  background-color: rgba(0,0,0,.22) !important;
  color: rgba(255,255,255,.92) !important;
  border: 1px solid rgba(255,255,255,.16) !important;
  appearance: none !important;
  -webkit-appearance: none !important;
}
#view .choiceRow [data-role-toggle="1"].on,
#view .choiceRow .roleChip.on{
  background: rgba(157,255,176,.14) !important;
  border-color: rgba(157,255,176,.35) !important;
  color: rgba(255,255,255,.95) !important;
}

/* Menus "Type de qu√™te" : th√®me sombre */
#view select.questSel{
  background: rgba(0,0,0,.22) !important;
  color: rgba(255,255,255,.92) !important;
  border: 1px solid rgba(255,255,255,.16) !important;
}
#view select.questSel option{
  background: #0b1020 !important;
  color: #ffffff !important;
}
</style>
</head>
<body>
<div id="succToast"></div><div id="succSparks" class="sparks"></div>


<div id="profGate" class="gateOverlay" aria-hidden="true">
  <div class="gateCard">
    <div class="gateIcon">üîí</div>
    <div class="gateTitle">Acc√®s r√©serv√©</div>
    <div class="gateText">Cette page est r√©serv√©e √† l‚Äôenseignant.</div>
    <button id="gateBtn" class="gateBtn" type="button">Acc√®s prof</button>
    <div class="gateHint">Astuce : tu peux aussi utiliser l‚ÄôURL avec <b>?key=‚Ä¶</b></div>
  </div>

<script id="profAccess">
/* ===== Acc√®s prof (cl√©) ‚Äî URL + m√©moire locale ===== */
(function(){
  const PROF_KEY = "prof2025_proust"; // <-- change ici (unique)
  const DISABLE_PROF_GATE = true;     // ‚úÖ acc√®s libre (mettre false pour r√©activer la cl√©)

  const params = new URLSearchParams(location.search);
  const urlKey = (params.get("key") || "").trim();
  const memKey = (localStorage.getItem("ORTHESIA_PROF_KEY") || "").trim();
  const key = urlKey || memKey;

  const gate = document.getElementById("profGate");
  const btn = document.getElementById("gateBtn");

  function showGate(){
    if(!gate) return;
    gate.classList.add("show");
    gate.setAttribute("aria-hidden","false");
    document.documentElement.style.overflow = "hidden";
    document.body.style.overflow = "hidden";
  }
  function hideGate(){
    if(!gate) return;
    gate.classList.remove("show");
    gate.setAttribute("aria-hidden","true");
    document.documentElement.style.overflow = "";
    document.body.style.overflow = "";
  }

  function unlock(withKey){
    localStorage.setItem("ORTHESIA_PROF_KEY", withKey);
    const url = new URL(location.href);
    url.searchParams.set("key", withKey);
    history.replaceState({}, "", url.toString());
    hideGate();
  }

  // ‚úÖ si acc√®s libre : on cache et on sort
  if (DISABLE_PROF_GATE) { hideGate(); return; }

  if(key !== PROF_KEY){
    showGate();
    if(btn){
      btn.addEventListener("click", ()=>{
        const v = prompt("Cl√© d‚Äôacc√®s prof :", "");
        if(!v) return;
        const attempt = v.trim();
        if(attempt === PROF_KEY){
          unlock(attempt);
        }else{
          alert("Cl√© incorrecte.");
        }
      });
    }
  }else{
    if(key) localStorage.setItem("ORTHESIA_PROF_KEY", key);
    hideGate();
  }
})();
  }
})();

})();
</script>

</div>


<header>
  <div class="title">
    <h1>Le Royaume d‚ÄôOrth√©sia ‚Äî 5e Proust</h1>
    <small>RPG local : effort, m√©thode, entraide ‚Äî 5e Proust. (Photos .png dans le m√™me dossier que ce fichier .html)</small>
  </div>
  <div class="pillrow">
    <span class="pill" id="pillChapter">Zone : ‚Äî</span>
    <span class="pill" id="pillTeam">√âquipe : ‚Äî</span>
    <span class="pill" id="pillXP">XP total : ‚Äî</span>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card nav">
      <h2 class="sectionTitle">Menu</h2>
      <button class="active" data-view="map">üó∫Ô∏è Carte</button>
      <button data-view="roster">üë• √âquipe</button>
      <button data-view="quests">üìú Qu√™tes</button>
      <button data-view="battle">‚öîÔ∏è Combat</button>
      <button data-view="gm">üéÆ Ma√Ætre du jeu</button>
        <button data-view="success">üèÜ Succ√®s</button>

      <div class="hr"></div>
      <p class="muted">
        Changement de zone : cin√©matique (1,5s) + phrase d‚Äôhistoire (dont l‚Äôarriv√©e de Louane une seule fois) + son ‚Äúwhoosh‚Äù + zoom cam√©ra.
      </p>
      <div class="row" style="margin-top:10px">
        <button class="btn danger" id="resetBtn">R√©initialiser</button>
        <button class="btn" id="exportBtn">Exporter</button>
        <button class="btn" id="importBtn">Importer</button>
      </div>
      <input class="select" id="importField" placeholder="Colle ici la sauvegarde JSON (Exporter) puis Entr√©e" />
    </section>

    <section class="card" id="view"></section>
  </div>
</main>

<footer>
  Photos : laisse le fichier <b>.html</b> dans le m√™me dossier que les <b>.png</b>. Si une photo manque (ex : Louane), l‚Äôic√¥ne s‚Äôaffiche √† la place.
</footer>

<!-- Overlay cin√©matique de fin (OK : dans le BODY, pas dans le CSS) -->
<div class="cineOverlay" id="cine">
  <div class="cineCard">
    <div class="cineTitle">‚ú® Victoire de Trimestre</div>
    <p class="cineText" id="cineText"></p>
    <p class="cineSmall">Cette victoire est collective : chacun a apport√© quelque chose.</p>
    <div class="row">
      <button class="btn primary" onclick="closeCine()">Continuer</button>
    </div>
  </div>
</div>

<script>
function ensureState(){
  if(!state || typeof state!=="object"){
    try{ state = JSON.parse(JSON.stringify(defaultState)); }
    catch(e){ state = { ...defaultState }; }
  }
  state.rolesActive = Array.isArray(state.rolesActive) ? state.rolesActive : [];
  state.rolesHistory = Array.isArray(state.rolesHistory) ? state.rolesHistory : [];
  state.collectiveGoals = Array.isArray(state.collectiveGoals) ? state.collectiveGoals : [];
}


function escapeHtml(str){
  if(typeof str!=="string") return "";
  return str
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}


console.log("‚úÖ JS charg√© (version corrig√©e)");

// ---------- Donn√©es √©l√®ves ----------
const students = [
{ name: "Wyatt",    cls: "√âclaireur", trait: "√©nergie",       keywords: ["participation"],              portrait: "wyatt.png",    icon:"‚ú®" },
  { name: "Lyna",     cls: "Savant",    trait: "application",   keywords: ["m√©thode","participation"],   portrait: "lyna.png",     icon:"üìò" },
  { name: "J√©r√©mie",  cls: "Apprenti",  trait: "pers√©v√©rance",  keywords: ["m√©thode","confiance"],       portrait: "jeremie.png",  icon:"üå±" },
  { name: "Alicia",   cls: "Savant",    trait: "application",   keywords: ["m√©thode"],                   portrait: "alicia.png",   icon:"üìò" },
  { name: "Jules",    cls: "Apprenti",  trait: "volont√©",       keywords: ["concentration"],             portrait: "jules.png",    icon:"üå±" },
  { name: "Th√©o",     cls: "Gardien",   trait: "stabilit√©",     keywords: ["r√©gularit√©"],                portrait: "th√©o.png",     icon:"üõ°Ô∏è" },
  { name: "Pavel",    cls: "√âclaireur", trait: "curiosit√©",     keywords: ["participation"],             portrait: "pavel.png",    icon:"‚ú®" },
  { name: "Ewenn",    cls: "Apprenti",  trait: "progression",   keywords: ["concentration","m√©thode"],   portrait: "ewenn.png",    icon:"üå±" },
  { name: "Emma",     cls: "Messager",  trait: "clart√©",        keywords: ["confiance","participation"], portrait: "emma.png",     icon:"üó£Ô∏è" },
  { name: "Marina",   cls: "Savant",    trait: "rigueur",       keywords: ["m√©thode"],                   portrait: "marina.png",   icon:"üìò" },
  { name: "Sam",      cls: "Gardien",   trait: "r√©gularit√©",    keywords: ["confiance"],                 portrait: "sam.png",      icon:"üõ°Ô∏è" },
  { name: "Yanis",    cls: "√âclaireur", trait: "dynamisme",     keywords: ["concentration"],             portrait: "yanis.png",    icon:"‚ú®" },
  { name: "Typhanie", cls: "Messager",  trait: "pr√©sence",      keywords: ["participation","concentration"], portrait:"typhanie.png", icon:"üó£Ô∏è" },
  { name: "Lola",     cls: "Savant",    trait: "potentiel",     keywords: ["m√©thode","concentration"],   portrait: "lola.png",     icon:"üìò" },
  { name: "Zo√©",      cls: "Gardien",   trait: "s√©rieux",       keywords: ["r√©gularit√©"],                portrait: "zo√©.png",      icon:"üõ°Ô∏è" },
  { name: "Shannon",  cls: "Apprenti",  trait: "pers√©v√©rance",  keywords: ["m√©thode","confiance"],       portrait: "shannon.png",  icon:"üå±" },
  { name: "Coline",   cls: "Messager",  trait: "int√©gration",   keywords: ["confiance","participation"], portrait:"coline.png",    icon:"üó£Ô∏è" },
  { name: "Yuri",     cls: "Apprenti",  trait: "√©nergie",       keywords: ["concentration","m√©thode"],   portrait: "yuri.png",     icon:"üå±" },
  { name: "Simon",    cls: "Apprenti",  trait: "capacit√©",      keywords: ["confiance"],                 portrait: "simon.png",    icon:"üå±" },
  { name: "Ma√´lye",   cls: "Messager",  trait: "s√©rieux",       keywords: ["participation","confiance"], portrait:"maelye.png",    icon:"üó£Ô∏è" },

  { name: "Louane",   cls: "Messager",  trait: "adaptation",    keywords: ["confiance","participation"], portrait:"louane.png",    icon:"üó£Ô∏è" }
];

// ---------- Monde ----------
const zones = [
  { id:"plaine", name:"Plaine de la Compr√©hension", desc:"Lire, comprendre, rep√©rer l'essentiel.", x: 8,  y: 15 },
  { id:"foret",  name:"For√™t de l‚Äô√âcriture",        desc:"√âcrire, structurer, am√©liorer.",        x: 40, y: 44 },
  { id:"cite",   name:"Cit√© de l‚ÄôOral",             desc:"Prendre la parole avec confiance.",     x: 74, y: 14 },
  { id:"mont",   name:"Montagne de la M√©thode",     desc:"S'organiser, relire, progresser.",      x: 18, y: 64 },
  { id:"sanct",  name:"Sanctuaire de la Confiance", desc:"Oser, pers√©v√©rer, grandir.",            x: 74, y: 64 }
];

// Ic√¥ne/embl√®me par zone (carte fantasy)
function zoneIcon(zoneId){
  const map = {
    plaine: "üìñ",
    foret: "‚úçÔ∏è",
    cite: "üé§",
    montagne: "üß≠",
    sanctuaire: "üî•"
  };
  return map[zoneId] || "‚ú®";
}


const enemies = [
  { id:"doute", name:"Le Doute", hp: 35, atk: 6, msg:"Il murmure : ‚ÄúTu n‚Äôy arriveras pas‚Ä¶‚Äù" },
  { id:"disp",  name:"La Dispersion", hp: 30, atk: 7, msg:"Elle disperse l‚Äôattention et le courage." },
  { id:"peur",  name:"La Peur de se tromper", hp: 40, atk: 5, msg:"Elle freine les essais‚Ä¶ alors qu‚Äôils font progresser." }
];

const boss = {
  id: "boss_t1",
  name: "Le Grand Brouillard du Trimestre",
  hp: 120,
  hpMax: 120,
  weakness: "methode", // lien avec ton action "methode"
  status: "active",
  log: [
    "Le brouillard s‚Äô√©paissit‚Ä¶ mais l‚Äô√©quipe avance.",
    "Une phrase bien construite dissipe une ombre."
  ]
};

const actions = [
  { id:"effort",  label:"Effort",    desc:"+ d√©g√¢ts stables",   dmg:[6,10], heal:[0,0] },
  { id:"methode", label:"M√©thode",   desc:"+ pr√©cision, - d√©g√¢ts subis", dmg:[5,9], heal:[0,0], shield:2 },
  { id:"entraide",label:"Entraide",  desc:"soigne un peu l‚Äô√©quipe", dmg:[4,8], heal:[2,5] },
  { id:"calme",   label:"Calme",     desc:"soigne beaucoup", dmg:[2,5], heal:[4,8] }
];

/* =========================
   MOIS (Jan ‚Üí Juin)
   ========================= */
const months = [
  { id:"jan", label:"Janvier",  bossName:"Le Doute persistant",      bossId:"doute", goal:"Reprendre confiance apr√®s les vacances." },
  { id:"feb", label:"F√©vrier",  bossName:"La Dispersion",            bossId:"disp",  goal:"Tenir la concentration dans la dur√©e." },
  { id:"mar", label:"Mars",     bossName:"La Peur de se tromper",    bossId:"peur",  goal:"Oser essayer, m√™me si c‚Äôest imparfait." },
  { id:"apr", label:"Avril",    bossName:"La Fatigue",               bossId:"fatigue", goal:"Rester r√©gulier malgr√© la baisse d‚Äô√©nergie." },
  { id:"may", label:"Mai",      bossName:"La Pr√©cipitation",         bossId:"precip", goal:"Relire, √™tre rigoureux, am√©liorer." },
  { id:"jun", label:"Juin",     bossName:"L‚ÄôOmbre d‚ÄôOrth√©sia",       bossId:"final", goal:"Boss final : union, autonomie, confiance." }
];

// Associe un id de mois au mois syst√®me (Jan=0 ... Dec=11)
function getCurrentMonthId(){
  const m = new Date().getMonth();
  if(m === 0) return "jan";
  if(m === 1) return "feb";
  if(m === 2) return "mar";
  if(m === 3) return "apr";
  if(m === 4) return "may";
  if(m === 5) return "jun";
  // Si on est hors Jan‚ÄìJuin, on se cale sur Jan (ou tu peux mettre "jun")
  return "jan";
}

function getMonthConfig(){
  const id = getCurrentMonthId();
  return months.find(x => x.id === id) || months[0];
}




const loreLines = [
  "Le groupe avance, plus uni qu‚Äôhier.",
  "Les pas r√©sonnent‚Ä¶ et la confiance grandit.",
  "Chacun apporte quelque chose : c‚Äôest √ßa, une √©quipe.",
  "Les efforts d‚Äôaujourd‚Äôhui construisent les victoires de demain.",
  "Une difficult√© traverse la route‚Ä¶ mais la classe garde le cap.",
  "Les h√©ros progressent, m√™me quand c‚Äôest discret.",
  "Une bonne m√©thode √©claire le chemin.",
  "On respire, on se concentre‚Ä¶ et on continue."
];

const achievements = [
  { id:"focus_10", title:"10 minutes de focus", desc:"La classe a tenu 10 minutes sans interruption.", unlocked:false, date:"" },
  { id:"copies_30", title:"30 relectures", desc:"30 copies relues s√©rieusement.", unlocked:false, date:"" },
  { id:"oral_10", title:"10 prises de parole", desc:"10 √©l√®ves ont particip√© √† l‚Äôoral.", unlocked:false, date:"" }
];

const periods = [
  { id:"JAN", label:"Janvier",  dateRange:"Janvier",  teamXp:0, questsDone:0, notes:"" },
  { id:"FEB", label:"F√©vrier",  dateRange:"F√©vrier",  teamXp:0, questsDone:0, notes:"" },
  { id:"MAR", label:"Mars",     dateRange:"Mars",     teamXp:0, questsDone:0, notes:"" },
  { id:"APR", label:"Avril",    dateRange:"Avril",    teamXp:0, questsDone:0, notes:"" },
  { id:"MAY", label:"Mai",      dateRange:"Mai",      teamXp:0, questsDone:0, notes:"" },
  { id:"JUN", label:"Juin",     dateRange:"Juin",     teamXp:0, questsDone:0, notes:"" }
];

/* =========================
   R√îLES (individuels, 2 semaines, max 4 actifs)
   R√©compense √† la cl√¥ture : ‚úÖ -5 PV au Boss
   ========================= */
const ROLE_RULES = {
  maxActive: 4,
  durationDays: 14,
  reward: { type: "boss", bossDamage: 5, xpBonus: 0 } // type: "boss" | "xp" | "both"
};

const ROLE_TYPES = [
  {
    id:"lire",
    label:"üß† Voie du Lecteur-D√©tective",
    pts:1,
    axis:"Lire / Comprendre",
    desc:"Lire avec attention, rep√©rer les informations importantes et comprendre le sens du texte.",
    description:"Lire avec attention, rep√©rer les informations importantes et comprendre le sens du texte."
  },
  {
    id:"ecrire",
    label:"‚úçÔ∏è Voie du Scribe",
    pts:1,
    axis:"√âcrire / R√©diger",
    desc:"Produire un travail soign√©, lisible et bien pr√©sent√©, en prenant le temps de se relire.",
    description:"Produire un travail soign√©, lisible et bien pr√©sent√©, en prenant le temps de se relire."
  },
  {
    id:"oral",
    label:"üé§ Voie de l‚ÄôOrateur",
    pts:1,
    axis:"Oral / S‚Äôexprimer",
    desc:"Oser prendre la parole, expliquer sa r√©ponse ou poser une question utile au groupe.",
    description:"Oser prendre la parole, expliquer sa r√©ponse ou poser une question utile au groupe."
  },
  {
    id:"grammaire",
    label:"üß© Voie du Forgeron des Phrases",
    pts:1,
    axis:"Grammaire / Langue",
    desc:"Construire des phrases correctes : accords, conjugaisons, ponctuation, et pr√©cision du vocabulaire.",
    description:"Construire des phrases correctes : accords, conjugaisons, ponctuation, et pr√©cision du vocabulaire."
  },
  {
    id:"confiance",
    label:"üî• Voie du Courage",
    pts:1,
    axis:"Confiance en soi",
    desc:"Oser essayer m√™me si ce n‚Äôest pas parfait, accepter l‚Äôerreur, pers√©v√©rer et gagner en assurance.",
    description:"Oser essayer m√™me si ce n‚Äôest pas parfait, accepter l‚Äôerreur, pers√©v√©rer et gagner en assurance."
  },
  {
    id:"methodes",
    label:"üß≠ Voie du Strat√®ge",
    pts:1,
    axis:"M√©thodes / Organisation",
    desc:"Se concentrer, s‚Äôorganiser, g√©rer son temps et rester appliqu√© pour aller au bout de la t√¢che.",
    description:"Se concentrer, s‚Äôorganiser, g√©rer son temps et rester appliqu√© pour aller au bout de la t√¢che."
  }
];

/* =========================
   üéØ Qu√™tes (types cliquables)
   ========================= */
const QUEST_TYPES = [
  { id:"concentration", label:"üéØ Concentration" },
  { id:"methode",       label:"üß≠ M√©thode / Organisation" },
  { id:"rigueur",       label:"‚úçÔ∏è Rigueur / Soin" },
  { id:"confiance",     label:"üî• Confiance / Oser" },
  { id:"oral",          label:"üé§ Oral" },
  { id:"lecture",       label:"üìñ Lecture" },
  { id:"ecriture",      label:"üìù √âcriture" }
];

function ensureQuestTypes(){
  state.party = Array.isArray(state.party) ? state.party : [];
  for(const s of state.party){
    if(typeof s.questType !== "string" || !s.questType) s.questType = "methode";
    // quest est recalcul√©e √† l‚Äôaffichage, mais on la garde aussi en state pour export/compatibilit√©
    if(typeof s.quest !== "string") s.quest = "";
  }
}

function questTextFor(typeId){
  switch(typeId){
    case "concentration":
      return "Qu√™te : √ätre plus concentr√©(e) en classe, √©couter attentivement les consignes et les √©changes pour mieux comprendre le travail demand√©.";
    case "methode":
      return "Qu√™te : M‚Äôappuyer sur une m√©thode simple : lire la consigne jusqu‚Äôau bout, planifier en 2 √©tapes, puis relire et corriger.";
    case "rigueur":
      return "Qu√™te : √ätre plus rigoureux(se) : √©crire lisiblement, pr√©senter proprement, et v√©rifier avant de rendre (accords / ponctuation / consigne).";
    case "confiance":
      return "Qu√™te : Oser davantage : participer au moins une fois, poser une question utile, et accepter l‚Äôerreur comme une √©tape pour progresser.";
    case "oral":
      return "Qu√™te : Prendre la parole de fa√ßon utile : r√©pondre, expliquer une id√©e, ou reformuler ce qu‚Äôa dit un camarade.";
    case "lecture":
      return "Qu√™te : Lire avec attention : rep√©rer 3 informations importantes et reformuler le sens du texte avec mes mots.";
    case "ecriture":
      return "Qu√™te : √âcrire mieux : produire un texte structur√©, puis relire pour corriger au moins 2 erreurs.";
    default:
      return "Qu√™te : Progresser pas √† pas avec s√©rieux et r√©gularit√©.";
  }
}




// =========================
// üèÖ BADGES (individuels)
// R√®gle : un badge = +1 point collectif + (1 ou 2) points persos selon le r√¥le
// =========================
function ensureBadges(){
  state.badges = (state.badges && typeof state.badges==="object") ? state.badges : {};
  state.collectivePoints = Number(state.collectivePoints||0);
}

function toastBadge(msg){
  try{
    const toast = document.getElementById("succToast"); // r√©utilise le toast existant (si pr√©sent)
    if(toast){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(window.__succToastT);
      window.__succToastT = setTimeout(()=>toast.classList.remove("show"), 2200);
    }else{
      alert(msg);
    }
  }catch(e){}
}

function awardBadge(studentId, roleId){
  ensureBadges();
  const def = (ROLE_TYPES||[]).find(r=>r.id===roleId) || {label:roleId, pts:1};
  const list = Array.isArray(state.badges[studentId]) ? state.badges[studentId] : [];
  const badge = { id: "b"+Date.now()+Math.random().toString(16).slice(2), roleId, label:def.label||roleId, pts:Number(def.pts||1), at:new Date().toISOString() };
  list.push(badge);
  state.badges[studentId] = list;

  // +1 point collectif (toujours)
  state.collectivePoints = Number(state.collectivePoints||0) + 1;

  // points persos
  const stu = (state.students||[]).find(s=>s.id===studentId);
  if(stu){
    stu.badgePoints = Number(stu.badgePoints||0) + Number(badge.pts||1);
  }

  // XP perso (+pts) + d√©g√¢ts boss (-5 PV par pt)
  try{
    const DAMAGE_PER_PT = 5;
    if(stu){ stu.xp = Number(stu.xp||0) + Number(badge.pts||1); }
    if(state.boss && typeof state.boss==="object"){
      state.boss.maxHp = Number(state.boss.maxHp||state.boss.maxHP||state.boss.hpMax||100) || 100;
      state.boss.hp = Number(state.boss.hp||0);
      state.boss.hp = Math.max(0, state.boss.hp - DAMAGE_PER_PT*Number(badge.pts||1));
      if(state.boss.hp<=0){
        state.boss.hp = 0;
        state.boss.victoryStamp = state.boss.victoryStamp || new Date().toISOString();
        if(typeof triggerFinalEvent==="function"){ try{ triggerFinalEvent(); }catch(e){} }
      }
    }
  }catch(e){}

  save();
  toastBadge("üèÖ Badge : "+(badge.label||"")+" ‚Ä¢ +"+badge.pts+" points persos, +1 collectif, +"+badge.pts+" XP, -"+(5*badge.pts)+" PV boss");
}

function removeBadge(studentId, badgeId){
  ensureBadges();
  const list = Array.isArray(state.badges[studentId]) ? state.badges[studentId] : [];
  const idx = list.findIndex(b=>b.id===badgeId);
  if(idx<0) return;
  const badge = list[idx];
  list.splice(idx,1);
  state.badges[studentId] = list;

  // on retire aussi les points correspondants (coh√©rence)
  state.collectivePoints = Math.max(0, Number(state.collectivePoints||0) - 1);
  const stu = (state.students||[]).find(s=>s.id===studentId);
  if(stu){
    stu.badgePoints = Math.max(0, Number(stu.badgePoints||0) - Number(badge.pts||1));
  }

  // on retire aussi XP et on rend des PV au boss (coh√©rence)
  try{
    const DAMAGE_PER_PT = 5;
    const stu = (state.students||[]).find(s=>s.id===studentId);
    if(stu){ stu.xp = Math.max(0, Number(stu.xp||0) - Number(badge.pts||1)); }
    if(state.boss && typeof state.boss==="object"){
      state.boss.maxHp = Number(state.boss.maxHp||state.boss.maxHP||state.boss.hpMax||100) || 100;
      state.boss.hp = Number(state.boss.hp||0);
      state.boss.hp = Math.min(state.boss.maxHp, state.boss.hp + DAMAGE_PER_PT*Number(badge.pts||1));
    }
  }catch(e){}

  save();
  toastBadge("üóëÔ∏è Badge retir√©");
}


function addDays(date, days){
  const d = new Date(date.getTime());
  d.setDate(d.getDate()+days);
  return d;
}
function isoDate(d){ return new Date(d).toISOString(); }
function frDate(d){
  const dt = new Date(d);
  const dd=String(dt.getDate()).padStart(2,"0");
  const mm=String(dt.getMonth()+1).padStart(2,"0");
  const yy=dt.getFullYear();
  return `${dd}/${mm}/${yy}`;
}
function safeText(s){ return String(s ?? ""); }
function escapeRoleHtml(s){
  return safeText(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#39;");
}

function roleLabelById(id){
  const t = ROLE_TYPES.find(x=>x.id===id);
  return t ? t.label : id;
}

function roleDefById(id){
  return (ROLE_TYPES||[]).find(x=>x.id===id) || null;
}
function roleDescById(id){
  const d = roleDefById(id);
  return d ? (d.description || d.desc || "") : "";
}
function roleAxisById(id){
  const d = roleDefById(id);
  return d ? (d.axis || "") : "";
}
function canAssignMoreRoles(){
  return (state.rolesActive||[]).length < ROLE_RULES.maxActive;
}
function ensureRoleArrays(){
  state.rolesActive = Array.isArray(state.rolesActive) ? state.rolesActive : [];
  state.rolesHistory = Array.isArray(state.rolesHistory) ? state.rolesHistory : [];
}
function expireRolesIfNeeded(){
  ensureState();

  
ensureBadges();
ensureBadges();
ensureRoleArrays();
  const now = Date.now();
  const stillActive = [];
  for(const r of state.rolesActive){
    const end = Date.parse(r.endAt||"");
    if(end && end < now){
      state.rolesHistory.push({ ...r, endedAuto:true, closedAt: isoDate(new Date()) });
    } else {
      stillActive.push(r);
    }
  }
  state.rolesActive = stillActive;
}

function assignRole(studentId, roleId){
  ensureRoleArrays();
  if(!canAssignMoreRoles()) return alert("Max r√¥les actifs atteint ("+ROLE_RULES.maxActive+").");
  const s = state.party.find(p=>p.id===studentId);
  if(!s) return alert("√âl√®ve introuvable.");
  const start = new Date();
  const end = addDays(start, ROLE_RULES.durationDays);
  state.rolesActive.push({
    id: "r"+Date.now()+Math.random().toString(16).slice(2),
    studentId,
    studentName: s.name,
    roleId,
    roleLabel: roleLabelById(roleId),
    startAt: isoDate(start),
    endAt: isoDate(end)
  });
  pushAnnouncement(`üßô Nouveau r√¥le : ${s.name} ‚Üí ${roleLabelById(roleId)} (jusqu‚Äôau ${frDate(end)})`);
  save();
}

function applyRoleReward(r){
  if(ROLE_RULES.reward.type==="boss" || ROLE_RULES.reward.type==="both"){
    const dmg = Number(ROLE_RULES.reward.bossDamage)||0;
    if(state.boss && dmg>0){
      state.boss.hp = Math.max(0, (Number(state.boss.hp)||0) - dmg);
      state.boss.log = state.boss.log || [];
      state.boss.log.push("R√¥le termin√© : "+r.studentName+" ‚Üí "+r.roleLabel+" ( -"+dmg+" PV au Boss ).");
      if(Number(state.boss.hp)<=0){ state.boss.hp=0; state.boss.victoryStamp = new Date().toISOString(); triggerFinalEvent(); }
    }
  }
  if(ROLE_RULES.reward.type==="xp" || ROLE_RULES.reward.type==="both"){
    const bonus = Number(ROLE_RULES.reward.xpBonus)||0;
    if(bonus>0){
      const s = state.party.find(p=>p.id===r.studentId);
      if(s) s.xp = (Number(s.xp)||0) + bonus;
    }
  }
}

function closeRole(roleInstanceId){
  ensureRoleArrays();
  const idx = state.rolesActive.findIndex(r=>r.id===roleInstanceId);
  if(idx<0) return;
  const r = state.rolesActive[idx];
  state.rolesActive.splice(idx,1);
  applyRoleReward(r);
  state.rolesHistory.push({ ...r, closedAt: isoDate(new Date()), endedAuto:false });
  save();
}

function removeRole(roleInstanceId){
  ensureRoleArrays();
  const idx = state.rolesActive.findIndex(r=>r.id===roleInstanceId);
  if(idx<0) return;
  const r = state.rolesActive[idx];
  state.rolesActive.splice(idx,1);
  pushAnnouncement(`‚ÑπÔ∏è R√¥le retir√© : ${r.studentName} ‚Äî ${r.roleLabel}`);
  save();
}

function pushAnnouncement(txt){
  state.announcements = Array.isArray(state.announcements) ? state.announcements : [];
  state.announcements.push({ t: new Date().toISOString(), text: txt });
  if(state.announcements.length>12) state.announcements = state.announcements.slice(-12);
}

function renderRolesGM(){
  ensureRoleArrays();
  const active = state.rolesActive;
  const hist = state.rolesHistory;

  let html = '<div class="char">'
    + '<h4>üßô R√¥les (individuels)</h4>'
    + '<div class="tag">Max <b>'+ROLE_RULES.maxActive+'</b> ‚Ä¢ dur√©e <b>'+ROLE_RULES.durationDays+'</b> jours ‚Ä¢ r√©compense : <b>-'+ROLE_RULES.reward.bossDamage+' PV Boss</b></div>'
    + '<div class="hr"></div>'
    + '<div class="row">'
    + '  <select class="select" id="roleStudentSel"></select>'
    + '  <select class="select" id="roleTypeSel"></select>'
    + '</div>'
    + '<div class="choiceRow" style="margin-top:10px">'
    + '  <button class="btn primary" id="assignRoleBtn" type="button">Assigner</button>'
    + '</div>'
    + '</div>';

  html += '<div class="hr"></div><h3 style="margin:0 0 8px;font-size:14px">üé≠ R√¥les en cours ('+active.length+'/'+ROLE_RULES.maxActive+')</h3>';

  if(active.length===0){
    html += '<div class="char"><div class="tag">Aucun r√¥le actif.</div></div>';
  } else {
    for(const r of active){
      html += '<div class="char" style="margin-bottom:10px">'
        + '<div class="charTop">'
        + ' <div><h4 style="margin:0">'+escapeRoleHtml(r.studentName)+'</h4><div class="tag">'+escapeRoleHtml(r.roleLabel)+'</div></div>'
        + ' <div class="tag">jusqu‚Äôau <b>'+frDate(r.endAt)+'</b></div>'
        + '</div>'
        + '<div class="choiceRow">'
        + ' <button class="btn primary" type="button" data-role-action="close" data-role-id="'+escapeRoleHtml(r.id)+'">Cl√¥turer (+r√©compense)</button>'
        + ' <button class="btn danger"  type="button" data-role-action="remove" data-role-id="'+escapeRoleHtml(r.id)+'">Retirer</button>'
        + '</div>'
        + '</div>';
    }
  }

  html += '<div class="hr"></div><h3 style="margin:0 0 8px;font-size:14px">üïò Historique (prof)</h3>';
  if(hist.length===0){
    html += '<div class="char"><div class="tag">Aucun historique pour l‚Äôinstant.</div></div>';
  } else {
    const last = hist.slice(-12).reverse();
    for(const r of last){
      html += '<div class="char" style="margin-bottom:10px">'
        + '<div class="charTop">'
        + ' <div><h4 style="margin:0">'+escapeRoleHtml(r.studentName)+'</h4><div class="tag">'+escapeRoleHtml(r.roleLabel)+'</div></div>'
        + ' <div class="tag">'+(r.closedAt ? ("clos le <b>"+frDate(r.closedAt)+"</b>") : "")+'</div>'
        + '</div>'
        + '<div class="mini">D√©but : '+frDate(r.startAt)+' ‚Ä¢ Fin pr√©vue : '+frDate(r.endAt) + (r.endedAuto ? " ‚Ä¢ (auto)" : "") + '</div>'
        + '</div>';
    }
    html += '<div class="mini">Affichage limit√© aux 12 derniers r√¥les.</div>';
  }

  return html;
}



/* =========================
   P√âRIODES (Jan ‚Üí Juin)
   ========================= */
function buildDefaultPeriods(){
  return [
    { id:"jan", label:"Janvier",   range:"(Jan)",    teamXp:0, quests:0, note:"" },
    { id:"feb", label:"F√©vrier",   range:"(F√©v)",    teamXp:0, quests:0, note:"" },
    { id:"mar", label:"Mars",      range:"(Mar)",    teamXp:0, quests:0, note:"" },
    { id:"apr", label:"Avril",     range:"(Avr)",    teamXp:0, quests:0, note:"" },
    { id:"may", label:"Mai",       range:"(Mai)",    teamXp:0, quests:0, note:"" },
    { id:"jun", label:"Juin",      range:"(Juin)",   teamXp:0, quests:0, note:"" }
  ];
}

function normalizePeriods(st){
  const defs = buildDefaultPeriods();
  if(!st || typeof st!=="object") return defs;

  // If periods missing or old format (e.g., 3 p√©riodes Sept‚ÜíOct...), rebuild while keeping existing numbers if possible.
  const cur = Array.isArray(st.periods) ? st.periods : [];
  const byId = new Map(cur.filter(p=>p && typeof p==="object").map(p=>[p.id, p]));
  const looksOld = cur.length < 6 || cur.some(p => (p && (String(p.label||"").includes("Sept") || String(p.range||"").includes("Sept") || String(p.label||"").includes("P√©riode"))));

  const merged = defs.map(d=>{
    const old = byId.get(d.id);
    return {
      ...d,
      teamXp: Number(old?.teamXp ?? d.teamXp) || 0,
      quests: Number(old?.quests ?? d.quests) || 0,
      note: (typeof old?.note === "string") ? old.note : d.note
    };
  });

  // Also try to salvage totals from old periods (sum) into January if we detect old format.
  if(looksOld && cur.length){
    const sumXp = cur.reduce((a,p)=>a + (Number(p?.teamXp)||0),0);
    const sumQ  = cur.reduce((a,p)=>a + (Number(p?.quests)||0),0);
    if(sumXp && merged[0].teamXp===0) merged[0].teamXp = sumXp;
    if(sumQ  && merged[0].quests===0) merged[0].quests = sumQ;
  }
  return merged;
}



const finalLines = [
  "Le brouillard se dissipe‚Ä¶ et le royaume respire. Votre force, c‚Äôest l‚Äô√©quipe.",
  "Vous avez tenu bon : m√©thode, entraide, courage. C‚Äôest comme √ßa qu‚Äôon progresse.",
  "Chacun a fait un pas ‚Äî et ensemble, √ßa devient un chemin.",
  "Victoire ! Pas parfaite, mais vraie : celle des efforts r√©guliers."
];

// ---------- Utilitaires ----------
const STORAGE_KEY = "orthesia_5e_proust_save_v6";


const CLASS_SLUG = "5e-proust";
const CLASS_NAME = "5e Proust";
function nowFr(){
  const d=new Date();
  const dd=String(d.getDate()).padStart(2,"0");
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const yyyy=d.getFullYear();
  const hh=String(d.getHours()).padStart(2,"0");
  const mi=String(d.getMinutes()).padStart(2,"0");
  return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
}

function levelFromXP(xp){
  xp = Number(xp)||0;
  if(xp < 10) return 1;
  if(xp < 22) return 2;
  if(xp < 38) return 3;
  if(xp < 58) return 4;
  return 5;
}
function xpToNext(level){
  const t = [0,10,22,38,58,999];
  return t[level] || 999;
}

function buildQuestFromKeywords(keywords) {
  const list = keywords || [];
  const k = {};
  for(let i=0;i<list.length;i++) {
    const s = String(list[i] || "").toLowerCase().trim();
    k[s]=true;
  }
  const pieces = [];
  if (k["concentration"]) pieces.push("rester concentr√©(e) et √©viter la dispersion");
  if (k["m√©thode"]) pieces.push("t‚Äôappuyer sur une m√©thode simple : lire, planifier, relire");
  if (k["confiance"]) pieces.push("oser davantage et te faire confiance");
  if (k["participation"]) pieces.push("participer, m√™me bri√®vement, pour faire grandir tes id√©es");
  if (k["r√©gularit√©"]) pieces.push("avancer avec constance et r√©gularit√©");

  if (pieces.length === 0) return "Qu√™te : avancer pas √† pas, avec pers√©v√©rance.";
  let joined = "";
  if(pieces.length === 1) joined = pieces[0];
  else joined = pieces.slice(0,-1).join(", ") + ", et " + pieces[pieces.length-1];
  return "Qu√™te : " + joined + ".";
}

function makeInitialParty(){
  const party = [];
  for(let i=0;i<students.length;i++) {
    const s = students[i];
    party.push({
      id: "s"+i,
      name: s.name,
      cls: s.cls,
      trait: s.trait,
      role: s.role || null,
      quest: buildQuestFromKeywords(s.keywords),
      xp: 0,
      hp: 30,
      hpMax: 30,
      portrait: s.portrait || "",
      icon: s.icon || "‚ú®"
    });
  }
  return party;
}

function deepCopy(o){ return JSON.parse(JSON.stringify(o)); }

function defaultState(){
  return {
    zoneId: zones[0].id,
    party: makeInitialParty(),
    louaneIntroDone: false,
    quests: [
      { id:"q1", title:"Le Parchemin de la M√©thode", done:false, reward:6, desc:"Relire, corriger, am√©liorer un √©crit." },
      { id:"q2", title:"La Clef de la Confiance", done:false, reward:6, desc:"Oser une participation (m√™me courte)." },
      { id:"q3", title:"Le Bouclier de l‚ÄôAttention", done:false, reward:6, desc:"Tenir une phase de travail sans distraction." }
    ],
    boss: deepCopy(boss),
    achievements: deepCopy(achievements),
    periods: deepCopy(periods),
    meta: { updatedAt: nowFr(), finalShown: false },
    battle: null
  };
}

function ensureDefaults(s){
  const st = (s && typeof s==="object") ? s : {};
  if(typeof st.zoneId !== "string") st.zoneId = zones[0].id;
  if(!Array.isArray(st.party) || st.party.length===0) st.party = makeInitialParty();
  if(!Array.isArray(st.quests)) st.quests = defaultState().quests;
  if(!st.boss) st.boss = deepCopy(boss);
  if(!Array.isArray(st.achievements)) st.achievements = deepCopy(achievements);
  st.periods = normalizePeriods(st);
  if(!st.meta) st.meta = { };
  if(typeof st.meta.updatedAt !== "string") st.meta.updatedAt = nowFr();
  if(typeof st.meta.finalShown !== "boolean") st.meta.finalShown = false;
  if(typeof st.louaneIntroDone !== "boolean") st.louaneIntroDone = false;
  return st;
}

function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    return ensureDefaults(JSON.parse(raw));
  }catch(e){ return null; }
}

let state = load();
ensureState();
if(!state) state = defaultState();
ensureQuestTypes();
expireRolesIfNeeded();
// --- Sync succ√®s collectifs au d√©marrage (√©vite d'ouvrir l'onglet Succ√®s) ---
ensureCollectiveGoals();
syncAchievementsFromGoals();
clampBossForSuccess();
save();
function save(){
  state.meta = state.meta || {};
  state.meta.updatedAt = nowFr();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  updatePills();
}

/* =========================
   SUCC√àS MENSUELS (3 max)
   ========================= */
function buildMonthlyAchievements(monthId){
  const packs = {
    jan: [
      { id:"jan_confiance", title:"Reprise en confiance", desc:"On se remet en route sans se d√©valoriser.", unlocked:false },
      { id:"jan_effort", title:"Effort r√©gulier", desc:"On fait le minimum s√©rieux chaque semaine.", unlocked:false },
      { id:"jan_entraide", title:"Main tendue", desc:"On aide sans se moquer, on encourage.", unlocked:false }
    ],
    feb: [
      { id:"feb_focus", title:"10 minutes focus", desc:"La classe tient un temps de concentration propre.", unlocked:false },
      { id:"feb_methode", title:"M√©thodes en place", desc:"On relit/organise avant de rendre.", unlocked:false },
      { id:"feb_calme", title:"Climat apais√©", desc:"Moins d‚Äôagitation, plus d‚Äô√©coute.", unlocked:false }
    ],
    mar: [
      { id:"mar_oral", title:"Oser participer", desc:"Plus de prises de parole (m√™me courtes).", unlocked:false },
      { id:"mar_erreur", title:"Droit √† l‚Äôerreur", desc:"On tente, on corrige, on progresse.", unlocked:false },
      { id:"mar_courage", title:"Courage collectif", desc:"On encourage ceux qui osent.", unlocked:false }
    ],
    apr: [
      { id:"apr_regu", title:"R√©gularit√©", desc:"On tient le cap malgr√© la fatigue.", unlocked:false },
      { id:"apr_soin", title:"Travail soign√©", desc:"On am√©liore la pr√©sentation, l‚Äô√©criture.", unlocked:false },
      { id:"apr_soutien", title:"Soutien d‚Äô√©quipe", desc:"On se motive quand √ßa baisse.", unlocked:false }
    ],
    may: [
      { id:"may_relire", title:"Relire avant de rendre", desc:"Relecture syst√©matique (consignes, accords, ponctuation).", unlocked:false },
      { id:"may_rigueur", title:"Rigueur", desc:"On va au bout, on v√©rifie.", unlocked:false },
      { id:"may_autonomie", title:"Autonomie", desc:"On se d√©brouille avec m√©thode avant de demander.", unlocked:false }
    ],
    jun: [
      { id:"jun_union", title:"Union finale", desc:"La classe agit comme une vraie √©quipe.", unlocked:false },
      { id:"jun_confiance", title:"Confiance", desc:"On ose, on pers√©v√®re, on progresse.", unlocked:false },
      { id:"jun_fierte", title:"Fiert√©", desc:"On finit l‚Äôann√©e la t√™te haute.", unlocked:false }
    ]
  };

  return packs[monthId] ? packs[monthId] : packs.jan;
}


// ---------- AUDIO WHOOSH ----------
let audioCtx = null;
function initAudio(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}
function playWhoosh(){
  try{
    initAudio();
    const t0 = audioCtx.currentTime;
    const bufferSize = 2 * audioCtx.sampleRate;
    const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const output = noiseBuffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) output[i] = Math.random() * 2 - 1;

    const noise = audioCtx.createBufferSource();
    noise.buffer = noiseBuffer;

    const filter = audioCtx.createBiquadFilter();
    filter.type = "bandpass";
    filter.frequency.setValueAtTime(900, t0);
    filter.frequency.exponentialRampToValueAtTime(240, t0 + 0.18);

    const gain = audioCtx.createGain();
    gain.gain.setValueAtTime(0.0001, t0);
    gain.gain.exponentialRampToValueAtTime(0.35, t0 + 0.03);
    gain.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.22);

    noise.connect(filter);
    filter.connect(gain);
    gain.connect(audioCtx.destination);

    noise.start(t0);
    noise.stop(t0 + 0.23);
  }catch(e){}
}

// ---------- Cin√©matique + lore ----------
function pickLore(){
  if(!state.louaneIntroDone){
    state.louaneIntroDone = true;
    save();
    return "Une nouvelle h√©ro√Øne rejoint le groupe : Louane.";
  }
  return loreLines[Math.floor(Math.random()*loreLines.length)];
}

function showCinematic(zone){
  const map = document.getElementById("map");
  if(!map) return;

  let overlay = map.querySelector(".cinematic");
  if(!overlay){
    overlay = document.createElement("div");
    overlay.className = "cinematic";
    overlay.innerHTML = '<div class="cinematicCard">'
      + '<h3 class="cinematicTitle"></h3>'
      + '<p class="cinematicDesc"></p>'
      + '<p class="cinematicLore"></p>'
      + '</div>';
    map.appendChild(overlay);
  }

  overlay.querySelector(".cinematicTitle").textContent = zone.name;
  overlay.querySelector(".cinematicDesc").textContent = zone.desc;
  overlay.querySelector(".cinematicLore").textContent = "‚ú¶ " + pickLore();

  overlay.classList.add("show");
  window.clearTimeout(showCinematic._t);
  showCinematic._t = window.setTimeout(()=>overlay.classList.remove("show"), 1500);
}

function cameraMoveTo(zone){
  const cam = document.getElementById("mapCam");
  const map = document.getElementById("map");
  if(!cam || !map) return;

  // Pan calcul√© en fonction de la taille r√©elle de la carte (stable sur mobile / GitHub Pages)
  const rect = map.getBoundingClientRect();
  const cx = Number(zone.x)||50, cy = Number(zone.y)||50;

  const panX = (50 - cx) / 100 * rect.width  * 0.55;
  const panY = (50 - cy) / 100 * rect.height * 0.55;

  cam.style.transform = `translate3d(${panX}px, ${panY}px, 0) scale(1.06)`;
  requestAnimationFrame(clampMapNodes);
  window.clearTimeout(cameraMoveTo._t);
  cameraMoveTo._t = window.setTimeout(()=>{ cam.style.transform="translate3d(0,0,0) scale(1)"; requestAnimationFrame(clampMapNodes); }, 1500);
}


function clampMapNodes(){
  const map = document.getElementById("map");
  const cam = document.getElementById("mapCam");
  if(!map || !cam) return;
  const mapRect = map.getBoundingClientRect();
  const pad = 10;
  cam.querySelectorAll(".node").forEach(node=>{
    // reset default centering
    node.style.transform = "translate(-50%, -50%)";
    const r = node.getBoundingClientRect();
    let dx = 0, dy = 0;
    if(r.left < mapRect.left + pad) dx += (mapRect.left + pad) - r.left;
    if(r.right > mapRect.right - pad) dx -= r.right - (mapRect.right - pad);
    if(r.top < mapRect.top + pad) dy += (mapRect.top + pad) - r.top;
    if(r.bottom > mapRect.bottom - pad) dy -= r.bottom - (mapRect.bottom - pad);
    if(dx || dy){
      node.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
    }
  });
}
// ---------- Final event overlay ----------
function triggerFinalEvent(){
  try{ showBossVictoryOverlay({title:'üéâ Boss vaincu !', message:'Victoire ! La classe a vid√© la barre du boss collectif.'}); }catch(e){}

  if(state.meta && state.meta.finalShown) return;
  state.meta = state.meta || {};
  state.meta.finalShown = true;
  save();
  const cine = document.getElementById("cine");
  const t = document.getElementById("cineText");
  if(!cine || !t) return;
  t.textContent = finalLines[Math.floor(Math.random()*finalLines.length)];
  cine.classList.add("show");
}
function closeCine(){
  const cine = document.getElementById("cine");
  if(cine) cine.classList.remove("show");
}

// ---------- UI ----------
const viewEl = document.getElementById("view");
const navBtns = Array.from(document.querySelectorAll(".nav button[data-view]"));
let currentView = "map";

function updatePills(){
  const zone = zones.find(z => z.id === state.zoneId);
  document.getElementById("pillChapter").textContent = "Zone : " + (zone ? zone.name : "‚Äî");
  document.getElementById("pillTeam").textContent = "√âquipe : " + (state.party ? state.party.length : 0) + " h√©ros";
  let totalXP = 0;
  for(let i=0;i<(state.party||[]).length;i++) totalXP += Number(state.party[i].xp)||0;
  document.getElementById("pillXP").textContent = "XP total : " + totalXP;
}

function setView(v){
  currentView = v;
  navBtns.forEach(b=>b.classList.toggle("active", b.dataset.view === v));
  render(v);
}

navBtns.forEach(b=>b.addEventListener("click", e=>{e.preventDefault(); e.stopPropagation(); setView(b.dataset.view);}));

document.getElementById("resetBtn").addEventListener("click", function(){
  if(confirm("R√©initialiser la progression ?")){
    state = defaultState();
    save();
    setView("map");
  }
});

document.getElementById("exportBtn").addEventListener("click", function(){
  // Export simple et fiable (inclut d√©j√† boss / achievements / periods pr√©sents dans state)
  let txt = "";
  try{
    // On met √† jour l'horodatage avant export
    state.meta = state.meta || {};
    state.meta.updatedAt = nowFr();
        // ‚úÖ P√©riodes mensuelles (Jan ‚Üí Juin) pour la vue √©l√®ves
    state.teamXp = (typeof state.teamXp === "number") ? state.teamXp : 0;
    state.quests = Array.isArray(state.quests) ? state.quests : [];
    state.periods = [
      { id:"jan", label:"Janvier",  goal:"Reprendre confiance", boss:"Le Doute persistant", teamXp: state.teamXp, questsDone: state.quests.filter(q=>q.done).length, notes:"" },
      { id:"feb", label:"F√©vrier",  goal:"Se concentrer",       boss:"La Dispersion",      teamXp: state.teamXp, questsDone: state.quests.filter(q=>q.done).length, notes:"" },
      { id:"mar", label:"Mars",     goal:"Oser participer",     boss:"La Peur de se tromper", teamXp: state.teamXp, questsDone: state.quests.filter(q=>q.done).length, notes:"" },
      { id:"apr", label:"Avril",    goal:"Tenir l‚Äôeffort",      boss:"La Fatigue",         teamXp: state.teamXp, questsDone: state.quests.filter(q=>q.done).length, notes:"" },
      { id:"may", label:"Mai",      goal:"√ätre rigoureux",      boss:"La Pr√©cipitation",   teamXp: state.teamXp, questsDone: state.quests.filter(q=>q.done).length, notes:"" },
      { id:"jun", label:"Juin",     goal:"Boss final",          boss:"L‚ÄôOmbre d‚ÄôOrth√©sia", teamXp: state.teamXp, questsDone: state.quests.filter(q=>q.done).length, notes:"" }
    ];

txt = JSON.stringify(state);
  }catch(e){
    console.error("Erreur export JSON :", e);
    txt = JSON.stringify(state);
  }

  // Copie presse-papier si possible, sinon affiche dans la console
  if (navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(txt).then(()=>{
      alert("‚úÖ Sauvegarde JSON copi√©e !");
    }).catch(()=>{
      console.log("SAUVEGARDE JSON:", txt);
      alert("‚ö†Ô∏è Copie refus√©e par le navigateur. JSON dans la console (F12).");
    });
  } else {
    console.log("SAUVEGARDE JSON:", txt);
    alert("‚ö†Ô∏è Presse-papier indisponible. JSON dans la console (F12).");
  }
});


document.getElementById("importBtn").addEventListener("click", ()=>document.getElementById("importField").focus());

document.getElementById("importField").addEventListener("keydown", function(e){
  if(e.key === "Enter"){
    try{
      const obj = JSON.parse(String(e.target.value || "").trim());
      state = ensureDefaults(obj);
      save();
      setView("map");
      alert("Import r√©ussi.");
    }catch(err){ alert("Import impossible : " + err.message); }
    e.target.value = "";
  }
});


function gid(){ return "g"+Date.now()+Math.random().toString(16).slice(2); }

function ensureCollectiveGoals(){
  state.collectiveGoals = Array.isArray(state.collectiveGoals) ? state.collectiveGoals : [];
  if(state.collectiveGoals.length===0){
    const presets = [
      "üî• Silence d‚Äôor (10 min focus)",
      "üß† D√©tectives du texte",
      "üéØ Contr√¥le en mode boss",
      "üí¨ Oral h√©ro√Øque",
      "üìù Copie parfaite",
    ];
    presets.forEach(t=>state.collectiveGoals.push({ id: gid(), title: t, desc:"", done:false, createdAt: new Date().toISOString(), doneAt:null }));
    save();
  }
}

function syncAchievementsFromGoals(){
  // r√©tro-compat : on publie aussi dans state.achievements pour la vue √©l√®ves
  state.achievements = Array.isArray(state.achievements) ? state.achievements : [];
  const goals = Array.isArray(state.collectiveGoals) ? state.collectiveGoals : [];
  state.achievements = goals.map(g=>({
    id: g.id,
    title: g.title || "Objectif",
    desc: g.desc || "",
    done: !!g.done
  }));
}

function clampBossForSuccess(){
  state.boss = (state.boss && typeof state.boss==="object") ? state.boss : { name:"Boss", hp:100, maxHp:100 };
  state.boss.maxHp = Number(state.boss.maxHp||state.boss.maxHP||state.boss.hpMax||100) || 100;
  state.boss.hp = Number(state.boss.hp||0);
  if(state.boss.hp<0) state.boss.hp=0;
  if(state.boss.hp>state.boss.maxHp) state.boss.hp=state.boss.maxHp;
}


function celebrateSuccess(title){
  try{
    const toast = document.getElementById("succToast");
    const sparks = document.getElementById("succSparks");
    if(toast){
      toast.textContent = "üèÜ Succ√®s d√©bloqu√© : " + (title||"Objectif");
      toast.classList.add("show");
      clearTimeout(window.__succToastT);
      window.__succToastT = setTimeout(()=>toast.classList.remove("show"), 2200);
    }
    if(sparks){
      const icons = ["‚ú®","‚≠ê","üåü","üéâ","üí•"];
      for(let i=0;i<18;i++){
        const sp = document.createElement("div");
        sp.className = "spark";
        sp.textContent = icons[Math.floor(Math.random()*icons.length)];
        sp.style.left = (10 + Math.random()*80) + "vw";
        sp.style.top = (40 + Math.random()*40) + "vh";
        sp.style.animationDelay = (Math.random()*0.2) + "s";
        sparks.appendChild(sp);
        setTimeout(()=>sp.remove(), 1400);
      }
    }
  }catch(e){}
}
function applySuccessRewards(){
  try{
    const BONUS_XP = 2;
    if(Array.isArray(state.students)){
      state.students.forEach(s=>{ s.xp = Number(s.xp||0) + BONUS_XP; });
    }
  }catch(e){}
}

function renderSuccess(){
  ensureCollectiveGoals(); syncAchievementsFromGoals(); clampBossForSuccess();
  const goals = state.collectiveGoals;
  const done = goals.filter(g=>!!g.done).length;

  viewEl.innerHTML =
    '<h2 class="sectionTitle">üèÜ Succ√®s collectifs</h2>'
    + '<p class="muted">Objectifs modulables. R√®gle : <b>-10 PV boss</b> par objectif valid√© (annuler = +10 PV).</p>'
    + '<div class="char">'
    + '  <div class="successHdr">'
    + '    <div class="tag">Progression : <b>'+done+'/'+goals.length+'</b> ‚Ä¢ Boss : <b>'+escapeHtml(state.boss.name||"Boss")+' '+state.boss.hp+'/'+state.boss.maxHp+'</b></div>'
    + '    <div class="choiceRow">'
    + '      <button class="btn" id="succCountBtn">Choisir le nombre</button>'
    + '      <button class="btn primary" id="succAddBtn">+ Ajouter</button>'
    + '    </div>'
    + '  </div>'
    + '  <div class="hr"></div>'
    + '  <div class="successList" id="succList"></div>'
    + '</div>';

  const list = document.getElementById("succList");
  goals.forEach(g=>{
    const row = document.createElement("div");
    row.className = "successRow";
    row.innerHTML =
      '<input class="chk" type="checkbox" '+(g.done?'checked':'')+' data-goal="'+escapeHtml(g.id)+'" />'
      + '<div class="successTitle '+(g.done?'done':'')+'">'+escapeHtml(g.title||"Objectif")+'</div>'
      + '<div class="choiceRow">'
      + '  <button class="btn" data-edit="'+escapeHtml(g.id)+'">‚úèÔ∏è</button>'
      + '  <button class="btn danger" data-del="'+escapeHtml(g.id)+'">üóëÔ∏è</button>'
      + '</div>';
    list.appendChild(row);
  });

  document.getElementById("succAddBtn").onclick = ()=>{
    state.collectiveGoals.push({ id: gid(), title:"Nouvel objectif", done:false, createdAt:new Date().toISOString() });
    syncAchievementsFromGoals(); syncAchievementsFromGoals(); save(); renderSuccess();
  };

  document.getElementById("succCountBtn").onclick = ()=>{
    const cur = state.collectiveGoals.length;
    const v = prompt("Nombre d‚Äôobjectifs (1 √† 30) :", String(cur));
    if(v===null) return;
    let n = Math.max(1, Math.min(30, parseInt(v,10)||cur));
    if(n===cur) return;
    if(n>cur){
      for(let i=cur+1;i<=n;i++){
        state.collectiveGoals.push({ id: gid(), title:"Objectif "+i, done:false, createdAt: new Date().toISOString() });
      }
    }else{
      if(!confirm("R√©duire supprimera les derniers objectifs. Continuer ?")) return;
      state.collectiveGoals = state.collectiveGoals.slice(0,n);
    }
    syncAchievementsFromGoals(); save(); renderSuccess();
  };

  document.querySelectorAll("[data-goal]").forEach(inp=>{
    inp.onchange = ()=>{
      const id = inp.getAttribute("data-goal");
      const goal = state.collectiveGoals.find(x=>x.id===id);
      if(!goal) return;
      const was = !!goal.done;
      goal.done = !!inp.checked;

      if(!was && goal.done){
        celebrateSuccess(goal.title);
        applySuccessRewards();

        state.boss.hp = Math.max(0, Number(state.boss.hp||0) - 10);
      }else if(was && !goal.done){
        state.boss.hp = Math.min(Number(state.boss.maxHp||100), Number(state.boss.hp||0) + 10);
      }
      if(Number(state.boss.hp)<=0){
        state.boss.hp = 0;
        state.boss.victoryStamp = state.boss.victoryStamp || new Date().toISOString();
        if(typeof triggerFinalEvent==="function"){ try{ triggerFinalEvent(); }catch(e){} }
      }
      syncAchievementsFromGoals(); save(); renderSuccess();
    };
  });

  document.querySelectorAll("[data-edit]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute("data-edit");
      const g = state.collectiveGoals.find(x=>x.id===id);
      if(!g) return;
      const t = prompt("Titre de l‚Äôobjectif :", g.title||"");
      if(t===null) return;
      g.title = String(t).trim() || g.title;
      syncAchievementsFromGoals(); save(); renderSuccess();
    };
  });

  document.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute("data-del");
      if(!confirm("Supprimer cet objectif ?")) return;
      state.collectiveGoals = state.collectiveGoals.filter(x=>x.id!==id);
      syncAchievementsFromGoals(); save(); renderSuccess();
    };
  });
}

function render(view){
  updatePills();
  if(view==="map") return renderMap();
  if(view==="roster") return renderRoster();
  if(view==="quests") return renderQuests();
  if(view==="battle") return renderBattle();
  if(view==="gm") return renderGM();
  if(view==="success") return renderSuccess();
}

// ---------- Views ----------
function renderMap(){
  const zone = zones.find(z=>z.id===state.zoneId);
  viewEl.innerHTML =
    '<h2 class="sectionTitle">üó∫Ô∏è Carte d‚ÄôOrth√©sia</h2>'
    + '<p class="muted">Clique sur une zone pour voyager (cin√©matique + whoosh + zoom cam√©ra).</p>'
    + '<div class="map" id="map"><div class="mapCam" id="mapCam"></div></div>'
    + '<div class="hr"></div>'
    + '<div class="row">'
    + '  <button class="btn primary" id="grantXpBtn">+ Donner de l‚ÄôXP (effort collectif)</button>'
    + '  <button class="btn" id="healBtn">Soigner l‚Äô√©quipe (repos)</button>'
    + '</div>'
    + '<p class="mini"><b>Zone actuelle :</b> ' + (zone ? zone.name : "‚Äî") + ' ‚Äî ' + (zone ? zone.desc : "") + '</p>';

  const mapCam = document.getElementById("mapCam");

  // Routes (carte) : chemins entre zones (en pourcent)
  const edges = [
    ["plaine","foret"],
    ["plaine","cite"],
    ["plaine","mont"],
    ["mont","sanct"],
    ["foret","sanct"]
  ];
  const getZone = (id)=>zones.find(z=>z.id===id);
  const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
  svg.setAttribute("class","mapSvg");
  svg.setAttribute("viewBox","0 0 100 100");
  svg.setAttribute("preserveAspectRatio","none");
  edges.forEach(([a,b])=>{
    const za = getZone(a), zb = getZone(b);
    if(!za||!zb) return;
    const path = document.createElementNS("http://www.w3.org/2000/svg","path");
    // petit arc doux
    const mx = (za.x+zb.x)/2;
    const my = (za.y+zb.y)/2 - 10;
    path.setAttribute("d", `M ${za.x} ${za.y} Q ${mx} ${my} ${zb.x} ${zb.y}`);
    path.setAttribute("fill","none");
    path.setAttribute("stroke","rgba(255,255,255,.18)");
    path.setAttribute("stroke-width","0.9");
    path.setAttribute("stroke-linecap","round");
    path.setAttribute("stroke-dasharray","3 4");
    svg.appendChild(path);
  });
  mapCam.appendChild(svg);

  // Boussole d√©corative
  const mapEl = document.getElementById("map");
  if(mapEl && !mapEl.querySelector(".compass")){
    const c = document.createElement("div");
    c.className = "compass";
    c.innerHTML = '<div class="needle">üß≠</div>';
    mapEl.appendChild(c);
  }
  zones.forEach(z=>{
    const div = document.createElement("div");
    div.className = "node" + (z.id===state.zoneId ? " selected" : "");
    const xPct = Number(z.x);
    const yPct = Number(z.y);
    const safeX = Math.min(88, Math.max(18, xPct));
    const safeY = Math.min(88, Math.max(12, yPct));
    div.style.left = safeX + "%";
    div.style.top  = safeY + "%";

    // Ancrage intelligent pour √©viter le d√©coupage sur les bords
    (function(){
      const x = safeX;
      const y = safeY;
      const tx = (x <= 22) ? "0%" : (x >= 85) ? "-100%" : "-50%";
      const ty = (y <= 15) ? "0%" : (y >= 85) ? "-100%" : "-50%";
      div.style.setProperty("--tx", tx);
      div.style.setProperty("--ty", ty);
    })();
    div.style.animationDelay = (Math.random()*0.12).toFixed(2) + "s";
          const emblem = zoneIcon(z.id);
      div.innerHTML =
        '<div class="nodeHead">'
          + '<div class="nodeTitle">'
            + '<div class="emblem">'+emblem+'</div>'
            + '<div>'
              + '<h3>'+z.name+'</h3>'
              + '<small>'+z.desc+'</small>'
            + '</div>'
          + '</div>'
        + '</div>'
        + '<span class="badge">'+(z.id===state.zoneId ? "Vous √™tes ici" : "Voyager")+'</span>';

    div.addEventListener("click", function(){
      if(state.zoneId === z.id) return;
      playWhoosh();
      state.zoneId = z.id;
      save();
      showCinematic(z);
      cameraMoveTo(z);
      render("map");
    });
    mapCam.appendChild(div);
  });

  // Ajuste les cartes pour √©viter qu'elles soient coup√©es sur les bords (ex: Plaine de la Compr√©hension)
  requestAnimationFrame(clampMapNodes);
  if(!window.__orthesiaClampBound){
    window.__orthesiaClampBound = true;
    window.addEventListener('resize', ()=>requestAnimationFrame(clampMapNodes));
  }

  document.getElementById("grantXpBtn").addEventListener("click", function(){
    const n = Number(prompt("Combien d‚ÄôXP donner √† CHAQUE √©l√®ve ? (1 √† 5)", "2"));
    if(!isFinite(n) || n<=0) return;
    const add = Math.min(5, Math.max(1, n));
    state.party.forEach(p=>p.xp = (Number(p.xp)||0) + add);
    save();
    render("map");
  });

  document.getElementById("healBtn").addEventListener("click", function(){
    state.party.forEach(p=>p.hp = Math.min(p.hpMax, (Number(p.hp)||0) + 6));
    save();
    render("map");
  });
}


function renderRoster(){
  viewEl.innerHTML =
    '<h2 class="sectionTitle">üë• √âquipe de h√©ros</h2>'
    + '<p class="muted">XP / √©nergie + Voies du Fran√ßais (clic = assigner / retirer un r√¥le, visible aussi c√¥t√© üéÆ Ma√Ætre du jeu).</p>'
    + '<div class="list" id="list"></div>';

  const list = document.getElementById("list");

  state.party.forEach(p=>{
    const lvl = levelFromXP(p.xp);
    const next = xpToNext(lvl+1);
    const prev = xpToNext(lvl);
    const span = Math.max(1, next - prev);
    const prog = Math.min(100, Math.round(((p.xp - prev)/span)*100));

    // üéØ Qu√™te (type -> texte)
    if(typeof p.questType !== "string" || !p.questType) p.questType = "methode";
    p.quest = questTextFor(p.questType);

    const avatarHTML = p.portrait
      ? `<div class="avatarBox"><img src="${p.portrait}" alt="${escapeHtml(p.name)}" onerror="this.parentNode.innerHTML='<span class=&quot;avatarFallback&quot;>${escapeHtml(p.icon)}</span>'"></div>`
      : `<div class="avatarBox"><span class="avatarFallback">${escapeHtml(p.icon)}</span></div>`;

    const div = document.createElement("div");
    div.className = "char";
    div.innerHTML =
      '<div class="charTop">'
      + ' <div style="display:flex;gap:10px;align-items:center">'
      +    avatarHTML
      + '   <div>'
      + '     <h4>'+p.name+'</h4>'
      + '     <div class="tag">'+p.cls+' ‚Ä¢ Qualit√© : '+p.trait+'</div>'
      + '   </div>'
      + ' </div>'
      + ' <div class="tag">Niv. '+lvl+'</div>'
      + '</div>'
      + '<div class="bar barXp"><div style="width:'+prog+'%"></div></div>'
      + '<div class="stats">'
      + ' <span>XP : <b>'+p.xp+'</b></span>'
      + ' <span>Prochain niv. : <b>'+(next===999 ? "‚Äî" : next)+'</b></span>'
      + '</div>'
      + '<div class="mini"><b>üéØ Qu√™te :</b></div>'+ '<select class="select questSel" data-quest-sel="1"></select>'+ '<div class="mini questTxt"><b>'+escapeHtml(p.quest)+'</b></div>'
      + '<div class="choiceRow">'
      + ' <button class="btn" data-act="xp1">+1 XP</button>'
      + ' <button class="btn" data-act="xp2">+2 XP</button>'
      + ' <button class="btn" data-act="heal">+5 √©nergie</button>'
      + '</div>';

    // üéØ Menu : type de qu√™te (par √©l√®ve)
    const qSel = div.querySelector(".questSel");
    const qTxtEl = div.querySelector(".questTxt");
    if(qSel){
      qSel.innerHTML = (QUEST_TYPES||[]).map(t=>`<option value="${t.id}">${t.label}</option>`).join("");
      qSel.value = p.questType || "methode";
      qSel.addEventListener("change", ()=>{
        p.questType = qSel.value;
        p.quest = questTextFor(p.questType);
        if(qTxtEl) qTxtEl.innerHTML = "<b>"+escapeHtml(p.quest)+"</b>";
        save();
        // pas besoin de render() complet : l‚Äô√©l√®ve est d√©j√† √† l‚Äô√©cran
      });
    }


    // --- Voies / R√¥les (clic = toggle) ---
    ensureRoleArrays();
    const rolesForStudent = (state.rolesActive||[]).filter(r=>r.studentId===p.id);

    // Affichage des r√¥les actifs (tag)
    if(rolesForStudent.length){
      const roleLines = rolesForStudent.map(r=>{
        const axis = roleAxisById(r.roleId);
        return 'üßô <b>'+(r.roleLabel||r.roleId)+'</b>' + (axis?(' <span class="tag" style="margin-left:6px">('+escapeRoleHtml(axis)+')</span>'):'')
             + ' <span class="tag" style="margin-left:6px">jusqu‚Äôau '+frDate(r.endAt)+'</span>';
      }).join("<br/>");

      const roleTag = document.createElement("div");
      roleTag.className = "tag";
      roleTag.style.marginTop = "8px";
      roleTag.innerHTML = roleLines;

      const flex = div.querySelector(".charTop > div");
      const nameBox = flex ? flex.querySelector("div:last-child") : null;
      const qTag = nameBox ? nameBox.querySelector(".tag") : null;
      if(qTag) qTag.insertAdjacentElement("afterend", roleTag);
    }

    // Chips
    const chipsWrap = document.createElement("div");
    chipsWrap.className = "choiceRow";
    chipsWrap.style.marginTop = "10px";

    const label = document.createElement("div");
    label.className = "mini";
    label.innerHTML = "<b>üó∫Ô∏è Voies du Fran√ßais :</b> (clic pour assigner / retirer)";
    div.appendChild(label);
    div.appendChild(chipsWrap);

    (ROLE_TYPES||[]).forEach(rt=>{
      const isOn = rolesForStudent.some(r=>r.roleId===rt.id);
      const chip = document.createElement("span");
      chip.className = "roleChip" + (isOn ? " on" : "");
      chip.textContent = rt.label;
      chip.title = (rt.axis ? (rt.axis + " ‚Äî ") : "") + (rt.description || rt.desc || "");
      chip.addEventListener("click", ()=>{
        ensureRoleArrays();
        // si d√©j√† actif pour cet √©l√®ve : retirer (sans r√©compense)
        const existing = (state.rolesActive||[]).find(r=>r.studentId===p.id && r.roleId===rt.id);
        if(existing){
          removeRole(existing.id);
        }else{
          assignRole(p.id, rt.id);
        }
        save();
        render("roster");
        // aussi garder l‚Äôonglet MJ coh√©rent si l‚Äôutilisateur y retourne
      });
      chipsWrap.appendChild(chip);
    });

    // Boutons XP / heal
    const btns = div.querySelectorAll("button[data-act]");
    btns.forEach(btn=>btn.addEventListener("click", ()=>{
      const act = btn.getAttribute("data-act");
      if(act==="xp1") p.xp += 1;
      if(act==="xp2") p.xp += 2;
      if(act==="heal") p.hp = Math.min(p.hpMax, p.hp + 5);
      save();
      render("roster");
    }));

    list.appendChild(div);
  });
}


function renderQuests(){
  viewEl.innerHTML =
    '<h2 class="sectionTitle">üìú Qu√™tes</h2>'
    + '<p class="muted">Coche une qu√™te quand la classe la r√©ussit. R√©compense : XP pour tous.</p>'
    + '<div id="qwrap"></div>'
    + '<div class="hr"></div>'
    + '<div class="row">'
    + ' <button class="btn primary" id="addQuestBtn">+ Ajouter une qu√™te</button>'
    + ' <button class="btn" id="rewardDoneBtn">Donner r√©compense des qu√™tes faites</button>'
    + '</div>';

  const qwrap = document.getElementById("qwrap");
  state.quests.forEach(q=>{
    const div = document.createElement("div");
    div.className = "char";
    div.innerHTML =
      '<div class="charTop">'
      + ' <div>'
      + '  <h4>'+q.title+'</h4>'
      + '  <div class="tag">'+q.desc+'</div>'
      + ' </div>'
      + ' <div class="tag">R√©compense : '+q.reward+' XP</div>'
      + '</div>'
      + '<div class="choiceRow">'
      + ' <button class="btn '+(q.done ? "primary": "")+'" data-t="toggle">'+(q.done ? "‚úÖ Accomplie" : "‚òê √Ä faire")+'</button>'
      + ' <button class="btn danger" data-t="del">Supprimer</button>'
      + '</div>';

    div.querySelector('[data-t="toggle"]').addEventListener("click", ()=>{ q.done = !q.done; save(); render("quests"); });
    div.querySelector('[data-t="del"]').addEventListener("click", ()=>{
      if(confirm("Supprimer cette qu√™te ?")){
        state.quests = state.quests.filter(x=>x.id !== q.id);
        save();
        render("quests");
      }
    });
    qwrap.appendChild(div);
  });

  document.getElementById("addQuestBtn").addEventListener("click", function(){
    const title = prompt("Titre de la qu√™te ?", "La Plume du Courage");
    if(!title) return;
    const desc = prompt("Description courte ?", "√âcrire un paragraphe structur√© et le relire.");
    const reward = Number(prompt("R√©compense XP (1 √† 10) ?", "6"));
    const r = Math.max(1, Math.min(10, isFinite(reward) ? reward : 6));
    state.quests.push({ id:"q"+Date.now(), title, desc: desc||"", reward:r, done:false });
    save();
    render("quests");
  });

  document.getElementById("rewardDoneBtn").addEventListener("click", function(){
    const done = state.quests.filter(q=>q.done);
    if(done.length===0) return alert("Aucune qu√™te accomplie pour l‚Äôinstant.");
    const total = done.reduce((a,q)=>a+(Number(q.reward)||0),0);
    state.party.forEach(p=>p.xp += total);
    alert("R√©compense donn√©e : "+total+" XP √† chaque √©l√®ve.");
    save();
    render("quests");
  });
}

// ---------- Battle ----------
function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

function startNewBattle(){
  const enemy = deepCopy(enemies[Math.floor(Math.random()*enemies.length)]);
  state.battle = {
    enemy,
    enemyHp: enemy.hp,
    turnIndex: 0,
    shield: 0,
    log: [
      "<b>Un obstacle appara√Æt :</b> " + enemy.name + ".",
      "Votre classe respire‚Ä¶ et se pr√©pare."
    ]
  };
}

function playTurn(actionId){
  const b = state.battle;
  const leader = state.party[b.turnIndex % state.party.length];
  let action = actions[0];
  for(let i=0;i<actions.length;i++) if(actions[i].id === actionId) action = actions[i];

  const dmg = rand(action.dmg[0], action.dmg[1]);
  b.enemyHp = Math.max(0, b.enemyHp - dmg);

  if(action.shield) b.shield = Math.min(6, b.shield + action.shield);

  const heal = rand(action.heal[0], action.heal[1]);
  if(heal > 0){
    for(let i=0;i<heal;i++) {
      let target = state.party[0];
      for(let j=1;j<state.party.length;j++) if(state.party[j].hp < target.hp) target = state.party[j];
      target.hp = Math.min(target.hpMax, target.hp + 1);
    }
  }

  b.log.push("<b>"+leader.name+"</b> utilise <b>"+action.label+"</b> : -"+dmg+" √©nergie √† "+b.enemy.name+(heal>0 ? ", +"+heal+" √©nergie √† l‚Äô√©quipe" : "")+".");

  if(b.enemyHp <= 0){
    const reward = 4;
    state.party.forEach(p=>{ p.xp += reward; p.hp = Math.min(p.hpMax, p.hp + 3); });
    b.log.push("<b>Victoire !</b> R√©compense : <b>"+reward+" XP</b> pour chaque h√©ros.");
    state.battle = null;
    return;
  }

  const target = state.party[Math.floor(Math.random()*state.party.length)];
  const mitigated = Math.max(1, (Number(b.enemy.atk)||1) - b.shield);
  target.hp = Math.max(0, target.hp - mitigated);
  b.log.push(b.enemy.name + " riposte : <b>" + target.name + "</b> perd " + mitigated + " √©nergie.");

  b.shield = Math.max(0, b.shield - 1);
  if(target.hp === 0){ target.hp = 6; b.log.push("<b>"+target.name+"</b> reprend son souffle (retour √† 6 √©nergie). Ici, on repart."); }

  b.turnIndex += 1;
  if(b.log.length > 70) b.log = b.log.slice(b.log.length - 70);
}

function renderBattle(){
  if(!state.battle) startNewBattle();
  const b = state.battle;

  viewEl.innerHTML =
    '<h2 class="sectionTitle">‚öîÔ∏è Combat symbolique</h2>'
    + '<p class="muted">On ‚Äúcombat‚Äù des obstacles : doute, dispersion, peur. Les actions restent positives.</p>'
    + '<div class="battleGrid">'
    + ' <div class="char">'
    + '  <h4>üëë √âquipe</h4>'
    + '  <div class="tag">Chef du tour : <b id="leaderName"></b></div>'
    + '  <div class="hr"></div>'
    + '  <div class="tag">Action du tour :</div>'
    + '  <select class="select" id="actionSel"></select>'
    + '  <div class="choiceRow">'
    + '   <button class="btn primary" id="actBtn">Jouer le tour</button>'
    + '   <button class="btn" id="newBattleBtn">Nouveau combat</button>'
    + '  </div>'
    + ' </div>'
    + ' <div class="char">'
    + '  <h4>üëæ Ennemi : '+b.enemy.name+'</h4>'
    + '  <div class="tag">'+b.enemy.msg+'</div>'
    + '  <div class="hr"></div>'
    + '  <h4>üì£ Journal</h4>'
    + '  <div class="log" id="log"></div>'
    + ' </div>'
    + '</div>';

  const leader = state.party[b.turnIndex % state.party.length];
  document.getElementById("leaderName").textContent = leader.name;

  const sel = document.getElementById("actionSel");
  actions.forEach(a=>{
    const opt = document.createElement("option");
    opt.value = a.id;
    opt.textContent = a.label + " ‚Äî " + a.desc;
    sel.appendChild(opt);
  });

  const log = document.getElementById("log");
  b.log.forEach(line=>{ const d=document.createElement("div"); d.innerHTML=line; log.appendChild(d); });
  log.scrollTop = log.scrollHeight;

  document.getElementById("actBtn").addEventListener("click", function(){
    playTurn(sel.value);
    save();
    render("battle");
  });

  document.getElementById("newBattleBtn").addEventListener("click", function(){
    startNewBattle();
    save();
    render("battle");
  });
}

// ---------- GM ----------
function renderGM(){
  const hpPct = Math.max(0, Math.min(100, Math.round((state.boss.hp/state.boss.hpMax)*100)));
  viewEl.innerHTML =
    '<h2 class="sectionTitle">üéÆ Ma√Ætre du jeu</h2>'
    + '<div class="char">'
    + ' <h4>üëπ Boss collectif</h4>'
    + ' <div class="tag"><b>'+state.boss.name+'</b></div>'
    + ' <div class="bar" style="margin-top:10px"><div style="width:'+hpPct+'%; background: linear-gradient(90deg, rgba(157,255,176,.95), rgba(255,231,136,.85), rgba(255,139,161,.9))"></div></div>'
    + ' <div class="mini">PV : <b>'+state.boss.hp+'</b> / '+state.boss.hpMax+'</div>'
    + ' <div class="choiceRow">'
    + '   <button class="btn" id="boss5">-5 PV</button>'
    + '   <button class="btn" id="boss10">-10 PV</button>'
    + '   <button class="btn danger" id="bossReset">Reset</button>'
    + ' </div>'
    + '</div>'
    + '<div class="hr"></div>'
    + '<h3 style="margin:0 0 8px;font-size:14px">üèÖ Succ√®s collectifs</h3>'
    + renderAchievementsGM()
    + '<div class="hr"></div>'
    + '<h3 style="margin:0 0 8px;font-size:14px">üßô R√¥les</h3>'
    + renderRolesGM()
    + '<div class="hr"></div>'
    + '<h3 style="margin:0 0 8px;font-size:14px">üèÜ Progression par p√©riode</h3>'
    + renderPeriodsGM();

  document.getElementById("boss5").onclick = ()=>bossDamage(5);
  document.getElementById("boss10").onclick = ()=>bossDamage(10);
  document.getElementById("bossReset").onclick = ()=>bossReset();


  // R√¥les : remplir listes + bind
  const stSel = document.getElementById("roleStudentSel");
  const rtSel = document.getElementById("roleTypeSel");
  if(stSel && rtSel){
    stSel.innerHTML = "";
    (state.party||[]).forEach(p=>{
      const o=document.createElement("option");
      o.value = p.id;
      o.textContent = p.name;
      stSel.appendChild(o);
    });
    rtSel.innerHTML = "";
    ROLE_TYPES.forEach(r=>{
      const o=document.createElement("option");
      o.value = r.id;
      o.textContent = r.label + " ‚Äî " + r.desc;
      rtSel.appendChild(o);
    });
    const btn = document.getElementById("assignRoleBtn");
    if(btn){
      btn.onclick = ()=>{
        assignRole(stSel.value, rtSel.value);
        render("gm");
      };
      btn.disabled = !canAssignMoreRoles();
      btn.title = btn.disabled ? "Max r√¥les actifs atteint" : "";
    }
  }

  // D√©l√©gation des clics (Retirer / Cl√¥turer)
  if(!window.__roleActionsBound){
    window.__roleActionsBound = true; // roleActionsBound
    document.addEventListener("click", (e)=>{
      const b = e.target.closest("[data-role-action]");
      if(!b) return;
      const act = b.getAttribute("data-role-action");
      const id = b.getAttribute("data-role-id");
      if(!id) return;
      if(act==="remove"){ removeRole(id); render("gm"); }
      if(act==="close"){ closeRole(id); render("gm"); }
    }, { capture:true });
  }

}

function bossDamage(n){
  state.boss.hp = Math.max(0, state.boss.hp - n);
  state.boss.log = state.boss.log || [];
  state.boss.log.push("Le boss perd "+n+" PV.");
  save();
  if(state.boss.hp === 0) triggerFinalEvent();
  render("gm");
}

function bossReset(){
  if(!confirm("R√©initialiser le boss ?")) return;
  state.boss.hp = state.boss.hpMax;
  state.boss.log = ["Le boss revient plus fort‚Ä¶"];
  state.meta.finalShown = false;
  save();
  render("gm");
}

function renderAchievementsGM(){
  let html = '<div>';
  for(let i=0;i<state.achievements.length;i++) {
    const a = state.achievements[i];
    html += '<div class="char" style="margin-bottom:10px">'
      + '<div class="charTop">'
      + ' <div><h4>'+a.title+'</h4><div class="tag">'+a.desc+'</div></div>'
      + ' <div class="tag">'+(a.unlocked ? '‚úÖ D√©bloqu√©' : '‚òê √Ä d√©bloquer')+'</div>'
      + '</div>'
      + '<div class="choiceRow">'
      + (a.unlocked
          ? '<button class="btn danger" onclick="toggleAchievement('+i+',false)">Annuler</button>'
          : '<button class="btn primary" onclick="toggleAchievement('+i+',true)">D√©bloquer</button>')
      + '</div>'
      + (a.unlocked && a.date ? '<div class="mini">D√©bloqu√© le : <b>'+a.date+'</b></div>' : '')
      + '</div>';
  }
  html += '</div>';
  return html;
}

function toggleAchievement(i, val){
  const a = state.achievements[i];
  a.unlocked = val;
  a.date = val ? nowFr() : "";
  save();
  render("gm");
}

function renderPeriodsGM(){
  let html = "";
  for(let i=0;i<state.periods.length;i++) {
    const p = state.periods[i];
    html += '<div class="char" style="margin-bottom:10px">'
      + '<div><b>'+p.label+'</b> <span class="tag">('+p.dateRange+')</span></div>'
      + '<div class="mini">XP √©quipe : <input type="number" value="'+p.teamXp+'" onchange="updatePeriod('+i+',this.value,\'teamXp\')"></div>'
      + '<div class="mini">Qu√™tes : <input type="number" value="'+p.questsDone+'" onchange="updatePeriod('+i+',this.value,\'questsDone\')"></div>'
      + '<div class="mini">Notes :</div>'
      + '<textarea class="select" style="min-height:90px" onchange="updatePeriod('+i+',this.value,\'notes\')">'+(p.notes||"")+'</textarea>'
      + '</div>';
  }
  return html;
}

function updatePeriod(i,val,key){
  if(key==="notes") state.periods[i][key] = val;
  else state.periods[i][key] = Number(val)||0;
  save();
}

// ---------- Start ----------
updatePills();
setView("map");
save();
</script>

<div class="victoryOverlay" id="victoryOverlay">
  <div class="victoryCard">
    <div id="confettiWrap"></div>
    <h3 id="victoryTitle">üéâ Boss vaincu !</h3>
    <p id="victoryMsg">Bravo ! La classe a vaincu le boss collectif.</p>
    <div class="row" style="margin-top:12px;justify-content:flex-end">
      <button class="btn primary" id="victoryClose">Continuer</button>
    </div>
  </div>
</div>

</body>
</html>
