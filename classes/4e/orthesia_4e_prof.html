<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Le Royaume d‚ÄôOrth√©sia ‚Äî 4e</title>
<style>

  :root{
    --bg:#0b1020;
    --panel:#121a33;
    --panel2:#0f1730;
    --text:#f5f5f5;
    --muted:#c9c9c9;
    --accent:#8bd3ff;
    --good:#9dffb0;
    --line:rgba(255,255,255,.12);
  }
  *{box-sizing:border-box}
body
<script>
(function () {
  const PASSWORD = "prof2024"; // üîê √† changer
  const KEY = "orthesia_prof_access";

  function askPassword() {
    let pass = prompt("üîí Acc√®s r√©serv√© ‚Äì Mot de passe :");
    if (pass === PASSWORD) {
      localStorage.setItem(KEY, "ok");
      return true;
    } else {
      alert("Mot de passe incorrect.");
      return false;
    }
  }

  // V√©rification √† l'ouverture
  if (localStorage.getItem(KEY) !== "ok") {
    if (!askPassword()) {
      document.body.innerHTML = "<h2 style='text-align:center;margin-top:20vh;'>Acc√®s refus√©</h2>";
      throw new Error("Acc√®s refus√©");
    }
  }
})();
</script>

  
  {
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: radial-gradient(1200px 700px at 20% 10%, #18214a 0%, var(--bg) 55%),
                radial-gradient(900px 600px at 90% 30%, #1a3b3b 0%, rgba(0,0,0,0) 60%);
    color:var(--text);
  }
  header{
    padding:18px 18px 10px;
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    border-bottom:1px solid var(--line);
    background: linear-gradient(180deg, rgba(18,26,51,.9), rgba(18,26,51,.35));
    position: sticky; top:0;
    backdrop-filter: blur(8px);
    z-index: 10;
  }
  .title{display:flex; flex-direction:column; gap:2px}
  .title h1{margin:0; font-size:16px; letter-spacing:.2px}
  .title small{color:var(--muted)}
  .pillrow{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
  .pill{
    padding:6px 10px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.06);
    border-radius:999px;
    color:var(--text);
    font-size:12px;
  }

  main{padding:18px; max-width:1100px; margin:0 auto}
  .grid{display:grid; grid-template-columns: 280px 1fr; gap:14px}
  @media (max-width:900px){ .grid{grid-template-columns:1fr} }

  .card{
    border:1px solid var(--line);
    background: linear-gradient(180deg, rgba(18,26,51,.92), rgba(15,23,48,.88));
    border-radius:16px;
    padding:14px;
    box-shadow: 0 18px 50px rgba(0,0,0,.35);
  }
  .nav button{
    width:100%;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.06);
    color:var(--text);
    cursor:pointer;
    text-align:left;
    margin-bottom:8px;
    transition:.15s transform ease, .15s background ease;
  }
  .nav button:hover{transform: translateY(-1px); background: rgba(255,255,255,.09)}
  .nav button.active{
    background: rgba(139,211,255,.16);
    border-color: rgba(139,211,255,.35);
  }
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .btn{
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.06);
    color:var(--text);
    cursor:pointer;
  }
  .btn.primary{
    background: rgba(139,211,255,.16);
    border-color: rgba(139,211,255,.35);
  }
  .btn.danger{
    background: rgba(255,139,161,.14);
    border-color: rgba(255,139,161,.3);
  }
  .sectionTitle{margin:0 0 8px; font-size:14px}
  .muted{color:var(--muted); font-size:13px; line-height:1.35}
  .mini{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.35}
  .hr{height:1px; background:var(--line); margin:12px 0}
  .select{
    width:100%;
    padding:10px;
    border-radius:12px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.06);
    color:var(--text);
    margin-top:8px;
  }
  input.select::placeholder{color: rgba(255,255,255,.45)}

  /* ===== MAP + cam√©ra ===== */
  .map{
    position:relative;
    border:1px solid var(--line);
    border-radius:16px;
    overflow:hidden;
    background:
      radial-gradient(800px 500px at 15% 20%, rgba(139,211,255,.18), rgba(0,0,0,0) 65%),
      radial-gradient(700px 450px at 85% 50%, rgba(157,255,176,.12), rgba(0,0,0,0) 60%),
      linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    min-height: 440px;
  }
  .mapCam{
    position:absolute;
    inset:0;
    transform: translate3d(0,0,0) scale(1);
    transition: transform 1.15s ease;
  }

  @keyframes nodeIn {
    from { transform: translateY(8px); opacity: 0; }
    to   { transform: translateY(0);   opacity: 1; }
  }
  .node{
    position:absolute;
    width: min(160px, 42vw);
    padding: 8px 9px;
    border-radius:14px;
    border:1px solid var(--line);
    background: rgba(0,0,0,.22);
    cursor:pointer;
    user-select:none;
    opacity:0;
    animation: nodeIn .35s ease forwards;
  }
  .node:hover{background: rgba(0,0,0,.28)}
  .node h3{margin:0 0 3px; font-size:12px}
  .node small{color:var(--muted); font-size:11px; line-height:1.15}
  .badge{
    display:inline-block;
    margin-top:8px;
    padding:4px 8px;
    border-radius:999px;
    font-size:12px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.06);
  }
  .node.selected{
    background: rgba(139,211,255,.18);
    border-color: rgba(139,211,255,.45);
    box-shadow:
      0 0 0 1px rgba(139,211,255,.25) inset,
      0 0 22px rgba(139,211,255,.22),
      0 18px 50px rgba(0,0,0,.35);
  }
  .node.selected .badge{
    background: rgba(157,255,176,.14);
    border-color: rgba(157,255,176,.35);
  }

  /* ===== Cin√©matique ===== */
  .cinematic{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:none;
    background: rgba(0,0,0,.0);
    opacity:0;
    transition: opacity .25s ease, background .25s ease;
    z-index:5;
  }
  .cinematic.show{
    opacity:1;
    background: rgba(0,0,0,.22);
  }
  .cinematicCard{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(15,23,48,.78);
    border-radius:18px;
    padding:16px 18px;
    max-width: 560px;
    text-align:center;
    box-shadow: 0 22px 70px rgba(0,0,0,.45);
    transform: translateY(10px) scale(.98);
    transition: transform .25s ease;
  }
  .cinematic.show .cinematicCard{
    transform: translateY(0) scale(1);
  }
  .cinematicTitle{margin:0 0 6px; font-size: 16px; letter-spacing:.2px}
  .cinematicDesc{margin:0; color: rgba(255,255,255,.80); font-size: 13px; line-height: 1.35}
  .cinematicLore{margin:10px 0 0; color: rgba(255,255,255,.72); font-size: 12px; line-height: 1.35}

  /* ===== Roster ===== */
  .list{display:grid; grid-template-columns: repeat(2, minmax(240px, 1fr)); gap:10px}
  @media (max-width:900px){ .list{grid-template-columns:1fr} }
  .char{
    border:1px solid var(--line);
    border-radius:14px;
    padding:12px;
    background: rgba(0,0,0,.18);
  }
  .charTop{display:flex; justify-content:space-between; gap:10px; align-items:center}
  .char h4{margin:0 0 4px; font-size:14px}
  .tag{font-size:12px; color:var(--muted)}
  .bar{
    height:10px; border-radius:999px; background: rgba(255,255,255,.08); overflow:hidden;
    border:1px solid var(--line);
    margin-top:10px;
  }
  .bar > div{height:100%; width:0%}
  .barXp > div{background: linear-gradient(90deg, rgba(139,211,255,.9), rgba(157,255,176,.9))}
  .stats{margin-top:8px; display:flex; gap:10px; flex-wrap:wrap; color:var(--muted); font-size:12px}
  .avatarBox{
    width:44px;height:44px;border-radius:12px;overflow:hidden;
    border:1px solid var(--line);
    background: rgba(255,255,255,.06);
    display:flex;align-items:center;justify-content:center;
    flex: 0 0 auto;
  }
  .avatarBox img{width:100%;height:100%;object-fit:cover}
  .avatarFallback{font-size:22px}
  .choiceRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}

  /* ===== Battle ===== */
  .battleGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }
  @media (max-width:900px){ .battleGrid{grid-template-columns:1fr} }
  .log{
    height: 190px;
    overflow:auto;
    padding:10px;
    border-radius:14px;
    border:1px solid var(--line);
    background: rgba(0,0,0,.20);
    font-size:12px;
    color:var(--muted);
    line-height:1.35;
  }
  .log b{color:var(--text)}
  footer{padding:14px 18px; color:var(--muted); font-size:12px; text-align:center}

  /* Fix clics au cas o√π */
  #view { position: relative; z-index: 1; }
  .nav { position: relative; z-index: 2; }
.cineOverlay{position:fixed;inset:0;background:rgba(0,0,0,.72);display:none;align-items:center;justify-content:center;z-index:9999}
.cineOverlay.show{display:flex}
.cineCard{width:min(680px,92vw);border:1px solid rgba(255,255,255,.18);background:rgba(18,26,51,.92);border-radius:18px;padding:16px;box-shadow:0 24px 70px rgba(0,0,0,.55);transform:scale(.94);opacity:0;animation:cineIn 1.5s ease forwards}
@keyframes cineIn{0%{transform:scale(.94);opacity:0}40%{transform:scale(1.02);opacity:1}100%{transform:scale(1);opacity:1}}
.cineTitle{font-size:16px;font-weight:800;margin:0 0 8px}
.cineText{color:rgba(255,255,255,.82);line-height:1.45;margin:0 0 12px}
.cineSmall{color:rgba(255,255,255,.62);font-size:12px;margin:0 0 12px}


  .tag.ok{color: var(--good);}


/* R√¥les : lisibilit√© des menus d√©roulants */
#roleStudentSel, #roleTypeSel { color:#0b1220 !important; background:#ffffff !important; }
#roleStudentSel option, #roleTypeSel option { color:#0b1220 !important; background:#ffffff !important; }


/* BOSS VICTORY */
.victoryOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.62);z-index:80;padding:18px}
.victoryCard{max-width:720px;width:100%;border-radius:22px;border:1px solid rgba(255,255,255,.14);
  background:rgba(18,26,51,.92);box-shadow:0 20px 60px rgba(0,0,0,.6);padding:16px;position:relative;overflow:hidden}
.victoryCard h3{margin:0 0 8px;font-size:18px}
.victoryCard p{margin:0;color:rgba(255,255,255,.86);line-height:1.5}
.confetti{position:absolute;top:-12px;width:10px;height:14px;border-radius:2px;opacity:.9;animation:confettiFall 1.8s linear infinite}
@keyframes confettiFall{
  0%{transform:translateY(-20px) rotate(0deg);opacity:0}
  10%{opacity:1}
  100%{transform:translateY(560px) rotate(360deg);opacity:0}
}


/* =========================
   üèÜ SUCC√àS COLLECTIFS
   ========================= */
.successHdr{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin:10px 0}
.successList{margin-top:10px}
.successRow{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:10px;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.18);margin:8px 0}
.successTitle{flex:1;min-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.successTitle.done{text-decoration:line-through;opacity:.75}

</style>
</head>
<body>
<header>
  <div class="title">
    <h1>Le Royaume d‚ÄôOrth√©sia ‚Äî 4e</h1>
    <small>RPG local : effort, m√©thode, entraide ‚Äî 4e. (Photos .png dans le m√™me dossier que ce fichier .html)</small>
  </div>
  <div class="pillrow">
    <span class="pill" id="pillChapter">Zone : ‚Äî</span>
    <span class="pill" id="pillTeam">√âquipe : ‚Äî</span>
    <span class="pill" id="pillXP">XP total : ‚Äî</span>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card nav">
      <h2 class="sectionTitle">Menu</h2>
      <button class="active" data-view="map">üó∫Ô∏è Carte</button>
      <button data-view="roster">üë• √âquipe</button>
      <button data-view="quests">üìú Qu√™tes</button>
      <button data-view="battle">‚öîÔ∏è Combat</button>
      <button data-view="gm">üéÆ Ma√Ætre du jeu</button>
        <button data-view="success">üèÜ Succ√®s</button>

      <div class="hr"></div>
      <p class="muted">
        Changement de zone : cin√©matique (1,5s) + phrase d‚Äôhistoire (dont l‚Äôarriv√©e de Louane une seule fois) + son ‚Äúwhoosh‚Äù + zoom cam√©ra.
      </p>
      <div class="row" style="margin-top:10px">
        <button class="btn danger" id="resetBtn">R√©initialiser</button>
        <button class="btn" id="exportBtn">Exporter</button>
        <button class="btn" id="importBtn">Importer</button>
      </div>
      <input class="select" id="importField" placeholder="Colle ici la sauvegarde JSON (Exporter) puis Entr√©e" />
    </section>

    <section class="card" id="view"></section>
  </div>
</main>

<footer>
  Photos : laisse le fichier <b>.html</b> dans le m√™me dossier que les <b>.png</b>. Si une photo manque (ex : Louane), l‚Äôic√¥ne s‚Äôaffiche √† la place.
</footer>

<!-- Overlay cin√©matique de fin (OK : dans le BODY, pas dans le CSS) -->
<div class="cineOverlay" id="cine">
  <div class="cineCard">
    <div class="cineTitle">‚ú® Victoire de Trimestre</div>
    <p class="cineText" id="cineText"></p>
    <p class="cineSmall">Cette victoire est collective : chacun a apport√© quelque chose.</p>
    <div class="row">
      <button class="btn primary" onclick="closeCine()">Continuer</button>
    </div>
  </div>
</div>

<script>
function escapeHtml(str){
  if(typeof str!=="string") return "";
  return str
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}


console.log("‚úÖ JS charg√© (version corrig√©e)");

// ---------- Donn√©es √©l√®ves ----------
const students = [
  { id:"s01", name: "Aelig", cls: "√âclaireur", trait: "courage", keywords: ["participation","confiance","oral"], quest: "Participer au moins 1 fois en cours (m√™me une phrase).", xp: 0, hp: 30, hpMax: 30, portrait: "aelig.png", icon:"‚ú®" },
  { id:"s02", name: "Anaelle", cls: "Gardien", trait: "curiosit√©", keywords: ["concentration","m√©thode","r√©gularit√©"], quest: "Tenir 10 minutes de travail sans distraction et v√©rifier la consigne.", xp: 0, hp: 30, hpMax: 30, portrait: "anaelle.png", icon:"üõ°Ô∏è" },
  { id:"s03", name: "Angus", cls: "Savant", trait: "pers√©v√©rance", keywords: ["compr√©hension","m√©thode","progression"], quest: "Rep√©rer l‚Äôessentiel : 3 id√©es + 3 mots-cl√©s dans un texte.", xp: 0, hp: 30, hpMax: 30, portrait: "angus.png", icon:"üß†" },
  { id:"s04", name: "Antone", cls: "Messager", trait: "confiance", keywords: ["entraide","confiance","participation"], quest: "Aider un camarade ou demander de l‚Äôaide au bon moment.", xp: 0, hp: 30, hpMax: 30, portrait: "antone.png", icon:"üí¨" },
  { id:"s05", name: "Charlotte", cls: "Scribe", trait: "rigueur", keywords: ["√©criture","m√©thode","rigueur"], quest: "√âcrire 5 lignes claires et relire pour corriger 2 erreurs.", xp: 0, hp: 30, hpMax: 30, portrait: "charlotte.png", icon:"‚úíÔ∏è" },
  { id:"s06", name: "Diane", cls: "√âclaireur", trait: "courage", keywords: ["participation","confiance","oral"], quest: "Participer au moins 1 fois en cours (m√™me une phrase).", xp: 0, hp: 30, hpMax: 30, portrait: "diane.png", icon:"‚ú®" },
  { id:"s07", name: "Dowan", cls: "Gardien", trait: "curiosit√©", keywords: ["concentration","m√©thode","r√©gularit√©"], quest: "Tenir 10 minutes de travail sans distraction et v√©rifier la consigne.", xp: 0, hp: 30, hpMax: 30, portrait: "dowan.png", icon:"üõ°Ô∏è" },
  { id:"s08", name: "Enzo", cls: "Savant", trait: "pers√©v√©rance", keywords: ["compr√©hension","m√©thode","progression"], quest: "Rep√©rer l‚Äôessentiel : 3 id√©es + 3 mots-cl√©s dans un texte.", xp: 0, hp: 30, hpMax: 30, portrait: "enzo.png", icon:"üß†" },
  { id:"s09", name: "Ines", cls: "Messager", trait: "confiance", keywords: ["entraide","confiance","participation"], quest: "Aider un camarade ou demander de l‚Äôaide au bon moment.", xp: 0, hp: 30, hpMax: 30, portrait: "ines.png", icon:"üí¨" },
  { id:"s10", name: "Jeff", cls: "Scribe", trait: "rigueur", keywords: ["√©criture","m√©thode","rigueur"], quest: "√âcrire 5 lignes claires et relire pour corriger 2 erreurs.", xp: 0, hp: 30, hpMax: 30, portrait: "jeff.png", icon:"‚úíÔ∏è" },
  { id:"s11", name: "Jules", cls: "√âclaireur", trait: "courage", keywords: ["participation","confiance","oral"], quest: "Participer au moins 1 fois en cours (m√™me une phrase).", xp: 0, hp: 30, hpMax: 30, portrait: "jules.png", icon:"‚ú®" },
  { id:"s12", name: "Kelim", cls: "Gardien", trait: "curiosit√©", keywords: ["concentration","m√©thode","r√©gularit√©"], quest: "Tenir 10 minutes de travail sans distraction et v√©rifier la consigne.", xp: 0, hp: 30, hpMax: 30, portrait: "kelim.png", icon:"üõ°Ô∏è" },
  { id:"s13", name: "Lena", cls: "Savant", trait: "pers√©v√©rance", keywords: ["compr√©hension","m√©thode","progression"], quest: "Rep√©rer l‚Äôessentiel : 3 id√©es + 3 mots-cl√©s dans un texte.", xp: 0, hp: 30, hpMax: 30, portrait: "lena.png", icon:"üß†" },
  { id:"s14", name: "Logan", cls: "Messager", trait: "confiance", keywords: ["entraide","confiance","participation"], quest: "Aider un camarade ou demander de l‚Äôaide au bon moment.", xp: 0, hp: 30, hpMax: 30, portrait: "logan.png", icon:"üí¨" },
  { id:"s15", name: "Lola", cls: "Scribe", trait: "rigueur", keywords: ["√©criture","m√©thode","rigueur"], quest: "√âcrire 5 lignes claires et relire pour corriger 2 erreurs.", xp: 0, hp: 30, hpMax: 30, portrait: "lola.png", icon:"‚úíÔ∏è" },
  { id:"s16", name: "Lucas", cls: "√âclaireur", trait: "courage", keywords: ["participation","confiance","oral"], quest: "Participer au moins 1 fois en cours (m√™me une phrase).", xp: 0, hp: 30, hpMax: 30, portrait: "lucas.png", icon:"‚ú®" },
  { id:"s17", name: "Maelys", cls: "Gardien", trait: "curiosit√©", keywords: ["concentration","m√©thode","r√©gularit√©"], quest: "Tenir 10 minutes de travail sans distraction et v√©rifier la consigne.", xp: 0, hp: 30, hpMax: 30, portrait: "maelys.png", icon:"üõ°Ô∏è" },
  { id:"s18", name: "Max La", cls: "Savant", trait: "pers√©v√©rance", keywords: ["compr√©hension","m√©thode","progression"], quest: "Rep√©rer l‚Äôessentiel : 3 id√©es + 3 mots-cl√©s dans un texte.", xp: 0, hp: 30, hpMax: 30, portrait: "max_la.png", icon:"üß†" },
  { id:"s19", name: "Max Le", cls: "Messager", trait: "confiance", keywords: ["entraide","confiance","participation"], quest: "Aider un camarade ou demander de l‚Äôaide au bon moment.", xp: 0, hp: 30, hpMax: 30, portrait: "max_le.png", icon:"üí¨" },
  { id:"s20", name: "Melinda", cls: "Scribe", trait: "rigueur", keywords: ["√©criture","m√©thode","rigueur"], quest: "√âcrire 5 lignes claires et relire pour corriger 2 erreurs.", xp: 0, hp: 30, hpMax: 30, portrait: "melinda.png", icon:"‚úíÔ∏è" },
  { id:"s21", name: "Nathanael", cls: "√âclaireur", trait: "courage", keywords: ["participation","confiance","oral"], quest: "Participer au moins 1 fois en cours (m√™me une phrase).", xp: 0, hp: 30, hpMax: 30, portrait: "nathanael.png", icon:"‚ú®" },
  { id:"s22", name: "Raphael", cls: "Gardien", trait: "curiosit√©", keywords: ["concentration","m√©thode","r√©gularit√©"], quest: "Tenir 10 minutes de travail sans distraction et v√©rifier la consigne.", xp: 0, hp: 30, hpMax: 30, portrait: "raphael.png", icon:"üõ°Ô∏è" },
  { id:"s23", name: "Thomas", cls: "Savant", trait: "pers√©v√©rance", keywords: ["compr√©hension","m√©thode","progression"], quest: "Rep√©rer l‚Äôessentiel : 3 id√©es + 3 mots-cl√©s dans un texte.", xp: 0, hp: 30, hpMax: 30, portrait: "thomas.png", icon:"üß†" },
];

// ---------- Monde ----------
const zones = [
  { id:"plaine", name:"Plaine de la Compr√©hension", desc:"Lire, comprendre, rep√©rer l'essentiel.", x: 8,  y: 15 },
  { id:"foret",  name:"For√™t de l‚Äô√âcriture",        desc:"√âcrire, structurer, am√©liorer.",        x: 40, y: 44 },
  { id:"cite",   name:"Cit√© de l‚ÄôOral",             desc:"Prendre la parole avec confiance.",     x: 74, y: 14 },
  { id:"mont",   name:"Montagne de la M√©thode",     desc:"S'organiser, relire, progresser.",      x: 18, y: 64 },
  { id:"sanct",  name:"Sanctuaire de la Confiance", desc:"Oser, pers√©v√©rer, grandir.",            x: 74, y: 64 }
];

const enemies = [
  { id:"doute", name:"Le Doute", hp: 35, atk: 6, msg:"Il murmure : ‚ÄúTu n‚Äôy arriveras pas‚Ä¶‚Äù" },
  { id:"disp",  name:"La Dispersion", hp: 30, atk: 7, msg:"Elle disperse l‚Äôattention et le courage." },
  { id:"peur",  name:"La Peur de se tromper", hp: 40, atk: 5, msg:"Elle freine les essais‚Ä¶ alors qu‚Äôils font progresser." }
];

const boss = {
  id: "boss_t1",
  name: "Le Grand Brouillard du Trimestre",
  hp: 120,
  hpMax: 120,
  weakness: "methode", // lien avec ton action "methode"
  status: "active",
  log: [
    "Le brouillard s‚Äô√©paissit‚Ä¶ mais l‚Äô√©quipe avance.",
    "Une phrase bien construite dissipe une ombre."
  ]
};

const actions = [
  { id:"effort",  label:"Effort",    desc:"+ d√©g√¢ts stables",   dmg:[6,10], heal:[0,0] },
  { id:"methode", label:"M√©thode",   desc:"+ pr√©cision, - d√©g√¢ts subis", dmg:[5,9], heal:[0,0], shield:2 },
  { id:"entraide",label:"Entraide",  desc:"soigne un peu l‚Äô√©quipe", dmg:[4,8], heal:[2,5] },
  { id:"calme",   label:"Calme",     desc:"soigne beaucoup", dmg:[2,5], heal:[4,8] }
];

/* =========================
   MOIS (Jan ‚Üí Juin)
   ========================= */
const months = [
  { id:"jan", label:"Janvier",  bossName:"Le Doute persistant",      bossId:"doute", goal:"Reprendre confiance apr√®s les vacances." },
  { id:"feb", label:"F√©vrier",  bossName:"La Dispersion",            bossId:"disp",  goal:"Tenir la concentration dans la dur√©e." },
  { id:"mar", label:"Mars",     bossName:"La Peur de se tromper",    bossId:"peur",  goal:"Oser essayer, m√™me si c‚Äôest imparfait." },
  { id:"apr", label:"Avril",    bossName:"La Fatigue",               bossId:"fatigue", goal:"Rester r√©gulier malgr√© la baisse d‚Äô√©nergie." },
  { id:"may", label:"Mai",      bossName:"La Pr√©cipitation",         bossId:"precip", goal:"Relire, √™tre rigoureux, am√©liorer." },
  { id:"jun", label:"Juin",     bossName:"L‚ÄôOmbre d‚ÄôOrth√©sia",       bossId:"final", goal:"Boss final : union, autonomie, confiance." }
];

// Associe un id de mois au mois syst√®me (Jan=0 ... Dec=11)
function getCurrentMonthId(){
  const m = new Date().getMonth();
  if(m === 0) return "jan";
  if(m === 1) return "feb";
  if(m === 2) return "mar";
  if(m === 3) return "apr";
  if(m === 4) return "may";
  if(m === 5) return "jun";
  // Si on est hors Jan‚ÄìJuin, on se cale sur Jan (ou tu peux mettre "jun")
  return "jan";
}

function getMonthConfig(){
  const id = getCurrentMonthId();
  return months.find(x => x.id === id) || months[0];
}




const loreLines = [
  "Le groupe avance, plus uni qu‚Äôhier.",
  "Les pas r√©sonnent‚Ä¶ et la confiance grandit.",
  "Chacun apporte quelque chose : c‚Äôest √ßa, une √©quipe.",
  "Les efforts d‚Äôaujourd‚Äôhui construisent les victoires de demain.",
  "Une difficult√© traverse la route‚Ä¶ mais la classe garde le cap.",
  "Les h√©ros progressent, m√™me quand c‚Äôest discret.",
  "Une bonne m√©thode √©claire le chemin.",
  "On respire, on se concentre‚Ä¶ et on continue."
];

const achievements = [
  { id:"focus_10", title:"10 minutes de focus", desc:"La classe a tenu 10 minutes sans interruption.", unlocked:false, date:"" },
  { id:"copies_30", title:"30 relectures", desc:"30 copies relues s√©rieusement.", unlocked:false, date:"" },
  { id:"oral_10", title:"10 prises de parole", desc:"10 √©l√®ves ont particip√© √† l‚Äôoral.", unlocked:false, date:"" }
];

const periods = [
  { id:"JAN", label:"Janvier",  dateRange:"Janvier",  teamXp:0, questsDone:0, notes:"" },
  { id:"FEB", label:"F√©vrier",  dateRange:"F√©vrier",  teamXp:0, questsDone:0, notes:"" },
  { id:"MAR", label:"Mars",     dateRange:"Mars",     teamXp:0, questsDone:0, notes:"" },
  { id:"APR", label:"Avril",    dateRange:"Avril",    teamXp:0, questsDone:0, notes:"" },
  { id:"MAY", label:"Mai",      dateRange:"Mai",      teamXp:0, questsDone:0, notes:"" },
  { id:"JUN", label:"Juin",     dateRange:"Juin",     teamXp:0, questsDone:0, notes:"" }
];

/* =========================
   R√îLES (individuels, 2 semaines, max 4 actifs)
   R√©compense √† la cl√¥ture : ‚úÖ -5 PV au Boss
   ========================= */
const ROLE_RULES = {
  maxActive: 4,
  durationDays: 14,
  reward: { type: "boss", bossDamage: 5, xpBonus: 0 } // type: "boss" | "xp" | "both"
};

const ROLE_TYPES = [
  { id:"scribe",   label:"üìú Scribe",               desc:"Note les consignes / plan / √©tapes." },
  { id:"eclaireur",label:"üî≠ √âclaireur",            desc:"Rep√®re l'essentiel, annonce la prochaine √©tape." },
  { id:"gardien",  label:"üõ°Ô∏è Gardien de la m√©thode", desc:"Rappelle : lire ‚Üí faire ‚Üí relire." },
  { id:"messager", label:"üó£Ô∏è Messager",            desc:"Encourage la participation et aide √† formuler." },
  { id:"artisan",  label:"‚úçÔ∏è Artisan",             desc:"Soigne la pr√©sentation (titre, lisibilit√©)." },
  { id:"pacificateur",label:"üåø Pacificateur",      desc:"Aide au calme et au climat de travail." }
];

function addDays(date, days){
  const d = new Date(date.getTime());
  d.setDate(d.getDate()+days);
  return d;
}
function isoDate(d){ return new Date(d).toISOString(); }
function frDate(d){
  const dt = new Date(d);
  const dd=String(dt.getDate()).padStart(2,"0");
  const mm=String(dt.getMonth()+1).padStart(2,"0");
  const yy=dt.getFullYear();
  return `${dd}/${mm}/${yy}`;
}
function safeText(s){ return String(s ?? ""); }
function escapeRoleHtml(s){
  return safeText(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#39;");
}

function roleLabelById(id){
  const t = ROLE_TYPES.find(x=>x.id===id);
  return t ? t.label : id;
}
function canAssignMoreRoles(){
  return (state.rolesActive||[]).length < ROLE_RULES.maxActive;
}
function ensureRoleArrays(){
  state.rolesActive = Array.isArray(state.rolesActive) ? state.rolesActive : [];
  state.rolesHistory = Array.isArray(state.rolesHistory) ? state.rolesHistory : [];
}
function expireRolesIfNeeded(){
  ensureRoleArrays();
  const now = Date.now();
  const stillActive = [];
  for(const r of state.rolesActive){
    const end = Date.parse(r.endAt||"");
    if(end && end < now){
      state.rolesHistory.push({ ...r, endedAuto:true, closedAt: isoDate(new Date()) });
    } else {
      stillActive.push(r);
    }
  }
  state.rolesActive = stillActive;
}

function assignRole(studentId, roleId){
  ensureRoleArrays();
  if(!canAssignMoreRoles()) return alert("Max r√¥les actifs atteint ("+ROLE_RULES.maxActive+").");
  const s = state.party.find(p=>p.id===studentId);
  if(!s) return alert("√âl√®ve introuvable.");
  const start = new Date();
  const end = addDays(start, ROLE_RULES.durationDays);
  state.rolesActive.push({
    id: "r"+Date.now()+Math.random().toString(16).slice(2),
    studentId,
    studentName: s.name,
    roleId,
    roleLabel: roleLabelById(roleId),
    startAt: isoDate(start),
    endAt: isoDate(end)
  });
  pushAnnouncement(`üßô Nouveau r√¥le : ${s.name} ‚Üí ${roleLabelById(roleId)} (jusqu‚Äôau ${frDate(end)})`);
  save();
}

function applyRoleReward(r){
  if(ROLE_RULES.reward.type==="boss" || ROLE_RULES.reward.type==="both"){
    const dmg = Number(ROLE_RULES.reward.bossDamage)||0;
    if(state.boss && dmg>0){
      state.boss.hp = Math.max(0, (Number(state.boss.hp)||0) - dmg);
      state.boss.log = state.boss.log || [];
      state.boss.log.push("R√¥le termin√© : "+r.studentName+" ‚Üí "+r.roleLabel+" ( -"+dmg+" PV au Boss ).");
      if(Number(state.boss.hp)<=0){ state.boss.hp=0; state.boss.victoryStamp = new Date().toISOString(); triggerFinalEvent(); }
    }
  }
  if(ROLE_RULES.reward.type==="xp" || ROLE_RULES.reward.type==="both"){
    const bonus = Number(ROLE_RULES.reward.xpBonus)||0;
    if(bonus>0){
      const s = state.party.find(p=>p.id===r.studentId);
      if(s) s.xp = (Number(s.xp)||0) + bonus;
    }
  }
}

function closeRole(roleInstanceId){
  ensureRoleArrays();
  const idx = state.rolesActive.findIndex(r=>r.id===roleInstanceId);
  if(idx<0) return;
  const r = state.rolesActive[idx];
  state.rolesActive.splice(idx,1);
  applyRoleReward(r);
  state.rolesHistory.push({ ...r, closedAt: isoDate(new Date()), endedAuto:false });
  save();
}

function removeRole(roleInstanceId){
  ensureRoleArrays();
  const idx = state.rolesActive.findIndex(r=>r.id===roleInstanceId);
  if(idx<0) return;
  const r = state.rolesActive[idx];
  state.rolesActive.splice(idx,1);
  pushAnnouncement(`‚ÑπÔ∏è R√¥le retir√© : ${r.studentName} ‚Äî ${r.roleLabel}`);
  save();
}

function pushAnnouncement(txt){
  state.announcements = Array.isArray(state.announcements) ? state.announcements : [];
  state.announcements.push({ t: new Date().toISOString(), text: txt });
  if(state.announcements.length>12) state.announcements = state.announcements.slice(-12);
}

function renderRolesGM(){
  ensureRoleArrays();
  const active = state.rolesActive;
  const hist = state.rolesHistory;

  let html = '<div class="char">'
    + '<h4>üßô R√¥les (individuels)</h4>'
    + '<div class="tag">Max <b>'+ROLE_RULES.maxActive+'</b> ‚Ä¢ dur√©e <b>'+ROLE_RULES.durationDays+'</b> jours ‚Ä¢ r√©compense : <b>-'+ROLE_RULES.reward.bossDamage+' PV Boss</b></div>'
    + '<div class="hr"></div>'
    + '<div class="row">'
    + '  <select class="select" id="roleStudentSel"></select>'
    + '  <select class="select" id="roleTypeSel"></select>'
    + '</div>'
    + '<div class="choiceRow" style="margin-top:10px">'
    + '  <button class="btn primary" id="assignRoleBtn" type="button">Assigner</button>'
    + '</div>'
    + '</div>';

  html += '<div class="hr"></div><h3 style="margin:0 0 8px;font-size:14px">üé≠ R√¥les en cours ('+active.length+'/'+ROLE_RULES.maxActive+')</h3>';

  if(active.length===0){
    html += '<div class="char"><div class="tag">Aucun r√¥le actif.</div></div>';
  } else {
    for(const r of active){
      html += '<div class="char" style="margin-bottom:10px">'
        + '<div class="charTop">'
        + ' <div><h4 style="margin:0">'+escapeRoleHtml(r.studentName)+'</h4><div class="tag">'+escapeRoleHtml(r.roleLabel)+'</div></div>'
        + ' <div class="tag">jusqu‚Äôau <b>'+frDate(r.endAt)+'</b></div>'
        + '</div>'
        + '<div class="choiceRow">'
        + ' <button class="btn primary" type="button" data-role-action="close" data-role-id="'+escapeRoleHtml(r.id)+'">Cl√¥turer (+r√©compense)</button>'
        + ' <button class="btn danger"  type="button" data-role-action="remove" data-role-id="'+escapeRoleHtml(r.id)+'">Retirer</button>'
        + '</div>'
        + '</div>';
    }
  }

  html += '<div class="hr"></div><h3 style="margin:0 0 8px;font-size:14px">üïò Historique (prof)</h3>';
  if(hist.length===0){
    html += '<div class="char"><div class="tag">Aucun historique pour l‚Äôinstant.</div></div>';
  } else {
    const last = hist.slice(-12).reverse();
    for(const r of last){
      html += '<div class="char" style="margin-bottom:10px">'
        + '<div class="charTop">'
        + ' <div><h4 style="margin:0">'+escapeRoleHtml(r.studentName)+'</h4><div class="tag">'+escapeRoleHtml(r.roleLabel)+'</div></div>'
        + ' <div class="tag">'+(r.closedAt ? ("clos le <b>"+frDate(r.closedAt)+"</b>") : "")+'</div>'
        + '</div>'
        + '<div class="mini">D√©but : '+frDate(r.startAt)+' ‚Ä¢ Fin pr√©vue : '+frDate(r.endAt) + (r.endedAuto ? " ‚Ä¢ (auto)" : "") + '</div>'
        + '</div>';
    }
    html += '<div class="mini">Affichage limit√© aux 12 derniers r√¥les.</div>';
  }

  return html;
}



/* =========================
   P√âRIODES (Jan ‚Üí Juin)
   ========================= */
function buildDefaultPeriods(){
  return [
    { id:"jan", label:"Janvier",   range:"(Jan)",    teamXp:0, quests:0, note:"" },
    { id:"feb", label:"F√©vrier",   range:"(F√©v)",    teamXp:0, quests:0, note:"" },
    { id:"mar", label:"Mars",      range:"(Mar)",    teamXp:0, quests:0, note:"" },
    { id:"apr", label:"Avril",     range:"(Avr)",    teamXp:0, quests:0, note:"" },
    { id:"may", label:"Mai",       range:"(Mai)",    teamXp:0, quests:0, note:"" },
    { id:"jun", label:"Juin",      range:"(Juin)",   teamXp:0, quests:0, note:"" }
  ];
}

function normalizePeriods(st){
  const defs = buildDefaultPeriods();
  if(!st || typeof st!=="object") return defs;

  // If periods missing or old format (e.g., 3 p√©riodes Sept‚ÜíOct...), rebuild while keeping existing numbers if possible.
  const cur = Array.isArray(st.periods) ? st.periods : [];
  const byId = new Map(cur.filter(p=>p && typeof p==="object").map(p=>[p.id, p]));
  const looksOld = cur.length < 6 || cur.some(p => (p && (String(p.label||"").includes("Sept") || String(p.range||"").includes("Sept") || String(p.label||"").includes("P√©riode"))));

  const merged = defs.map(d=>{
    const old = byId.get(d.id);
    return {
      ...d,
      teamXp: Number(old?.teamXp ?? d.teamXp) || 0,
      quests: Number(old?.quests ?? d.quests) || 0,
      note: (typeof old?.note === "string") ? old.note : d.note
    };
  });

  // Also try to salvage totals from old periods (sum) into January if we detect old format.
  if(looksOld && cur.length){
    const sumXp = cur.reduce((a,p)=>a + (Number(p?.teamXp)||0),0);
    const sumQ  = cur.reduce((a,p)=>a + (Number(p?.quests)||0),0);
    if(sumXp && merged[0].teamXp===0) merged[0].teamXp = sumXp;
    if(sumQ  && merged[0].quests===0) merged[0].quests = sumQ;
  }
  return merged;
}



const finalLines = [
  "Le brouillard se dissipe‚Ä¶ et le royaume respire. Votre force, c‚Äôest l‚Äô√©quipe.",
  "Vous avez tenu bon : m√©thode, entraide, courage. C‚Äôest comme √ßa qu‚Äôon progresse.",
  "Chacun a fait un pas ‚Äî et ensemble, √ßa devient un chemin.",
  "Victoire ! Pas parfaite, mais vraie : celle des efforts r√©guliers."
];

// ---------- Utilitaires ----------
const STORAGE_KEY = "orthesia_4e_save_v1";


const CLASS_SLUG = "4e";
const CLASS_NAME = "4e";
function nowFr(){
  const d=new Date();
  const dd=String(d.getDate()).padStart(2,"0");
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const yyyy=d.getFullYear();
  const hh=String(d.getHours()).padStart(2,"0");
  const mi=String(d.getMinutes()).padStart(2,"0");
  return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
}

function levelFromXP(xp){
  xp = Number(xp)||0;
  if(xp < 10) return 1;
  if(xp < 22) return 2;
  if(xp < 38) return 3;
  if(xp < 58) return 4;
  return 5;
}
function xpToNext(level){
  const t = [0,10,22,38,58,999];
  return t[level] || 999;
}

function buildQuestFromKeywords(keywords) {
  const list = keywords || [];
  const k = {};
  for(let i=0;i<list.length;i++) {
    const s = String(list[i] || "").toLowerCase().trim();
    k[s]=true;
  }
  const pieces = [];
  if (k["concentration"]) pieces.push("rester concentr√©(e) et √©viter la dispersion");
  if (k["m√©thode"]) pieces.push("t‚Äôappuyer sur une m√©thode simple : lire, planifier, relire");
  if (k["confiance"]) pieces.push("oser davantage et te faire confiance");
  if (k["participation"]) pieces.push("participer, m√™me bri√®vement, pour faire grandir tes id√©es");
  if (k["r√©gularit√©"]) pieces.push("avancer avec constance et r√©gularit√©");

  if (pieces.length === 0) return "Qu√™te : avancer pas √† pas, avec pers√©v√©rance.";
  let joined = "";
  if(pieces.length === 1) joined = pieces[0];
  else joined = pieces.slice(0,-1).join(", ") + ", et " + pieces[pieces.length-1];
  return "Qu√™te : " + joined + ".";
}

function makeInitialParty(){
  const party = [];
  for(let i=0;i<students.length;i++) {
    const s = students[i];
    party.push({
      id: "s"+i,
      name: s.name,
      cls: s.cls,
      trait: s.trait,
      role: s.role || null,
      quest: buildQuestFromKeywords(s.keywords),
      xp: 0,
      hp: 30,
      hpMax: 30,
      portrait: s.portrait || "",
      icon: s.icon || "‚ú®"
    });
  }
  return party;
}

function deepCopy(o){ return JSON.parse(JSON.stringify(o)); }

function defaultState(){
  return {
    zoneId: zones[0].id,
    party: makeInitialParty(),
    louaneIntroDone: false,
    quests: [
      { id:"q1", title:"Le Parchemin de la M√©thode", done:false, reward:6, desc:"Relire, corriger, am√©liorer un √©crit." },
      { id:"q2", title:"La Clef de la Confiance", done:false, reward:6, desc:"Oser une participation (m√™me courte)." },
      { id:"q3", title:"Le Bouclier de l‚ÄôAttention", done:false, reward:6, desc:"Tenir une phase de travail sans distraction." }
    ],
    boss: deepCopy(boss),
    achievements: deepCopy(achievements),
    periods: deepCopy(periods),
    meta: { updatedAt: nowFr(), finalShown: false },
    battle: null
  };
}

function ensureDefaults(s){
  const st = (s && typeof s==="object") ? s : {};
  if(typeof st.zoneId !== "string") st.zoneId = zones[0].id;
  if(!Array.isArray(st.party)) st.party = makeInitialParty();
  if(!Array.isArray(st.quests)) st.quests = defaultState().quests;
  if(!st.boss) st.boss = deepCopy(boss);
  if(!Array.isArray(st.achievements)) st.achievements = deepCopy(achievements);
  st.periods = normalizePeriods(st);
  if(!st.meta) st.meta = { };
  if(typeof st.meta.updatedAt !== "string") st.meta.updatedAt = nowFr();
  if(typeof st.meta.finalShown !== "boolean") st.meta.finalShown = false;
  if(typeof st.louaneIntroDone !== "boolean") st.louaneIntroDone = false;
  return st;
}

function load(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    return ensureDefaults(JSON.parse(raw));
  }catch(e){ return null; }
}

let state = load();
if(!state) state = defaultState();
expireRolesIfNeeded();
save();

function save(){
  state.meta = state.meta || {};
  state.meta.updatedAt = nowFr();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  updatePills();
}

/* =========================
   SUCC√àS MENSUELS (3 max)
   ========================= */
function buildMonthlyAchievements(monthId){
  const packs = {
    jan: [
      { id:"jan_confiance", title:"Reprise en confiance", desc:"On se remet en route sans se d√©valoriser.", unlocked:false },
      { id:"jan_effort", title:"Effort r√©gulier", desc:"On fait le minimum s√©rieux chaque semaine.", unlocked:false },
      { id:"jan_entraide", title:"Main tendue", desc:"On aide sans se moquer, on encourage.", unlocked:false }
    ],
    feb: [
      { id:"feb_focus", title:"10 minutes focus", desc:"La classe tient un temps de concentration propre.", unlocked:false },
      { id:"feb_methode", title:"M√©thodes en place", desc:"On relit/organise avant de rendre.", unlocked:false },
      { id:"feb_calme", title:"Climat apais√©", desc:"Moins d‚Äôagitation, plus d‚Äô√©coute.", unlocked:false }
    ],
    mar: [
      { id:"mar_oral", title:"Oser participer", desc:"Plus de prises de parole (m√™me courtes).", unlocked:false },
      { id:"mar_erreur", title:"Droit √† l‚Äôerreur", desc:"On tente, on corrige, on progresse.", unlocked:false },
      { id:"mar_courage", title:"Courage collectif", desc:"On encourage ceux qui osent.", unlocked:false }
    ],
    apr: [
      { id:"apr_regu", title:"R√©gularit√©", desc:"On tient le cap malgr√© la fatigue.", unlocked:false },
      { id:"apr_soin", title:"Travail soign√©", desc:"On am√©liore la pr√©sentation, l‚Äô√©criture.", unlocked:false },
      { id:"apr_soutien", title:"Soutien d‚Äô√©quipe", desc:"On se motive quand √ßa baisse.", unlocked:false }
    ],
    may: [
      { id:"may_relire", title:"Relire avant de rendre", desc:"Relecture syst√©matique (consignes, accords, ponctuation).", unlocked:false },
      { id:"may_rigueur", title:"Rigueur", desc:"On va au bout, on v√©rifie.", unlocked:false },
      { id:"may_autonomie", title:"Autonomie", desc:"On se d√©brouille avec m√©thode avant de demander.", unlocked:false }
    ],
    jun: [
      { id:"jun_union", title:"Union finale", desc:"La classe agit comme une vraie √©quipe.", unlocked:false },
      { id:"jun_confiance", title:"Confiance", desc:"On ose, on pers√©v√®re, on progresse.", unlocked:false },
      { id:"jun_fierte", title:"Fiert√©", desc:"On finit l‚Äôann√©e la t√™te haute.", unlocked:false }
    ]
  };

  return packs[monthId] ? packs[monthId] : packs.jan;
}


// ---------- AUDIO WHOOSH ----------
let audioCtx = null;
function initAudio(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}
function playWhoosh(){
  try{
    initAudio();
    const t0 = audioCtx.currentTime;
    const bufferSize = 2 * audioCtx.sampleRate;
    const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const output = noiseBuffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) output[i] = Math.random() * 2 - 1;

    const noise = audioCtx.createBufferSource();
    noise.buffer = noiseBuffer;

    const filter = audioCtx.createBiquadFilter();
    filter.type = "bandpass";
    filter.frequency.setValueAtTime(900, t0);
    filter.frequency.exponentialRampToValueAtTime(240, t0 + 0.18);

    const gain = audioCtx.createGain();
    gain.gain.setValueAtTime(0.0001, t0);
    gain.gain.exponentialRampToValueAtTime(0.35, t0 + 0.03);
    gain.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.22);

    noise.connect(filter);
    filter.connect(gain);
    gain.connect(audioCtx.destination);

    noise.start(t0);
    noise.stop(t0 + 0.23);
  }catch(e){}
}

// ---------- Cin√©matique + lore ----------
function pickLore(){
  if(!state.louaneIntroDone){
    state.louaneIntroDone = true;
    save();
    return "Une nouvelle h√©ro√Øne rejoint le groupe : Louane.";
  }
  return loreLines[Math.floor(Math.random()*loreLines.length)];
}

function showCinematic(zone){
  const map = document.getElementById("map");
  if(!map) return;

  let overlay = map.querySelector(".cinematic");
  if(!overlay){
    overlay = document.createElement("div");
    overlay.className = "cinematic";
    overlay.innerHTML = '<div class="cinematicCard">'
      + '<h3 class="cinematicTitle"></h3>'
      + '<p class="cinematicDesc"></p>'
      + '<p class="cinematicLore"></p>'
      + '</div>';
    map.appendChild(overlay);
  }

  overlay.querySelector(".cinematicTitle").textContent = zone.name;
  overlay.querySelector(".cinematicDesc").textContent = zone.desc;
  overlay.querySelector(".cinematicLore").textContent = "‚ú¶ " + pickLore();

  overlay.classList.add("show");
  window.clearTimeout(showCinematic._t);
  showCinematic._t = window.setTimeout(()=>overlay.classList.remove("show"), 1500);
}

function cameraMoveTo(zone){
  const cam = document.getElementById("mapCam");
  if(!cam) return;
  const cx = zone.x, cy = zone.y;
  const panX = (50 - cx) * 2.2;
  const panY = (50 - cy) * 2.2;
  cam.style.transform = `translate3d(${panX}px, ${panY}px, 0) scale(1.06)`;
  window.clearTimeout(cameraMoveTo._t);
  cameraMoveTo._t = window.setTimeout(()=>cam.style.transform="translate3d(0,0,0) scale(1)", 1500);
}

// ---------- Final event overlay ----------
function triggerFinalEvent(){
  try{ showBossVictoryOverlay({title:'üéâ Boss vaincu !', message:'Victoire ! La classe a vid√© la barre du boss collectif.'}); }catch(e){}

  if(state.meta && state.meta.finalShown) return;
  state.meta = state.meta || {};
  state.meta.finalShown = true;
  save();
  const cine = document.getElementById("cine");
  const t = document.getElementById("cineText");
  if(!cine || !t) return;
  t.textContent = finalLines[Math.floor(Math.random()*finalLines.length)];
  cine.classList.add("show");
}
function closeCine(){
  const cine = document.getElementById("cine");
  if(cine) cine.classList.remove("show");
}

// ---------- UI ----------
const viewEl = document.getElementById("view");
const navBtns = Array.from(document.querySelectorAll(".nav button[data-view]"));
let currentView = "map";

function updatePills(){
  const zone = zones.find(z => z.id === state.zoneId);
  document.getElementById("pillChapter").textContent = "Zone : " + (zone ? zone.name : "‚Äî");
  document.getElementById("pillTeam").textContent = "√âquipe : " + (state.party ? state.party.length : 0) + " h√©ros";
  let totalXP = 0;
  for(let i=0;i<(state.party||[]).length;i++) totalXP += Number(state.party[i].xp)||0;
  document.getElementById("pillXP").textContent = "XP total : " + totalXP;
}

function setView(v){
  currentView = v;
  navBtns.forEach(b=>b.classList.toggle("active", b.dataset.view === v));
  render(v);
}

navBtns.forEach(b=>b.addEventListener("click", e=>{e.preventDefault(); e.stopPropagation(); setView(b.dataset.view);}));

document.getElementById("resetBtn").addEventListener("click", function(){
  if(confirm("R√©initialiser la progression ?")){
    state = defaultState();
    save();
    setView("map");
  }
});

document.getElementById("exportBtn").addEventListener("click", function(){
  // Export simple et fiable (inclut d√©j√† boss / achievements / periods pr√©sents dans state)
  let txt = "";
  try{
    // On met √† jour l'horodatage avant export
    state.meta = state.meta || {};
    state.meta.updatedAt = nowFr();
        // ‚úÖ P√©riodes mensuelles (Jan ‚Üí Juin) pour la vue √©l√®ves
    state.teamXp = (typeof state.teamXp === "number") ? state.teamXp : 0;
    state.quests = Array.isArray(state.quests) ? state.quests : [];
    state.periods = [
      { id:"jan", label:"Janvier",  goal:"Reprendre confiance", boss:"Le Doute persistant", teamXp: state.teamXp, questsDone: state.quests.filter(q=>q.done).length, notes:"" },
      { id:"feb", label:"F√©vrier",  goal:"Se concentrer",       boss:"La Dispersion",      teamXp: state.teamXp, questsDone: state.quests.filter(q=>q.done).length, notes:"" },
      { id:"mar", label:"Mars",     goal:"Oser participer",     boss:"La Peur de se tromper", teamXp: state.teamXp, questsDone: state.quests.filter(q=>q.done).length, notes:"" },
      { id:"apr", label:"Avril",    goal:"Tenir l‚Äôeffort",      boss:"La Fatigue",         teamXp: state.teamXp, questsDone: state.quests.filter(q=>q.done).length, notes:"" },
      { id:"may", label:"Mai",      goal:"√ätre rigoureux",      boss:"La Pr√©cipitation",   teamXp: state.teamXp, questsDone: state.quests.filter(q=>q.done).length, notes:"" },
      { id:"jun", label:"Juin",     goal:"Boss final",          boss:"L‚ÄôOmbre d‚ÄôOrth√©sia", teamXp: state.teamXp, questsDone: state.quests.filter(q=>q.done).length, notes:"" }
    ];

txt = JSON.stringify(state);
  }catch(e){
    console.error("Erreur export JSON :", e);
    txt = JSON.stringify(state);
  }

  // Copie presse-papier si possible, sinon affiche dans la console
  if (navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(txt).then(()=>{
      alert("‚úÖ Sauvegarde JSON copi√©e !");
    }).catch(()=>{
      console.log("SAUVEGARDE JSON:", txt);
      alert("‚ö†Ô∏è Copie refus√©e par le navigateur. JSON dans la console (F12).");
    });
  } else {
    console.log("SAUVEGARDE JSON:", txt);
    alert("‚ö†Ô∏è Presse-papier indisponible. JSON dans la console (F12).");
  }
});


document.getElementById("importBtn").addEventListener("click", ()=>document.getElementById("importField").focus());

document.getElementById("importField").addEventListener("keydown", function(e){
  if(e.key === "Enter"){
    try{
      const obj = JSON.parse(String(e.target.value || "").trim());
      state = ensureDefaults(obj);
      save();
      setView("map");
      alert("Import r√©ussi.");
    }catch(err){ alert("Import impossible : " + err.message); }
    e.target.value = "";
  }
});


function gid(){ return "g"+Date.now()+Math.random().toString(16).slice(2); }

function ensureCollectiveGoals(){
  state.collectiveGoals = Array.isArray(state.collectiveGoals) ? state.collectiveGoals : [];
  if(state.collectiveGoals.length===0){
    for(let i=1;i<=10;i++){
      state.collectiveGoals.push({ id: gid(), title: "Objectif "+i, done:false, createdAt: new Date().toISOString() });
    }
    save();
  }
}

function syncAchievementsFromGoals(){
  // r√©tro-compat : on publie aussi dans state.achievements pour la vue √©l√®ves
  state.achievements = Array.isArray(state.achievements) ? state.achievements : [];
  const goals = Array.isArray(state.collectiveGoals) ? state.collectiveGoals : [];
  state.achievements = goals.map(g=>({
    id: g.id,
    title: g.title || "Objectif",
    desc: g.desc || "",
    done: !!g.done
  }));
}

function clampBossForSuccess(){
  state.boss = (state.boss && typeof state.boss==="object") ? state.boss : { name:"Boss", hp:100, maxHp:100 };
  state.boss.maxHp = Number(state.boss.maxHp||state.boss.maxHP||state.boss.hpMax||100) || 100;
  state.boss.hp = Number(state.boss.hp||0);
  if(state.boss.hp<0) state.boss.hp=0;
  if(state.boss.hp>state.boss.maxHp) state.boss.hp=state.boss.maxHp;
}

function renderSuccess(){
  ensureCollectiveGoals(); syncAchievementsFromGoals(); clampBossForSuccess();
  const goals = state.collectiveGoals;
  const done = goals.filter(g=>!!g.done).length;

  viewEl.innerHTML =
    '<h2 class="sectionTitle">üèÜ Succ√®s collectifs</h2>'
    + '<p class="muted">Objectifs modulables. R√®gle : <b>-10 PV boss</b> par objectif valid√© (annuler = +10 PV).</p>'
    + '<div class="char">'
    + '  <div class="successHdr">'
    + '    <div class="tag">Progression : <b>'+done+'/'+goals.length+'</b> ‚Ä¢ Boss : <b>'+escapeHtml(state.boss.name||"Boss")+' '+state.boss.hp+'/'+state.boss.maxHp+'</b></div>'
    + '    <div class="choiceRow">'
    + '      <button class="btn" id="succCountBtn">Choisir le nombre</button>'
    + '      <button class="btn primary" id="succAddBtn">+ Ajouter</button>'
    + '    </div>'
    + '  </div>'
    + '  <div class="hr"></div>'
    + '  <div class="successList" id="succList"></div>'
    + '</div>';

  const list = document.getElementById("succList");
  goals.forEach(g=>{
    const row = document.createElement("div");
    row.className = "successRow";
    row.innerHTML =
      '<input class="chk" type="checkbox" '+(g.done?'checked':'')+' data-goal="'+escapeHtml(g.id)+'" />'
      + '<div class="successTitle '+(g.done?'done':'')+'">'+escapeHtml(g.title||"Objectif")+'</div>'
      + '<div class="choiceRow">'
      + '  <button class="btn" data-edit="'+escapeHtml(g.id)+'">‚úèÔ∏è</button>'
      + '  <button class="btn danger" data-del="'+escapeHtml(g.id)+'">üóëÔ∏è</button>'
      + '</div>';
    list.appendChild(row);
  });

  document.getElementById("succAddBtn").onclick = ()=>{
    state.collectiveGoals.push({ id: gid(), title:"Nouvel objectif", done:false, createdAt:new Date().toISOString() });
    syncAchievementsFromGoals(); syncAchievementsFromGoals(); save(); renderSuccess();
  };

  document.getElementById("succCountBtn").onclick = ()=>{
    const cur = state.collectiveGoals.length;
    const v = prompt("Nombre d‚Äôobjectifs (1 √† 30) :", String(cur));
    if(v===null) return;
    let n = Math.max(1, Math.min(30, parseInt(v,10)||cur));
    if(n===cur) return;
    if(n>cur){
      for(let i=cur+1;i<=n;i++){
        state.collectiveGoals.push({ id: gid(), title:"Objectif "+i, done:false, createdAt: new Date().toISOString() });
      }
    }else{
      if(!confirm("R√©duire supprimera les derniers objectifs. Continuer ?")) return;
      state.collectiveGoals = state.collectiveGoals.slice(0,n);
    }
    syncAchievementsFromGoals(); save(); renderSuccess();
  };

  document.querySelectorAll("[data-goal]").forEach(inp=>{
    inp.onchange = ()=>{
      const id = inp.getAttribute("data-goal");
      const goal = state.collectiveGoals.find(x=>x.id===id);
      if(!goal) return;
      const was = !!goal.done;
      goal.done = !!inp.checked;

      if(!was && goal.done){
        state.boss.hp = Math.max(0, Number(state.boss.hp||0) - 10);
      }else if(was && !goal.done){
        state.boss.hp = Math.min(Number(state.boss.maxHp||100), Number(state.boss.hp||0) + 10);
      }
      if(Number(state.boss.hp)<=0){
        state.boss.hp = 0;
        state.boss.victoryStamp = state.boss.victoryStamp || new Date().toISOString();
        if(typeof triggerFinalEvent==="function"){ try{ triggerFinalEvent(); }catch(e){} }
      }
      syncAchievementsFromGoals(); save(); renderSuccess();
    };
  });

  document.querySelectorAll("[data-edit]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute("data-edit");
      const g = state.collectiveGoals.find(x=>x.id===id);
      if(!g) return;
      const t = prompt("Titre de l‚Äôobjectif :", g.title||"");
      if(t===null) return;
      g.title = String(t).trim() || g.title;
      syncAchievementsFromGoals(); save(); renderSuccess();
    };
  });

  document.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute("data-del");
      if(!confirm("Supprimer cet objectif ?")) return;
      state.collectiveGoals = state.collectiveGoals.filter(x=>x.id!==id);
      syncAchievementsFromGoals(); save(); renderSuccess();
    };
  });
}

function render(view){
  updatePills();
  if(view==="map") return renderMap();
  if(view==="roster") return renderRoster();
  if(view==="quests") return renderQuests();
  if(view==="battle") return renderBattle();
  if(view==="gm") return renderGM();
  if(view==="success") return renderSuccess();
}

// ---------- Views ----------
function renderMap(){
  const zone = zones.find(z=>z.id===state.zoneId);
  viewEl.innerHTML =
    '<h2 class="sectionTitle">üó∫Ô∏è Carte d‚ÄôOrth√©sia</h2>'
    + '<p class="muted">Clique sur une zone pour voyager (cin√©matique + whoosh + zoom cam√©ra).</p>'
    + '<div class="map" id="map"><div class="mapCam" id="mapCam"></div></div>'
    + '<div class="hr"></div>'
    + '<div class="row">'
    + '  <button class="btn primary" id="grantXpBtn">+ Donner de l‚ÄôXP (effort collectif)</button>'
    + '  <button class="btn" id="healBtn">Soigner l‚Äô√©quipe (repos)</button>'
    + '</div>'
    + '<p class="mini"><b>Zone actuelle :</b> ' + (zone ? zone.name : "‚Äî") + ' ‚Äî ' + (zone ? zone.desc : "") + '</p>';

  const mapCam = document.getElementById("mapCam");
  zones.forEach(z=>{
    const div = document.createElement("div");
    div.className = "node" + (z.id===state.zoneId ? " selected" : "");
    div.style.left = z.x + "%";
    div.style.top  = z.y + "%";
    div.style.animationDelay = (Math.random()*0.12).toFixed(2) + "s";
    div.innerHTML =
      '<h3>'+z.name+'</h3>'
      + '<small>'+z.desc+'</small><br/>'
      + '<span class="badge">'+(z.id===state.zoneId ? "Vous √™tes ici" : "Voyager")+'</span>';

    div.addEventListener("click", function(){
      if(state.zoneId === z.id) return;
      playWhoosh();
      state.zoneId = z.id;
      save();
      showCinematic(z);
      cameraMoveTo(z);
      render("map");
    });
    mapCam.appendChild(div);
  });

  document.getElementById("grantXpBtn").addEventListener("click", function(){
    const n = Number(prompt("Combien d‚ÄôXP donner √† CHAQUE √©l√®ve ? (1 √† 5)", "2"));
    if(!isFinite(n) || n<=0) return;
    const add = Math.min(5, Math.max(1, n));
    state.party.forEach(p=>p.xp = (Number(p.xp)||0) + add);
    save();
    render("map");
  });

  document.getElementById("healBtn").addEventListener("click", function(){
    state.party.forEach(p=>p.hp = Math.min(p.hpMax, (Number(p.hp)||0) + 6));
    save();
    render("map");
  });
}

function renderRoster(){
  viewEl.innerHTML =
    '<h2 class="sectionTitle">üë• √âquipe de h√©ros</h2>'
    + '<p class="muted">Tu peux donner +1 / +2 XP individuellement et soigner (+5 √©nergie).</p>'
    + '<div class="list" id="list"></div>';

  const list = document.getElementById("list");
  state.party.forEach(p=>{
    const lvl = levelFromXP(p.xp);
    const next = xpToNext(lvl+1);
    const prev = xpToNext(lvl);
    const span = Math.max(1, next - prev);
    const prog = Math.min(100, Math.round(((p.xp - prev)/span)*100));

    const avatarHTML = p.portrait
      ? '<div class="avatarBox"><img src="'+p.portrait+'" alt="'+p.name+'" onerror="this.parentNode.innerHTML=\'<span class=&quot;avatarFallback&quot;>'+p.icon+'</span>\'"></div>'
      : '<div class="avatarBox"><span class="avatarFallback">'+p.icon+'</span></div>';

    const div = document.createElement("div");
    div.className = "char";
    div.innerHTML =
      '<div class="charTop">'
      + ' <div style="display:flex;gap:10px;align-items:center">'
      +    avatarHTML
      + '   <div>'
      + '     <h4>'+p.name+'</h4>'
      + '     <div class="tag">'+p.cls+' ‚Ä¢ Qualit√© : '+p.trait+'</div>'
      + '   </div>'
      + ' </div>'
      + ' <div class="tag">Niv. '+lvl+'</div>'
      + '</div>'
      + '<div class="bar barXp"><div style="width:'+prog+'%"></div></div>'
      + '<div class="stats">'
      + ' <span>XP : <b>'+p.xp+'</b></span>'
      + ' <span>Prochain niv. : <b>'+(next===999 ? "‚Äî" : next)+'</b></span>'
      + '</div>'
      + '<div class="mini"><b>'+p.quest+'</b></div>'
      + '<div class="choiceRow">'
      + ' <button class="btn" data-act="xp1">+1 XP</button>'
      + ' <button class="btn" data-act="xp2">+2 XP</button>'
      + ' <button class="btn" data-act="heal">+5 √©nergie</button>'
      + '</div>';

    // üßô Afficher le r√¥le actif sous "Qualit√©"
    const ar = (state.rolesActive||[]).find(r=>r.studentId===p.id);
    if(ar){
      const roleTag = document.createElement("div");
      roleTag.className = "tag";
      roleTag.style.marginTop = "6px";
      roleTag.innerHTML = 'üßô R√¥le : <b>'+(ar.roleLabel||ar.roleId)+'</b> (jusqu‚Äôau '+frDate(ar.endAt)+')';

      const flex = div.querySelector(".charTop > div");
      const nameBox = flex ? flex.querySelector("div:last-child") : null; // bloc (h4 + Qualit√©)
      const qTag = nameBox ? nameBox.querySelector(".tag") : null;
      if(qTag) qTag.insertAdjacentElement('afterend', roleTag);
    }

    const btns = div.querySelectorAll("button[data-act]");
    btns.forEach(btn=>btn.addEventListener("click", ()=>{
      const act = btn.getAttribute("data-act");
      if(act==="xp1") p.xp += 1;
      if(act==="xp2") p.xp += 2;
      if(act==="heal") p.hp = Math.min(p.hpMax, p.hp + 5);
      save();
      render("roster");
    }));
    list.appendChild(div);
  });
}

function renderQuests(){
  viewEl.innerHTML =
    '<h2 class="sectionTitle">üìú Qu√™tes</h2>'
    + '<p class="muted">Coche une qu√™te quand la classe la r√©ussit. R√©compense : XP pour tous.</p>'
    + '<div id="qwrap"></div>'
    + '<div class="hr"></div>'
    + '<div class="row">'
    + ' <button class="btn primary" id="addQuestBtn">+ Ajouter une qu√™te</button>'
    + ' <button class="btn" id="rewardDoneBtn">Donner r√©compense des qu√™tes faites</button>'
    + '</div>';

  const qwrap = document.getElementById("qwrap");
  state.quests.forEach(q=>{
    const div = document.createElement("div");
    div.className = "char";
    div.innerHTML =
      '<div class="charTop">'
      + ' <div>'
      + '  <h4>'+q.title+'</h4>'
      + '  <div class="tag">'+q.desc+'</div>'
      + ' </div>'
      + ' <div class="tag">R√©compense : '+q.reward+' XP</div>'
      + '</div>'
      + '<div class="choiceRow">'
      + ' <button class="btn '+(q.done ? "primary": "")+'" data-t="toggle">'+(q.done ? "‚úÖ Accomplie" : "‚òê √Ä faire")+'</button>'
      + ' <button class="btn danger" data-t="del">Supprimer</button>'
      + '</div>';

    div.querySelector('[data-t="toggle"]').addEventListener("click", ()=>{ q.done = !q.done; save(); render("quests"); });
    div.querySelector('[data-t="del"]').addEventListener("click", ()=>{
      if(confirm("Supprimer cette qu√™te ?")){
        state.quests = state.quests.filter(x=>x.id !== q.id);
        save();
        render("quests");
      }
    });
    qwrap.appendChild(div);
  });

  document.getElementById("addQuestBtn").addEventListener("click", function(){
    const title = prompt("Titre de la qu√™te ?", "La Plume du Courage");
    if(!title) return;
    const desc = prompt("Description courte ?", "√âcrire un paragraphe structur√© et le relire.");
    const reward = Number(prompt("R√©compense XP (1 √† 10) ?", "6"));
    const r = Math.max(1, Math.min(10, isFinite(reward) ? reward : 6));
    state.quests.push({ id:"q"+Date.now(), title, desc: desc||"", reward:r, done:false });
    save();
    render("quests");
  });

  document.getElementById("rewardDoneBtn").addEventListener("click", function(){
    const done = state.quests.filter(q=>q.done);
    if(done.length===0) return alert("Aucune qu√™te accomplie pour l‚Äôinstant.");
    const total = done.reduce((a,q)=>a+(Number(q.reward)||0),0);
    state.party.forEach(p=>p.xp += total);
    alert("R√©compense donn√©e : "+total+" XP √† chaque √©l√®ve.");
    save();
    render("quests");
  });
}

// ---------- Battle ----------
function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

function startNewBattle(){
  const enemy = deepCopy(enemies[Math.floor(Math.random()*enemies.length)]);
  state.battle = {
    enemy,
    enemyHp: enemy.hp,
    turnIndex: 0,
    shield: 0,
    log: [
      "<b>Un obstacle appara√Æt :</b> " + enemy.name + ".",
      "Votre classe respire‚Ä¶ et se pr√©pare."
    ]
  };
}

function playTurn(actionId){
  const b = state.battle;
  const leader = state.party[b.turnIndex % state.party.length];
  let action = actions[0];
  for(let i=0;i<actions.length;i++) if(actions[i].id === actionId) action = actions[i];

  const dmg = rand(action.dmg[0], action.dmg[1]);
  b.enemyHp = Math.max(0, b.enemyHp - dmg);

  if(action.shield) b.shield = Math.min(6, b.shield + action.shield);

  const heal = rand(action.heal[0], action.heal[1]);
  if(heal > 0){
    for(let i=0;i<heal;i++) {
      let target = state.party[0];
      for(let j=1;j<state.party.length;j++) if(state.party[j].hp < target.hp) target = state.party[j];
      target.hp = Math.min(target.hpMax, target.hp + 1);
    }
  }

  b.log.push("<b>"+leader.name+"</b> utilise <b>"+action.label+"</b> : -"+dmg+" √©nergie √† "+b.enemy.name+(heal>0 ? ", +"+heal+" √©nergie √† l‚Äô√©quipe" : "")+".");

  if(b.enemyHp <= 0){
    const reward = 4;
    state.party.forEach(p=>{ p.xp += reward; p.hp = Math.min(p.hpMax, p.hp + 3); });
    b.log.push("<b>Victoire !</b> R√©compense : <b>"+reward+" XP</b> pour chaque h√©ros.");
    state.battle = null;
    return;
  }

  const target = state.party[Math.floor(Math.random()*state.party.length)];
  const mitigated = Math.max(1, (Number(b.enemy.atk)||1) - b.shield);
  target.hp = Math.max(0, target.hp - mitigated);
  b.log.push(b.enemy.name + " riposte : <b>" + target.name + "</b> perd " + mitigated + " √©nergie.");

  b.shield = Math.max(0, b.shield - 1);
  if(target.hp === 0){ target.hp = 6; b.log.push("<b>"+target.name+"</b> reprend son souffle (retour √† 6 √©nergie). Ici, on repart."); }

  b.turnIndex += 1;
  if(b.log.length > 70) b.log = b.log.slice(b.log.length - 70);
}

function renderBattle(){
  if(!state.battle) startNewBattle();
  const b = state.battle;

  viewEl.innerHTML =
    '<h2 class="sectionTitle">‚öîÔ∏è Combat symbolique</h2>'
    + '<p class="muted">On ‚Äúcombat‚Äù des obstacles : doute, dispersion, peur. Les actions restent positives.</p>'
    + '<div class="battleGrid">'
    + ' <div class="char">'
    + '  <h4>üëë √âquipe</h4>'
    + '  <div class="tag">Chef du tour : <b id="leaderName"></b></div>'
    + '  <div class="hr"></div>'
    + '  <div class="tag">Action du tour :</div>'
    + '  <select class="select" id="actionSel"></select>'
    + '  <div class="choiceRow">'
    + '   <button class="btn primary" id="actBtn">Jouer le tour</button>'
    + '   <button class="btn" id="newBattleBtn">Nouveau combat</button>'
    + '  </div>'
    + ' </div>'
    + ' <div class="char">'
    + '  <h4>üëæ Ennemi : '+b.enemy.name+'</h4>'
    + '  <div class="tag">'+b.enemy.msg+'</div>'
    + '  <div class="hr"></div>'
    + '  <h4>üì£ Journal</h4>'
    + '  <div class="log" id="log"></div>'
    + ' </div>'
    + '</div>';

  const leader = state.party[b.turnIndex % state.party.length];
  document.getElementById("leaderName").textContent = leader.name;

  const sel = document.getElementById("actionSel");
  actions.forEach(a=>{
    const opt = document.createElement("option");
    opt.value = a.id;
    opt.textContent = a.label + " ‚Äî " + a.desc;
    sel.appendChild(opt);
  });

  const log = document.getElementById("log");
  b.log.forEach(line=>{ const d=document.createElement("div"); d.innerHTML=line; log.appendChild(d); });
  log.scrollTop = log.scrollHeight;

  document.getElementById("actBtn").addEventListener("click", function(){
    playTurn(sel.value);
    save();
    render("battle");
  });

  document.getElementById("newBattleBtn").addEventListener("click", function(){
    startNewBattle();
    save();
    render("battle");
  });
}

// ---------- GM ----------
function renderGM(){
  const hpPct = Math.max(0, Math.min(100, Math.round((state.boss.hp/state.boss.hpMax)*100)));
  viewEl.innerHTML =
    '<h2 class="sectionTitle">üéÆ Ma√Ætre du jeu</h2>'
    + '<div class="char">'
    + ' <h4>üëπ Boss collectif</h4>'
    + ' <div class="tag"><b>'+state.boss.name+'</b></div>'
    + ' <div class="bar" style="margin-top:10px"><div style="width:'+hpPct+'%; background: linear-gradient(90deg, rgba(157,255,176,.95), rgba(255,231,136,.85), rgba(255,139,161,.9))"></div></div>'
    + ' <div class="mini">PV : <b>'+state.boss.hp+'</b> / '+state.boss.hpMax+'</div>'
    + ' <div class="choiceRow">'
    + '   <button class="btn" id="boss5">-5 PV</button>'
    + '   <button class="btn" id="boss10">-10 PV</button>'
    + '   <button class="btn danger" id="bossReset">Reset</button>'
    + ' </div>'
    + '</div>'
    + '<div class="hr"></div>'
    + '<h3 style="margin:0 0 8px;font-size:14px">üèÖ Succ√®s collectifs</h3>'
    + renderAchievementsGM()
    + '<div class="hr"></div>'
    + '<h3 style="margin:0 0 8px;font-size:14px">üßô R√¥les</h3>'
    + renderRolesGM()
    + '<div class="hr"></div>'
    + '<h3 style="margin:0 0 8px;font-size:14px">üèÜ Progression par p√©riode</h3>'
    + renderPeriodsGM();

  document.getElementById("boss5").onclick = ()=>bossDamage(5);
  document.getElementById("boss10").onclick = ()=>bossDamage(10);
  document.getElementById("bossReset").onclick = ()=>bossReset();


  // R√¥les : remplir listes + bind
  const stSel = document.getElementById("roleStudentSel");
  const rtSel = document.getElementById("roleTypeSel");
  if(stSel && rtSel){
    stSel.innerHTML = "";
    (state.party||[]).forEach(p=>{
      const o=document.createElement("option");
      o.value = p.id;
      o.textContent = p.name;
      stSel.appendChild(o);
    });
    rtSel.innerHTML = "";
    ROLE_TYPES.forEach(r=>{
      const o=document.createElement("option");
      o.value = r.id;
      o.textContent = r.label + " ‚Äî " + r.desc;
      rtSel.appendChild(o);
    });
    const btn = document.getElementById("assignRoleBtn");
    if(btn){
      btn.onclick = ()=>{
        assignRole(stSel.value, rtSel.value);
        render("gm");
      };
      btn.disabled = !canAssignMoreRoles();
      btn.title = btn.disabled ? "Max r√¥les actifs atteint" : "";
    }
  }

  // D√©l√©gation des clics (Retirer / Cl√¥turer)
  if(!window.__roleActionsBound){
    window.__roleActionsBound = true; // roleActionsBound
    document.addEventListener("click", (e)=>{
      const b = e.target.closest("[data-role-action]");
      if(!b) return;
      const act = b.getAttribute("data-role-action");
      const id = b.getAttribute("data-role-id");
      if(!id) return;
      if(act==="remove"){ removeRole(id); render("gm"); }
      if(act==="close"){ closeRole(id); render("gm"); }
    }, { capture:true });
  }

}

function bossDamage(n){
  state.boss.hp = Math.max(0, state.boss.hp - n);
  state.boss.log = state.boss.log || [];
  state.boss.log.push("Le boss perd "+n+" PV.");
  save();
  if(state.boss.hp === 0) triggerFinalEvent();
  render("gm");
}

function bossReset(){
  if(!confirm("R√©initialiser le boss ?")) return;
  state.boss.hp = state.boss.hpMax;
  state.boss.log = ["Le boss revient plus fort‚Ä¶"];
  state.meta.finalShown = false;
  save();
  render("gm");
}

function renderAchievementsGM(){
  let html = '<div>';
  for(let i=0;i<state.achievements.length;i++) {
    const a = state.achievements[i];
    html += '<div class="char" style="margin-bottom:10px">'
      + '<div class="charTop">'
      + ' <div><h4>'+a.title+'</h4><div class="tag">'+a.desc+'</div></div>'
      + ' <div class="tag">'+(a.unlocked ? '‚úÖ D√©bloqu√©' : '‚òê √Ä d√©bloquer')+'</div>'
      + '</div>'
      + '<div class="choiceRow">'
      + (a.unlocked
          ? '<button class="btn danger" onclick="toggleAchievement('+i+',false)">Annuler</button>'
          : '<button class="btn primary" onclick="toggleAchievement('+i+',true)">D√©bloquer</button>')
      + '</div>'
      + (a.unlocked && a.date ? '<div class="mini">D√©bloqu√© le : <b>'+a.date+'</b></div>' : '')
      + '</div>';
  }
  html += '</div>';
  return html;
}

function toggleAchievement(i, val){
  const a = state.achievements[i];
  a.unlocked = val;
  a.date = val ? nowFr() : "";
  save();
  render("gm");
}

function renderPeriodsGM(){
  let html = "";
  for(let i=0;i<state.periods.length;i++) {
    const p = state.periods[i];
    html += '<div class="char" style="margin-bottom:10px">'
      + '<div><b>'+p.label+'</b> <span class="tag">('+p.dateRange+')</span></div>'
      + '<div class="mini">XP √©quipe : <input type="number" value="'+p.teamXp+'" onchange="updatePeriod('+i+',this.value,\'teamXp\')"></div>'
      + '<div class="mini">Qu√™tes : <input type="number" value="'+p.questsDone+'" onchange="updatePeriod('+i+',this.value,\'questsDone\')"></div>'
      + '<div class="mini">Notes :</div>'
      + '<textarea class="select" style="min-height:90px" onchange="updatePeriod('+i+',this.value,\'notes\')">'+(p.notes||"")+'</textarea>'
      + '</div>';
  }
  return html;
}

function updatePeriod(i,val,key){
  if(key==="notes") state.periods[i][key] = val;
  else state.periods[i][key] = Number(val)||0;
  save();
}

// ---------- Start ----------
updatePills();
setView("map");
save();
</script>

<div class="victoryOverlay" id="victoryOverlay">
  <div class="victoryCard">
    <div id="confettiWrap"></div>
    <h3 id="victoryTitle">üéâ Boss vaincu !</h3>
    <p id="victoryMsg">Bravo ! La classe a vaincu le boss collectif.</p>
    <div class="row" style="margin-top:12px;justify-content:flex-end">
      <button class="btn primary" id="victoryClose">Continuer</button>
    </div>
  </div>
</div>

</body>
</html>
