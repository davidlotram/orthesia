<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Orth√©sia ‚Äî G√©n√©rateur √©l√®ves (avec üèÜ Progr√®s)</title>
<style>
  :root{--bg:#0b1020;--text:#f5f5f5;--muted:#c9c9c9;--line:rgba(255,255,255,.12);--accent:rgba(139,211,255,.18);}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:radial-gradient(1200px 700px at 20% 10%, #18214a 0%, var(--bg) 55%),
               radial-gradient(900px 600px at 90% 30%, #1a3b3b 0%, rgba(0,0,0,0) 60%);
    color:var(--text)}
  header{padding:18px;border-bottom:1px solid var(--line);background:rgba(18,26,51,.55);backdrop-filter:blur(8px);position:sticky;top:0;z-index:10}
  h1{margin:0;font-size:16px}
  small{color:var(--muted);display:block;margin-top:4px;line-height:1.35}
  main{max-width:1120px;margin:0 auto;padding:18px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
  .card{border:1px solid var(--line);background:rgba(18,26,51,.55);border-radius:16px;padding:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
  .muted{color:var(--muted);font-size:13px;line-height:1.35}
  textarea{width:100%;min-height:360px;resize:vertical;padding:12px;border-radius:12px;border:1px solid var(--line);
    background:rgba(0,0,0,.35);color:#fff;caret-color:#fff;-webkit-text-fill-color:#fff;
    font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;font-size:12px;line-height:1.35;white-space:pre}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  button{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.06);color:#fff;cursor:pointer}
  button.primary{background:var(--accent);border-color:rgba(139,211,255,.35)}
  .status{margin-top:10px;font-size:12px;min-height:18px;color:var(--muted)}
  .ok{color:#9dffb0}.bad{color:#ff8ba1}
  code{background:rgba(255,255,255,.06);padding:2px 6px;border-radius:8px;border:1px solid var(--line)}
  .checks{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
  label{font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center;user-select:none}
  input[type="checkbox"]{transform:scale(1.1)}
</style>
</head>
<body>
<header>
  <h1>Orth√©sia ‚Äî G√©n√©rateur ‚Äú√©l√®ves‚Äù (consultation) + üèÜ Progr√®s</h1>
  <small>
    1) Copie l‚Äôexport JSON depuis la version prof.<br>
    2) Colle ici ‚Üí <b>G√©n√©rer & T√©l√©charger</b> ‚Üí tu obtiens <code>orthesia_&lt;classe&gt;_view.html</code> (selon l‚Äôexport). (Carte / √âquipe / Qu√™tes / üèÜ Progr√®s).
  </small>
</header>

<main class="grid">
  <section class="card">
    <h2 style="margin:0 0 8px;font-size:14px">1) Colle l‚Äôexport JSON (prof)</h2>
    <p class="muted">M√™me si tu copies avec du texte avant, on r√©cup√®re automatiquement √† partir du premier <b>{</b>.</p>
    <textarea id="jsonIn" placeholder="Colle ici le JSON complet (export prof)"></textarea>

    <div class="checks">
      <label><input id="wmOn" type="checkbox" checked> Filigrane ‚ÄúVersion consultation‚Äù</label>
      <label><input id="stampOn" type="checkbox" checked> Afficher ‚ÄúMise √† jour du ‚Ä¶‚Äù</label>
    </div>

    <div class="row">
      <button class="primary" id="btnGo">G√©n√©rer & T√©l√©charger</button>
      <button id="btnPreview">Aper√ßu HTML</button>
      <button id="btnClear">Vider</button>
    </div>
    <div class="status" id="status"></div>

    <p class="muted" style="margin-top:10px">
      üì¶ Mets le fichier g√©n√©r√© dans le dossier √©l√®ves, au m√™me niveau que les images <code>.png</code>.<br>
      ‚úÖ Nom conseill√© : <code>orthesia_&lt;classe&gt;_view.html</code> (renomme si ton navigateur ajoute <code>(1)</code>).
    </p>
  </section>

  <section class="card">
    <h2 style="margin:0 0 8px;font-size:14px">2) Aper√ßu HTML (optionnel)</h2>
    <p class="muted">Utile pour v√©rifier le contenu avant de le d√©poser sur l‚ÄôENT/Drive.</p>
    <textarea id="htmlOut" readonly placeholder="Ici l‚ÄôHTML g√©n√©r√© (option)"></textarea>
  </section>
</main>

<script>
"use strict";


function escapeHtml(str){
  if(typeof str!=="string") return "";
  return str
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}


/* =========================
   CONFIG
   ========================= */
const OUTPUT_FILENAME = null; // auto depuis export
const DEFAULT_TITLE = "Le Royaume d‚ÄôOrth√©sia ‚Äî 5e Proust";
const DEFAULT_SUBTITLE = "Version consultation (lecture seule) ‚Äî aucune modification possible ici.";
const FOOTER_TEXT = "Page de consultation. Les mises √† jour sont publi√©es par le professeur.";
const DEFAULT_WATERMARK = "Orth√©sia ‚Äî 5e Proust ‚Äî Consultation";

const ZONES = [
  { id:"plaine", name:"Plaine de la Compr√©hension", desc:"Lire, comprendre, rep√©rer l'essentiel.", x: 8,  y: 15 },
  { id:"foret",  name:"For√™t de l‚Äô√âcriture",        desc:"√âcrire, structurer, am√©liorer.",        x: 40, y: 44 },
  { id:"cite",   name:"Cit√© de l‚ÄôOral",             desc:"Prendre la parole avec confiance.",     x: 74, y: 14 },
  { id:"mont",   name:"Montagne de la M√©thode",     desc:"S'organiser, relire, progresser.",      x: 18, y: 64 },
  { id:"sanct",  name:"Sanctuaire de la Confiance", desc:"Oser, pers√©v√©rer, grandir.",            x: 74, y: 64 }
];

/* =========================
   UI
   ========================= */
const jsonIn = document.getElementById("jsonIn");
const htmlOut = document.getElementById("htmlOut");
const statusEl = document.getElementById("status");
const wmOn = document.getElementById("wmOn");
const stampOn = document.getElementById("stampOn");

function setStatus(msg, ok){
  statusEl.textContent = msg || "";
  statusEl.className = "status " + (ok ? "ok" : "bad");
}

function cleanInput(raw){
  raw = String(raw || "").trim();
  const idx = raw.indexOf("{");
  return idx >= 0 ? raw.slice(idx) : raw;
}

function parseJSON(){
  const cleaned = cleanInput(jsonIn.value);
  let obj;
  try { obj = JSON.parse(cleaned); }
  catch(e){ throw new Error("JSON invalide : colle bien du { jusqu‚Äôau }."); }
  if(!obj || typeof obj !== "object" || !Array.isArray(obj.party)){
    throw new Error("Export Orth√©sia invalide : champ 'party' manquant.");
  }
  if(!Array.isArray(obj.quests)) obj.quests = [];
  if(typeof obj.classSlug !== "string") obj.classSlug = "";
  if(typeof obj.className !== "string") obj.className = "";
  if(!Array.isArray(obj.announcements)) obj.announcements = [];
  if(typeof obj.zoneId !== "string") obj.zoneId = (ZONES[0] ? ZONES[0].id : "");
  // üî• Garantit la pr√©sence des blocs Progr√®s (m√™me vides)
  if(!obj.boss || typeof obj.boss !== "object") obj.boss = null;
  if(!Array.isArray(obj.achievements)) obj.achievements = [];
  if(!Array.isArray(obj.periods)) obj.periods = [];
  if(!Array.isArray(obj.rolesActive)) obj.rolesActive = [];
  if(!Array.isArray(obj.rolesHistory)) obj.rolesHistory = [];
  return obj;
}

function nowFrString(){
  const d = new Date();
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yyyy = d.getFullYear();
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  return dd + "/" + mm + "/" + yyyy + " √† " + hh + ":" + mi;
}

function download(filename, text){
  const blob = new Blob([text], {type:"text/html;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1500);
}

/* S√©curise l'injection JSON dans un script-tag */
function safeJsonForScriptTag(obj){
  return JSON.stringify(obj)
    .replace(/</g, "\\u003c")
    .replace(/\u2028/g, "\\u2028")
    .replace(/\u2029/g, "\\u2029");
}

/* =========================
   BUILD VIEW (√âL√àVES)
   ========================= */
function buildStudentHTML(stateObj, opts){
  const meta = {
    title: (stateObj.className ? (DEFAULT_TITLE + " ‚Äî " + stateObj.className) : DEFAULT_TITLE),
    subtitle: DEFAULT_SUBTITLE,
    footer: FOOTER_TEXT,
    watermark: (stateObj.className ? ("Orth√©sia ‚Äî " + stateObj.className + " ‚Äî Consultation") : DEFAULT_WATERMARK),
    watermarkOn: !!opts.watermarkOn,
    stampOn: !!opts.stampOn,
    updatedAt: nowFrString()
  };

  const metaJson  = safeJsonForScriptTag(meta);
  const stateJson = safeJsonForScriptTag(stateObj);
  const zonesJson = safeJsonForScriptTag(ZONES);

  const closeScript = "<" + "/script>";

  return `<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Orth√©sia ‚Äî Consultation</title>
<style>
:root{--bg:#0b1020;--text:#f5f5f5;--muted:#c9c9c9;--line:rgba(255,255,255,.12);--accent:rgba(139,211,255,.16);}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:radial-gradient(1200px 700px at 20% 10%, #18214a 0%, var(--bg) 55%),
             radial-gradient(900px 600px at 90% 30%, #1a3b3b 0%, rgba(0,0,0,0) 60%);
  color:var(--text)}
body.wm::before{content:attr(data-wm);position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
  font-size:clamp(18px,3.2vw,40px);letter-spacing:.6px;color:rgba(255,255,255,.07);transform:rotate(-18deg);
  pointer-events:none;z-index:0;white-space:nowrap;user-select:none}
header{padding:18px;border-bottom:1px solid var(--line);background:rgba(18,26,51,.55);backdrop-filter:blur(8px);
  position:sticky;top:0;z-index:10;display:flex;gap:10px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
.title h1{margin:0;font-size:16px}
.title small{color:var(--muted);display:block;margin-top:2px}
.updated{margin-top:6px;color:var(--muted);font-size:12px}
.pillrow{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.pill{padding:6px 10px;border:1px solid var(--line);background:rgba(255,255,255,.06);border-radius:999px;font-size:12px}
main{max-width:1100px;margin:0 auto;padding:18px;position:relative;z-index:1}
.grid{display:grid;grid-template-columns:280px 1fr;gap:14px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{border:1px solid var(--line);background:rgba(18,26,51,.55);border-radius:16px;padding:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
.muted{color:var(--muted);font-size:13px;line-height:1.35}
.mini{color:var(--muted);font-size:12px;line-height:1.35}
.hr{height:1px;background:var(--line);margin:12px 0}
.nav button{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.06);
  color:var(--text);cursor:pointer;text-align:left;margin-bottom:8px}
.nav button.active{background:var(--accent);border-color:rgba(139,211,255,.35)}
.map{position:relative;border:1px solid var(--line);border-radius:16px;overflow:hidden;min-height:440px;background:rgba(0,0,0,.20)}
.mapCam{position:absolute;inset:0}
.node{position:absolute;width:min(160px,42vw);padding:8px 9px;border-radius:14px;border:1px solid var(--line);background:rgba(0,0,0,.22)}
.node h3{margin:0 0 3px;font-size:12px}
.node small{color:var(--muted);font-size:11px;line-height:1.15}
.badge{display:inline-block;margin-top:8px;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);background:rgba(255,255,255,.06)}
.node.selected{background:rgba(139,211,255,.18);border-color:rgba(139,211,255,.45)}
.list{display:grid;grid-template-columns:repeat(2,minmax(240px,1fr));gap:10px}
@media(max-width:900px){.list{grid-template-columns:1fr}}
.char{border:1px solid var(--line);border-radius:14px;padding:12px;background:rgba(0,0,0,.18)}
.charTop{display:flex;justify-content:space-between;gap:10px;align-items:center}
.tag{font-size:12px;color:var(--muted)}
.bar{height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;border:1px solid var(--line);margin-top:10px}
.bar>div{height:100%;width:0%}
.barXp>div{background:linear-gradient(90deg, rgba(139,211,255,.9), rgba(157,255,176,.9))}
.stats{margin-top:8px;display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px}
.avatarBox{width:44px;height:44px;border-radius:12px;overflow:hidden;border:1px solid var(--line);background:rgba(255,255,255,.06);
  display:flex;align-items:center;justify-content:center;flex:0 0 auto}
.avatarBox img{width:100%;height:100%;object-fit:cover}
.avatarFallback{font-size:22px}
footer{padding:14px 18px;color:var(--muted);font-size:12px;text-align:center;position:relative;z-index:1}
.hpWrap{border:1px solid rgba(255,255,255,.14);border-radius:14px;overflow:hidden;background:rgba(255,255,255,.06);height:14px}
.hpFill{height:100%;width:100%;transition:width .35s ease;background:linear-gradient(90deg, rgba(157,255,176,.95), rgba(139,211,255,.75))}
.hpLabel{font-size:12px;color:rgba(255,255,255,.78);margin:6px 0 10px}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table td,.table th{padding:8px 10px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18)}
.table th{color:rgba(255,255,255,.82);font-size:12px;text-align:left}
.pillOk{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:rgba(157,255,176,.15);font-size:12px}
.pillTodo{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:rgba(255,231,136,.12);font-size:12px}
</style>
</head>
<body>
<header>
  <div class="title">
    <h1 id="pageTitle"></h1>
    <small id="pageSubtitle"></small>
    <div class="updated" id="updatedAt" style="display:none"></div>
  </div>
  <div class="pillrow">
    <span class="pill" id="pillChapter">Zone : ‚Äî</span>
    <span class="pill" id="pillTeam">√âquipe : ‚Äî</span>
    <span class="pill" id="pillXP">XP total : ‚Äî</span>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card nav">
      <h2 style="margin:0 0 8px;font-size:14px">Menu</h2>
      <button class="active" data-view="map">üó∫Ô∏è Carte</button>
      <button data-view="roster">üë• √âquipe</button>
      <button data-view="quests">üìú Qu√™tes</button>
      <button data-view="progress">üèÜ Progr√®s</button>
      <div class="hr"></div>
      <p class="muted"><b>Lecture seule :</b> tu peux consulter les avanc√©es, rien modifier.</p>
    </section>

    <section class="card" id="view"></section>
  </div>
</main>

<footer id="footerText"></footer>

<script type="application/json" id="META">${metaJson}${closeScript}
<script type="application/json" id="STATE">${stateJson}${closeScript}
<script type="application/json" id="ZONES">${zonesJson}${closeScript}

<script>
"use strict";
function getJson(id){ try{ return JSON.parse(document.getElementById(id).textContent || "{}"); } catch(e){ return {}; } }
const meta = getJson("META");
const stateRaw = getJson("STATE");
const zones = getJson("ZONES");

if(meta.watermarkOn){ document.body.classList.add("wm"); document.body.dataset.wm = meta.watermark || ""; }
document.getElementById("pageTitle").textContent = meta.title || "";
document.getElementById("pageSubtitle").textContent = meta.subtitle || "";
const upd = document.getElementById("updatedAt");
if(meta.stampOn){ upd.style.display = "block"; upd.textContent = "Mise √† jour du " + (meta.updatedAt || ""); }
document.getElementById("footerText").textContent = meta.footer || "";

const state = (function(s){
  const safe = (s && typeof s==="object") ? s : {};
  safe.zoneId = (typeof safe.zoneId==="string") ? safe.zoneId : (zones[0] ? zones[0].id : "");
  safe.party = Array.isArray(safe.party) ? safe.party : [];
  safe.quests = Array.isArray(safe.quests) ? safe.quests : [];
  safe.boss = (safe.boss && typeof safe.boss==="object") ? safe.boss : null;
  safe.achievements = Array.isArray(safe.achievements) ? safe.achievements : [];
  safe.periods = Array.isArray(safe.periods) ? safe.periods : [];
  safe.rolesActive = Array.isArray(safe.rolesActive) ? safe.rolesActive : [];
  safe.announcements = Array.isArray(safe.announcements) ? safe.announcements : [];
  return safe;
})(stateRaw);

function levelFromXP(xp){ xp=Number(xp)||0; if(xp<10)return 1; if(xp<22)return 2; if(xp<38)return 3; if(xp<58)return 4; return 5; }
function xpToNext(level){ const t=[0,10,22,38,58,999]; return t[level]||999; }

function updatePills(){
  const zone = zones.find(z=>z.id===state.zoneId);
  const teamCount = state.party.length;
  const totalXP = state.party.reduce((a,p)=>a+(Number(p.xp)||0),0);
  document.getElementById("pillChapter").textContent = "Zone : " + (zone?zone.name:"‚Äî");
  document.getElementById("pillTeam").textContent = "√âquipe : " + teamCount + " h√©ros";
  document.getElementById("pillXP").textContent = "XP total : " + totalXP;
}

const viewEl = document.getElementById("view");
const navBtns = Array.from(document.querySelectorAll(".nav button[data-view]"));
function setView(v){
  navBtns.forEach(b=>b.classList.toggle("active", b.dataset.view===v));
  render(v);
}
navBtns.forEach(b=>b.addEventListener("click", (e)=>{ e.preventDefault(); setView(b.dataset.view); }));

function render(v){
  updatePills();
  if(v==="map") return renderMap();
  if(v==="roster") return renderRoster();
  if(v==="quests") return renderQuests();
  if(v==="progress") return renderProgress();
}

function renderMap(){
  viewEl.textContent = "";
  const zone = zones.find(z=>z.id===state.zoneId);

  const h=document.createElement("h2"); h.style.margin="0 0 8px"; h.style.fontSize="14px"; h.textContent="üó∫Ô∏è Carte (consultation)"; viewEl.appendChild(h);
  const p=document.createElement("p"); p.className="muted"; p.textContent="Zone actuelle mise √† jour par le professeur."; viewEl.appendChild(p);

  const map=document.createElement("div"); map.className="map";
  const cam=document.createElement("div"); cam.className="mapCam"; map.appendChild(cam);
  viewEl.appendChild(map);

  zones.forEach(z=>{
    const n=document.createElement("div");
    n.className="node" + (z.id===state.zoneId ? " selected" : "");
    n.style.left = z.x + "%";
    n.style.top  = z.y + "%";
    const t=document.createElement("h3"); t.textContent=z.name; n.appendChild(t);
    const s=document.createElement("small"); s.textContent=z.desc; n.appendChild(s);
    const spacer=document.createElement("div"); spacer.style.height="8px"; n.appendChild(spacer);
    const b=document.createElement("span"); b.className="badge"; b.textContent = (z.id===state.zoneId ? "Vous √™tes ici" : "Zone"); n.appendChild(b);
    cam.appendChild(n);
  });

  const hr=document.createElement("div"); hr.className="hr"; viewEl.appendChild(hr);
  const mini=document.createElement("p"); mini.className="mini";
  mini.textContent = "Zone actuelle : " + (zone?zone.name:"‚Äî") + " ‚Äî " + (zone?zone.desc:"");
  viewEl.appendChild(mini);
}

function renderRoster(){
  viewEl.textContent="";
  const h=document.createElement("h2"); h.style.margin="0 0 8px"; h.style.fontSize="14px"; h.textContent="üë• √âquipe (consultation)"; viewEl.appendChild(h);
  const p=document.createElement("p"); p.className="muted"; p.textContent="Progression visible. Aucun bouton d‚Äôaction ici."; viewEl.appendChild(p);

  const list=document.createElement("div"); list.className="list"; viewEl.appendChild(list);
  if(state.party.length===0){
    const d=document.createElement("div"); d.className="char";
    const hh=document.createElement("h3"); hh.style.margin="0"; hh.textContent="Aucune donn√©e"; d.appendChild(hh);
    const tg=document.createElement("div"); tg.className="tag"; tg.textContent="Le professeur n‚Äôa pas encore publi√©."; d.appendChild(tg);
    list.appendChild(d); return;
  }

  state.party.forEach(pers=>{
    const xp = Number(pers.xp)||0;
    const lvl = levelFromXP(xp);
    const next = xpToNext(lvl+1);
    const prev = xpToNext(lvl);
    const span = Math.max(1, next-prev);
    const prog = Math.min(100, Math.round(((xp-prev)/span)*100));

    const card=document.createElement("div"); card.className="char";
    const top=document.createElement("div"); top.className="charTop"; card.appendChild(top);

    const left=document.createElement("div");
    left.style.display="flex"; left.style.gap="10px"; left.style.alignItems="center";
    top.appendChild(left);

    const av=document.createElement("div"); av.className="avatarBox"; left.appendChild(av);
    const icon = (pers.icon || "‚ú®");
    if(pers.portrait){
      const img=new Image();
      img.src = pers.portrait;
      img.alt = pers.name || "";
      img.onerror = ()=>{ av.textContent = icon; av.classList.add("avatarFallback"); };
      av.appendChild(img);
    }else{
      av.textContent = icon;
      av.classList.add("avatarFallback");
    }

    const txt=document.createElement("div"); left.appendChild(txt);
    const nm=document.createElement("h3"); nm.style.margin="0"; nm.textContent=(pers.name||"‚Äî"); txt.appendChild(nm);
    const tg=document.createElement("div"); tg.className="tag"; tg.textContent=(pers.cls||"‚Äî")+" ‚Ä¢ Qualit√© : "+(pers.trait||"‚Äî");
    const role = (state.rolesActive||[]).find(r=>r.studentId && pers.id && r.studentId===pers.id);
    if(role){
      const rb=document.createElement("div");
      rb.className="tag";
      rb.style.marginTop="4px";
      rb.textContent = "üßô R√¥le : " + (role.roleLabel||role.roleId||"") + (role.endAt ? (" (jusqu‚Äôau " + String(role.endAt).slice(0,10) + ")") : "");
      txt.appendChild(rb);
    } txt.appendChild(tg);

    const right=document.createElement("div"); right.className="tag"; right.textContent="Niv. "+lvl; top.appendChild(right);

    const bar=document.createElement("div"); bar.className="bar barXp";
    const fill=document.createElement("div"); fill.style.width = prog + "%";
    bar.appendChild(fill); card.appendChild(bar);

    const stats=document.createElement("div"); stats.className="stats";
    stats.innerHTML = "<span>XP : <b>"+xp+"</b></span><span>Prochain niv. : <b>"+(next===999 ? "‚Äî" : next)+"</b></span>";
    card.appendChild(stats);

    if(pers.quest){
      const q=document.createElement("div"); q.className="mini";
      const b=document.createElement("b"); b.textContent = pers.quest;
      q.appendChild(b); card.appendChild(q);
    }
    list.appendChild(card);
  });
}

function renderQuests(){
  viewEl.textContent="";
  const h=document.createElement("h2"); h.style.margin="0 0 8px"; h.style.fontSize="14px"; h.textContent="üìú Qu√™tes (consultation)"; viewEl.appendChild(h);
  const p=document.createElement("p"); p.className="muted"; p.textContent="√âtat : √† faire / accomplie."; viewEl.appendChild(p);

  if(state.quests.length===0){
    const d=document.createElement("div"); d.className="char";
    const hh=document.createElement("h3"); hh.style.margin="0"; hh.textContent="Aucune qu√™te"; d.appendChild(hh);
    const tg=document.createElement("div"); tg.className="tag"; tg.textContent="Le professeur n‚Äôa pas encore publi√©."; d.appendChild(tg);
    viewEl.appendChild(d); return;
  }

  state.quests.forEach(q=>{
    const card=document.createElement("div"); card.className="char";
    const top=document.createElement("div"); top.className="charTop"; card.appendChild(top);

    const left=document.createElement("div"); top.appendChild(left);
    const t=document.createElement("h3"); t.style.margin="0"; t.textContent=(q.title||"Qu√™te"); left.appendChild(t);
    const d=document.createElement("div"); d.className="tag"; d.textContent=(q.desc||""); left.appendChild(d);

    const r=document.createElement("div"); r.className="tag";
    r.textContent = "R√©compense : " + (Number(q.reward)||0) + " XP";
    top.appendChild(r);

    const hr=document.createElement("div"); hr.className="hr"; card.appendChild(hr);
    const st=document.createElement("div"); st.className="tag"; st.textContent = (q.done ? "‚úÖ Accomplie" : "‚òê √Ä faire");
    card.appendChild(st);

    viewEl.appendChild(card);
  });
}

function renderProgress(){
  viewEl.textContent="";
  const h=document.createElement("h2"); h.style.margin="0 0 8px"; h.style.fontSize="14px"; h.textContent="üèÜ Progr√®s (consultation)"; viewEl.appendChild(h);
  const p=document.createElement("p"); p.className="muted"; p.textContent="Boss collectif, succ√®s et progression par p√©riode."; viewEl.appendChild(p);
  if(state.announcements && state.announcements.length){
    const last = state.announcements[state.announcements.length-1];
    const box=document.createElement("div"); box.className="char";
    const hA=document.createElement("h3"); hA.style.margin="0 0 6px"; hA.textContent="üì£ Message du professeur";
    box.appendChild(hA);
    const msg=document.createElement("div"); msg.className="tag"; msg.textContent = last.text || "";
    box.appendChild(msg);
    viewEl.appendChild(box);
    const hrA=document.createElement("div"); hrA.className="hr"; viewEl.appendChild(hrA);
  }


  
  const rh=document.createElement("h3"); rh.style.margin="14px 0 6px"; rh.textContent="üßô R√¥les en cours";
  viewEl.appendChild(rh);
  if((state.rolesActive||[]).length===0){
    const d=document.createElement("div"); d.className="char"; d.textContent="Aucun r√¥le actif publi√©."; viewEl.appendChild(d);
  } else {
    (state.rolesActive||[]).forEach(r=>{
      const item=document.createElement("div"); item.className="char";
      const top=document.createElement("div"); top.className="charTop"; item.appendChild(top);
      const left=document.createElement("div"); top.appendChild(left);
      const tt=document.createElement("h3"); tt.style.margin="0"; tt.textContent = (r.studentName||"√âl√®ve"); left.appendChild(tt);
      const dd=document.createElement("div"); dd.className="tag"; dd.textContent = (r.roleLabel||r.roleId||"R√¥le"); left.appendChild(dd);
      const right=document.createElement("div"); right.className="tag"; right.textContent = r.endAt ? ("jusqu‚Äôau " + String(r.endAt).slice(0,10)) : ""; top.appendChild(right);
      viewEl.appendChild(item);
    });
  }

// Boss
  if(state.boss){
    const hp = Number(state.boss.hp);
    const hpMax = Math.max(1, Number(state.boss.hpMax || state.boss.hp));
    const pct = Math.max(0, Math.min(100, Math.round((hp / hpMax) * 100)));

    const box=document.createElement("div"); box.className="char";
    const t=document.createElement("h3"); t.style.margin="0 0 6px"; t.textContent = "üëπ " + (state.boss.name || "Boss");
    box.appendChild(t);

    const wrap=document.createElement("div"); wrap.className="hpWrap";
    const fill=document.createElement("div"); fill.className="hpFill"; fill.style.width = pct + "%";
    wrap.appendChild(fill); box.appendChild(wrap);

    const lab=document.createElement("div"); lab.className="hpLabel";
    lab.textContent = "PV : " + (state.boss.hp ?? "‚Äî") + " / " + (state.boss.hpMax ?? "‚Äî") + " (" + pct + "%)";
    box.appendChild(lab);

    viewEl.appendChild(box);
  } else {
    const d=document.createElement("div"); d.className="char"; d.textContent="Boss : non publi√©."; viewEl.appendChild(d);
  }

  const hr1=document.createElement("div"); hr1.className="hr"; viewEl.appendChild(hr1);

  // Succ√®s
  const ah=document.createElement("h3"); ah.style.margin="0 0 6px"; ah.textContent="üèÖ Succ√®s collectifs";
  const succList = (Array.isArray(state.collectiveGoals) && state.collectiveGoals.length)
    ? state.collectiveGoals.map(g=>({title:g.title||"Objectif", desc:g.desc||"", done:!!g.done}))
    : (Array.isArray(state.achievements)? state.achievements : []);
  viewEl.appendChild(ah);

  if(succList.length===0){
    const d=document.createElement("div"); d.className="char"; d.textContent="Aucun succ√®s publi√©."; viewEl.appendChild(d);
  } else {
    succList.forEach(a=>{
      const item=document.createElement("div"); item.className="char";
      const top=document.createElement("div"); top.className="charTop"; item.appendChild(top);

      const left=document.createElement("div"); top.appendChild(left);
      const tt=document.createElement("h3"); tt.style.margin="0"; tt.textContent = a.title || "Succ√®s"; left.appendChild(tt);
      const dd=document.createElement("div"); dd.className="tag"; dd.textContent = a.desc || ""; left.appendChild(dd);

      const badge=document.createElement("div"); badge.className="tag";
      badge.innerHTML = a.unlocked ? '<span class="pillOk">D√©bloqu√©</span>' : '<span class="pillTodo">√Ä d√©bloquer</span>';
      top.appendChild(badge);

      viewEl.appendChild(item);
    });
  }

  const hr2=document.createElement("div"); hr2.className="hr"; viewEl.appendChild(hr2);

  // P√©riodes
  const ph=document.createElement("h3"); ph.style.margin="0 0 6px"; ph.textContent="üìÖ P√©riodes";
  viewEl.appendChild(ph);

  if(state.periods.length===0){
    const d=document.createElement("div"); d.className="char"; d.textContent="Aucune p√©riode publi√©e."; viewEl.appendChild(d);
  } else {
    const table=document.createElement("table"); table.className="table";
    table.innerHTML = "<thead><tr><th>P√©riode</th><th>XP √©quipe</th><th>Qu√™tes</th><th>Note</th></tr></thead>";
    const tb=document.createElement("tbody");

    state.periods.forEach(pr=>{
      const tr=document.createElement("tr");
      const td1=document.createElement("td");
      td1.textContent = String(pr.label || pr.id || "‚Äî") + (pr.dateRange ? " (" + pr.dateRange + ")" : "");
      const td2=document.createElement("td"); td2.textContent = String(pr.teamXp ?? "‚Äî");
      const td3=document.createElement("td"); td3.textContent = String(pr.questsDone ?? "‚Äî");
      const td4=document.createElement("td"); td4.textContent = String(pr.notes ?? "");
      tr.append(td1, td2, td3, td4);
      tb.appendChild(tr);
    });

    table.appendChild(tb);
    viewEl.appendChild(table);
  }
}

setView("map");
<\/script>
</body>
</html>`;
}

/* =========================
   Buttons
   ========================= */
document.getElementById("btnGo").addEventListener("click", ()=>{
  try{
    const obj = parseJSON();
    const html = buildStudentHTML(obj, { watermarkOn: wmOn.checked, stampOn: stampOn.checked });
    const slug = (obj.classSlug||"").trim();
    const fname = slug ? `orthesia_${slug}_view.html` : "orthesia_view.html";
    download(fname, html);
    setStatus("‚úÖ G√©n√©r√© et t√©l√©charg√© : " + (slug ? `orthesia_${slug}_view.html` : "orthesia_view.html"), true);
  }catch(err){
    setStatus("‚ùå " + err.message, false);
  }
});

document.getElementById("btnPreview").addEventListener("click", ()=>{
  try{
    const obj = parseJSON();
    const html = buildStudentHTML(obj, { watermarkOn: wmOn.checked, stampOn: stampOn.checked });
    htmlOut.value = html;
    setStatus("‚úÖ Aper√ßu rempli (" + html.length + " caract√®res).", true);
  }catch(err){
    setStatus("‚ùå " + err.message, false);
  }
});

document.getElementById("btnClear").addEventListener("click", ()=>{
  jsonIn.value = "";
  htmlOut.value = "";
  setStatus("", true);
});
</script>
</body>
</html>
